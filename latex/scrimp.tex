%% Generated by Sphinx.
\def\sphinxdocclass{report}
\documentclass[letterpaper,10pt,english]{sphinxmanual}
\ifdefined\pdfpxdimen
   \let\sphinxpxdimen\pdfpxdimen\else\newdimen\sphinxpxdimen
\fi \sphinxpxdimen=.75bp\relax
\ifdefined\pdfimageresolution
    \pdfimageresolution= \numexpr \dimexpr1in\relax/\sphinxpxdimen\relax
\fi
%% let collapsible pdf bookmarks panel have high depth per default
\PassOptionsToPackage{bookmarksdepth=5}{hyperref}

\PassOptionsToPackage{booktabs}{sphinx}
\PassOptionsToPackage{colorrows}{sphinx}

\PassOptionsToPackage{warn}{textcomp}
\usepackage[utf8]{inputenc}
\ifdefined\DeclareUnicodeCharacter
% support both utf8 and utf8x syntaxes
  \ifdefined\DeclareUnicodeCharacterAsOptional
    \def\sphinxDUC#1{\DeclareUnicodeCharacter{"#1}}
  \else
    \let\sphinxDUC\DeclareUnicodeCharacter
  \fi
  \sphinxDUC{00A0}{\nobreakspace}
  \sphinxDUC{2500}{\sphinxunichar{2500}}
  \sphinxDUC{2502}{\sphinxunichar{2502}}
  \sphinxDUC{2514}{\sphinxunichar{2514}}
  \sphinxDUC{251C}{\sphinxunichar{251C}}
  \sphinxDUC{2572}{\textbackslash}
\fi
\usepackage{cmap}
\usepackage[T1]{fontenc}
\usepackage{amsmath,amssymb,amstext}
\usepackage{babel}



\usepackage{tgtermes}
\usepackage{tgheros}
\renewcommand{\ttdefault}{txtt}



\usepackage[Bjarne]{fncychap}
\usepackage{sphinx}

\fvset{fontsize=auto}
\usepackage{geometry}


% Include hyperref last.
\usepackage{hyperref}
% Fix anchor placement for figures with captions.
\usepackage{hypcap}% it must be loaded after hyperref.
% Set up styles of URL: it should be placed after hyperref.
\urlstyle{same}


\usepackage{sphinxmessages}
\setcounter{tocdepth}{1}



\title{SCRIMP}
\date{Sep 03, 2025}
\release{1.1}
\author{Giuseppe Ferraro, Michel Fournié, Ghislain Haine}
\newcommand{\sphinxlogo}{\vbox{}}
\renewcommand{\releasename}{Release}
\makeindex
\begin{document}

\ifdefined\shorthandoff
  \ifnum\catcode`\=\string=\active\shorthandoff{=}\fi
  \ifnum\catcode`\"=\active\shorthandoff{"}\fi
\fi

\pagestyle{empty}
\sphinxmaketitle
\pagestyle{plain}
\sphinxtableofcontents
\pagestyle{normal}
\phantomsection\label{\detokenize{index::doc}}


\sphinxAtStartPar
\sphinxstylestrong{Simulation and ContRol of Interactions in Multi\sphinxhyphen{}Physics}

\noindent{\hspace*{\fill}\sphinxincludegraphics[width=600\sphinxpxdimen,height=200\sphinxpxdimen]{{workflow}.png}\hspace*{\fill}}


\chapter{What is SCRIMP?}
\label{\detokenize{index:what-is-scrimp}}
\sphinxAtStartPar
\sphinxstylestrong{SCRIMP} (Simulation and ContRol of Interactions in Multi\sphinxhyphen{}Physics) is a python collection, \sphinxstyleemphasis{namely} a package, of \sphinxstyleemphasis{methods} and \sphinxstyleemphasis{classes} for the structure\sphinxhyphen{}preserving discretization and simulation of multi\sphinxhyphen{}physics models, using the formalism of port\sphinxhyphen{}Hamiltonian systems (\sphinxhref{https://doi.org/10.1016/S0393-0440(01)00083-3}{van der Schaft and Maschke (2002)}).

\sphinxAtStartPar
\sphinxstylestrong{SCRIMP} aims at speeding the coding process of the \sphinxstylestrong{Partitioned Finite Element Method} on a wide range of (multi\sphinxhyphen{})physical systems (\sphinxhref{https://doi.org/10.1016/j.ifacol.2024.08.267}{Ferraro *et al.* (2024)}), and scrimp and save time!

\sphinxAtStartPar
The documentation is \sphinxhref{https://g-haine.github.io/scrimp/latex/scrimp.pdf}{available in pdf}.


\section{Port\sphinxhyphen{}Hamiltonian systems}
\label{\detokenize{index:port-hamiltonian-systems}}

\subsection{What are they?}
\label{\detokenize{index:what-are-they}}
\sphinxAtStartPar
Let us sketch a rough portrait of port\sphinxhyphen{}Hamiltonian systems as they are considered in \sphinxstylestrong{SCRIMP}.

\sphinxAtStartPar
Port\sphinxhyphen{}Hamiltonian systems constitute a strongly structured class of control systems with collocated observation. It relies on a functional form \(\mathcal{H}\) (the \sphinxstylestrong{Hamiltonian}), whose variables \(\alpha_i\) are the \sphinxstylestrong{states} of the system. The \sphinxstylestrong{co\sphinxhyphen{}states} \(M_i e_i := \delta_{\alpha_i} \mathcal{H}\) are defined as the variational derivative of the Hamiltonian with respect to the states, on the metric induced by the \(M_i\) matrices.

\sphinxAtStartPar
The dynamics is provided \sphinxstyleemphasis{via} trajectories belonging in a \sphinxstylestrong{Dirac} structure, which can be represented by two matrices (of operators) \(M\) symmetric and \(J\) skew\sphinxhyphen{}symmetric as
\begin{equation*}
\begin{split}M
\begin{pmatrix} \frac{\rm d}{{\rm d}t} \alpha_1(t) \\ \vdots \\ \frac{\rm d}{{\rm d}t} \alpha_k(t) \\ f_R(t) \\ - y_{exp}(t) \\ u_{imp}(t) \end{pmatrix}
= J
\begin{pmatrix} e_1(t) \\ \vdots \\ e_k(t) \\ e_R(t) \\ u_{exp}(t) \\ - y_{imp}(t) \end{pmatrix}\end{split}
\end{equation*}
\sphinxAtStartPar
together with \sphinxstylestrong{constitutive relations}
\begin{equation*}
\begin{split}M_i e_i(t) = \delta_{\alpha_i(t)} \mathcal{H}(\alpha_1(t), \cdots, \alpha_k(t))
\qquad
\mathcal{N}(t, f_R(t), e_R(t)) = 0\end{split}
\end{equation*}
\sphinxAtStartPar
This structure allows to describe the evolution of the Hamiltonian along the trajectories
\begin{equation*}
\begin{split}\frac{\rm d}{{\rm d}t} \mathcal{H}(\alpha_1(t), \cdots, \alpha_k(t)) = - e_R(t)^\top M_R f_R(t) + u_{exp}(t)^\top M_{exp} y_{exp}(t) + u_{imp}(t)^\top M_{imp} y_{imp}(t)\end{split}
\end{equation*}
\sphinxAtStartPar
The first term of the right\sphinxhyphen{}hand side stands for a loss of \sphinxstyleemphasis{energy}, hence the name of \sphinxstyleemphasis{resistive (or dissipative) port} for the couple \((f_R,e_R)\). The other two terms stands for exchanges with the environment through the \sphinxstyleemphasis{control ports}. One is \sphinxstyleemphasis{explicit}, \(u_{exp}\), as a usual forcing term in the equations (its collocated output \(y_{exp}\) plays no role in the dynamics). The other is \sphinxstyleemphasis{implicit}: \(u_{imp}\) does not appear directly in the dynamics, and its collocated output \(y_{imp}\) plays the role of the Lagrange multiplier imposing the value of \(u_{imp}\).

\sphinxAtStartPar
Each indexed matrix \(M_\ell\) is the appropriate sub\sphinxhyphen{}matrix of \(M\).

\sphinxAtStartPar
A very important and useful fact is that the matrices \(M\) and \(J\) can depend on time and states!


\subsection{The Partitioned Finite Element Method}
\label{\detokenize{index:the-partitioned-finite-element-method}}
\sphinxAtStartPar
The main objective of a \sphinxstylestrong{structure\sphinxhyphen{}preserving discretization} in the port\sphinxhyphen{}Hamiltonian formalism is to obtain a discrete version of the power balance satisfied by the Hamiltonian functional.

\sphinxAtStartPar
A recent scheme, known as the \sphinxstylestrong{Partitioned Finite Element Method} (PFEM) (\sphinxhref{https://doi.org/10.1093/imamci/dnaa038}{Cardoso\sphinxhyphen{}Ribeiro *et al.* (2021)}), achieves this goal.

\sphinxAtStartPar
The strategy follows three steps, inspired by the Mixed Finite Element Method for steady\sphinxhyphen{}state problem with homogeneous boundary condition
\begin{itemize}
\item {} 
\sphinxAtStartPar
write the weak form of the system;

\item {} 
\sphinxAtStartPar
integrate by parts a \sphinxstylestrong{partition} of the state (such that \sphinxstyleemphasis{the control appears}); and

\item {} 
\sphinxAtStartPar
project on finite element spaces.

\end{itemize}


\section{Coding philosophy}
\label{\detokenize{index:coding-philosophy}}
\sphinxAtStartPar
\sphinxstylestrong{SCRIMP} assumes that the final user is not familiar with numerical simulations. The aim is to facilitate the first step from modelisation to simulation by sticking as much as possible to the port\sphinxhyphen{}Hamiltonian framework, getting rid of coding issues.

\sphinxAtStartPar
As such, these simplifications naturally imply a lack of optimization of the code. Nevertheless, the syntax of \sphinxstylestrong{SCRIMP} try to let confirmed users to reach finer tuning in order to perform more sophisticated simulations.

\sphinxAtStartPar
A basic usage of \sphinxstylestrong{SCRIMP} consists in a script with the following steps:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Define a \sphinxstyleemphasis{domain}

\item {} 
\sphinxAtStartPar
Define at least one \sphinxstyleemphasis{state}. And of course, its \sphinxstyleemphasis{co\sphinxhyphen{}state}, in order to get a \sphinxstyleemphasis{dynamical port}

\item {} 
\sphinxAtStartPar
Define a Finite Element Method on this port: give at least an order, at first glance, default values are sufficient

\item {} 
\sphinxAtStartPar
Define \sphinxstyleemphasis{algebraic ports} (not mandatory) and its FEM

\item {} 
\sphinxAtStartPar
Define \sphinxstyleemphasis{control ports} (not mandatory) and its FEM

\item {} 
\sphinxAtStartPar
Define \sphinxstyleemphasis{parameters}

\item {} 
\sphinxAtStartPar
Write down the forms on the \sphinxstyleemphasis{flow side} of the Dirac structure, \sphinxstyleemphasis{i.e.} the \sphinxstylestrong{brick} defining the matrix \(M\)

\item {} 
\sphinxAtStartPar
Write down the forms on the \sphinxstyleemphasis{effort side} of the Dirac structure, \sphinxstyleemphasis{i.e.} th \sphinxstylestrong{brick} defining the matrix \(J\)

\item {} 
\sphinxAtStartPar
Write down all the forms defining the \sphinxstyleemphasis{constitutive relations}, always with \sphinxstylestrong{bricks}

\item {} 
\sphinxAtStartPar
Set up time scheme options: again, at first glance, default values are sufficient

\item {} 
\sphinxAtStartPar
Solve

\item {} 
\sphinxAtStartPar
Plot

\item {} 
\sphinxAtStartPar
Export

\end{itemize}

\sphinxAtStartPar
We try to eliminate as much as possible the \sphinxstyleemphasis{computer\sphinxhyphen{}side} of the simulations, by following the port\sphinxhyphen{}Hamiltonian vocabulary, always by keeping the possibility of fine tuning available.


\chapter{User’s guide}
\label{\detokenize{index:user-s-guide}}
\sphinxstepscope


\section{How to install}
\label{\detokenize{install:how-to-install}}\label{\detokenize{install::doc}}

\subsection{Anaconda}
\label{\detokenize{install:anaconda}}
\sphinxAtStartPar
The easiest way to install SCRIMP is to use a conda environment.
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
\sphinxAtStartPar
Install \sphinxhref{https://docs.anaconda.com/free/anaconda/install/index.html}{Anaconda}

\item {} 
\sphinxAtStartPar
Clone the git repository: \sphinxcode{\sphinxupquote{git clone https://github.com/g\sphinxhyphen{}haine/scrimp}}

\item {} 
\sphinxAtStartPar
Enter the folder: \sphinxcode{\sphinxupquote{cd scrimp}}

\item {} 
\sphinxAtStartPar
Create the conda environment:  \sphinxcode{\sphinxupquote{conda env create \sphinxhyphen{}\sphinxhyphen{}file /path/to/scrimp/scrimp.yml}}

\item {} 
\sphinxAtStartPar
Activate the environment:  \sphinxcode{\sphinxupquote{conda activate scrimp}}

\item {} 
\sphinxAtStartPar
Add scrimp to the PATH: \sphinxcode{\sphinxupquote{conda develop /path/to/scrimp/}}

\item {} 
\sphinxAtStartPar
Finish with pip: \sphinxcode{\sphinxupquote{pip install \sphinxhyphen{}e .}}

\end{enumerate}


\subsection{Tests}
\label{\detokenize{install:tests}}
\sphinxAtStartPar
You may test your installation by running avalaible examples in the \sphinxcode{\sphinxupquote{\textasciigrave{}examples\textasciigrave{}}} folder.


\subsection{Code structure}
\label{\detokenize{install:code-structure}}
\sphinxAtStartPar
\sphinxstylestrong{SCRIMP} is developped as a \sphinxstyleemphasis{package}: the \sphinxcode{\sphinxupquote{\_\_init\_\_.py}} file of the \sphinxstyleemphasis{/path/to/scrimp/} folder is the root file. Each subdirectory is a sub\sphinxhyphen{}package of \sphinxstylestrong{SCRIMP}. Files are called \sphinxstyleemphasis{module} in this framework and may be called \sphinxstyleemphasis{via} the command \sphinxstylestrong{import}. For instance the module \sphinxstyleemphasis{linalg} gathering linear algebra functions of the \sphinxstyleemphasis{subpackage} utils can be imported with \sphinxcode{\sphinxupquote{import scrimp.utils.linalg}}.


\subsection{Documentation}
\label{\detokenize{install:documentation}}
\sphinxAtStartPar
You can find this documentation \sphinxhref{https://g-haine.github.io/scrimp/latex/scrimp.pdf}{here}.

\sphinxAtStartPar
It is automatically built upon the code comments using sphinx.

\sphinxAtStartPar
See \sphinxhref{https://www.sphinx-doc.org/}{Sphinx} for further informations.

\sphinxstepscope


\section{Getting started}
\label{\detokenize{started:getting-started}}\label{\detokenize{started::doc}}\phantomsection\label{\detokenize{started:started}}
\sphinxAtStartPar
In order to start using \sphinxstylestrong{SCRIMP}, you have to work in the conda environment \sphinxstyleemphasis{scrimp} from the installation by running \sphinxcode{\sphinxupquote{conda activate scrimp}}.

\sphinxAtStartPar
To understand the coding philosophy of \sphinxstylestrong{SCRIMP}, let us consider the 1D wave equation with Neumann boundary control as a first example
\begin{equation*}
\begin{split}\left\lbrace
\begin{array}{rcl}
\rho(x) \partial_{tt}^2 w(t,x) - \partial_x \left( T(x) \partial_x w(t,x) \right) &=& 0, \qquad t \ge 0, x \in (0,1), \\
\partial_t w(0,x) &=& v_0(x), \qquad x \in (0,1), \\
\partial_x w(0,x) &=& s_0(x), \qquad x \in (0,1), \\
- T(0) \partial_x \left( w(t,0) \right) &=& u_L(t), \qquad t \ge 0, \\
T(1) \partial_x \left( w(t,1) \right) &=& u_R(t), \qquad t \ge 0,
\end{array}
\right.\end{split}
\end{equation*}
\sphinxAtStartPar
where \(w\) denotes the deflection from the equilibrium position of
a string, \(\rho\) is its mass density and \(T\) the Young’s
modulus. \sphinxstylestrong{Note} the minus sign on the control at the left end side,
standing for the \sphinxstyleemphasis{outward normal} to the domain \((0,1)\).

\sphinxAtStartPar
The physics giving this equation has to be restated in the
port\sphinxhyphen{}Hamiltonian formalism first.


\subsection{Port\sphinxhyphen{}Hamiltonian framework}
\label{\detokenize{started:port-hamiltonian-framework}}
\sphinxAtStartPar
Let \(\alpha_q := \partial_x w\) denotes the \sphinxstyleemphasis{strain} and
\(\alpha_p := \rho \partial_t w\) the \sphinxstyleemphasis{linear momentum}. One can
express the total mechanical energy lying in the system
\(\mathcal{H}\), the \sphinxstylestrong{Hamiltonian}, as
\begin{equation*}
\begin{split}\mathcal{H}(t) = \mathcal{H}(\alpha_q(t,x), \alpha_p(t,x)) := \underbrace{\frac{1}{2} \int_0^1 \alpha_q(t,x) T(x) \alpha_q(t,x) {\rm d}x}_{\text{Potential energy}} + \underbrace{\frac{1}{2} \int_0^1 \frac{\alpha_p(t,x)^2}{\rho(x)} {\rm d}x}_{\text{Kinetic energy}}.\end{split}
\end{equation*}
\sphinxAtStartPar
The variables \(\alpha_q\) and \(\alpha_p\) are known as the
\sphinxstylestrong{state variables}, or in the present case since \(\mathcal{H}\)
represents an energy, the \sphinxstylestrong{energy variables}.

\sphinxAtStartPar
Computing the \sphinxhref{https://en.wikipedia.org/wiki/Functional\_derivative\%3E}{variational
derivative}
of \(\mathcal{H}\) with respect to these variables leads to the
\sphinxstylestrong{co\sphinxhyphen{}state variables}, or in our case the \sphinxstylestrong{co\sphinxhyphen{}energy variables},
\sphinxstyleemphasis{i.e.}
\begin{equation*}
\begin{split}e_q := \delta_{\alpha_q} \mathcal{H} = T \alpha_q, \qquad e_p := \delta_{\alpha_p} \mathcal{H} = \frac{\alpha_p}{\rho},\end{split}
\end{equation*}
\sphinxAtStartPar
that is the \sphinxstyleemphasis{stress} and the \sphinxstyleemphasis{velocity} respectively.

\sphinxAtStartPar
Newton’s second law and Schwarz’s lemma give the following dynamics
\begin{equation*}
\begin{split}\begin{pmatrix} \partial_t \alpha_q \\ \partial_t \alpha_p \end{pmatrix}
=
\begin{bmatrix} 0 & \partial_x \\ \partial_x & 0 \end{bmatrix}
\begin{pmatrix} e_q \\ e_p \end{pmatrix}.\end{split}
\end{equation*}
\sphinxAtStartPar
Of course, trivial substitutions in this system would lead again to the
initial string equation in second\sphinxhyphen{}order form. However, by keeping the
system as is, an important structure appears. Indeed, the matrix of
operators above is \sphinxstyleemphasis{formally} skew\sphinxhyphen{}symmetric. In other words, for all
test functions \(f_q\) and \(f_p\) (compactly supported
\(C^\infty\) functions), one has thanks to integration by parts
\begin{equation*}
\begin{split}\begin{pmatrix} f_q & f_p \end{pmatrix}
\begin{bmatrix} 0 & \partial_x \\ \partial_x & 0 \end{bmatrix}
\begin{pmatrix} f_q \\ f_p \end{pmatrix} = 0.\end{split}
\end{equation*}
\sphinxAtStartPar
Together with the boundary Neumann condition, and defining \sphinxstyleemphasis{collocated}
Dirichlet observations, this defines a (Stokes\sphinxhyphen{}) \sphinxstylestrong{Dirac structure},
where solutions along time, \sphinxstyleemphasis{i.e.} \sphinxstyleemphasis{trajectories}, will belong.

\sphinxAtStartPar
The port\sphinxhyphen{}Hamiltonian system representing a (linear) vibrating string
with Neumann boundary control and Dirichlet boundary observation then
writes
\begin{equation*}
\begin{split}\begin{pmatrix} \partial_t \alpha_q \\ \partial_t \alpha_p \end{pmatrix}
=
\begin{bmatrix} 0 & \partial_x \\ \partial_x & 0 \end{bmatrix}
\begin{pmatrix} e_q \\ e_p \end{pmatrix},\end{split}
\end{equation*}\begin{equation*}
\begin{split}\left\lbrace
\begin{array}{rcl}
- e_q(t,0) &=& u_L(t), \\
e_q(t,1) &=& u_R(t), \\
y_L(t) &=& e_p(t,0), \\
y_R(t) &=& e_p(t,1),
\end{array}
\right.\end{split}
\end{equation*}\begin{equation*}
\begin{split}\left\lbrace
\begin{array}{rcl}
e_q &=& T \alpha_q, \\
e_p &=& \frac{\alpha_p}{\rho}.
\end{array}
\right.\end{split}
\end{equation*}
\sphinxAtStartPar
The two first blocks, giving in particular the dynamics, define the
\sphinxstylestrong{Dirac structure} of the system. The third block is known as the
\sphinxstylestrong{constitutive relations}, and is needed to ensure uniqueness of
solutions.

\sphinxAtStartPar
The importance of the \sphinxstylestrong{Dirac structure} relies, in particular, in the
fact that it encloses the \sphinxstylestrong{power balance} satisfied by the
\sphinxstylestrong{Hamiltonian}. Indeed, along the trajectories, one has
\begin{equation*}
\begin{split}\frac{\rm d}{{\rm d}t} \mathcal{H}(t) = \frac{\rm d}{{\rm d}t} \mathcal{H}(\alpha_q(t), \alpha_p(t)) = \underbrace{y_R(t) u_R(t)}_{\text{power flowing through the right}} + \underbrace{y_L(t) u_L(t)}_{\text{power flowing through the left}}.\end{split}
\end{equation*}
\sphinxAtStartPar
In other words, the \sphinxstylestrong{Dirac structure} encodes the way the system
communicates with its environment. In the present example, it says that
the variation of the total mechanical energy is given by the power
supplied to the system at the boundaries.

\sphinxAtStartPar
Each couple \((\partial_t \alpha_q, e_q)\),
\((\partial_t \alpha_p, e_p)\), \((u_L, y_L)\) and
\((u_R, y_R)\) is a \sphinxstylestrong{port} of the port\sphinxhyphen{}Hamiltonian system, and is
associated to a physically meaningful term in the \sphinxstylestrong{power balance}.


\subsection{Structure\sphinxhyphen{}preserving discretization}
\label{\detokenize{started:structure-preserving-discretization}}
\sphinxAtStartPar
The objective of a structure\sphinxhyphen{}preserving discretization method is to
obtain a \sphinxstylestrong{finite\sphinxhyphen{}dimensional Dirac structure} that encloses a
\sphinxstyleemphasis{discrete version} of the power balance. There is several ways to
achieve this goal, but \sphinxstylestrong{SCRIMP} focuses on a particular application of
the Mixed Finite Element Mehod, called the \sphinxstylestrong{Partitioned Finite Element
Method}.

\sphinxAtStartPar
\sphinxstylestrong{Remark:} The 1D case does simplify the difficulties coming from the
boundary terms. Indeed, here the functional spaces for the controls
\(u_L\), \(u_R\) and the observations \(y_L\), \(y_R\)
are nothing but \(\mathbb{R}\).

\sphinxAtStartPar
Let \(\varphi_q\) and \(\varphi_p\) be smooth test functions,
and \(\delta_{mx}\) denote the Kronecker symbol. One can write the
weak formulation of the \sphinxstylestrong{Dirac Structure} as follows
\begin{equation*}
\begin{split}\left\lbrace
\begin{array}{rcl}
\int_0^1 \partial_t \alpha_q(t,x) \varphi_q(x) {\rm d}x &=& \int_0^1 \partial_x e_p(t,x) \varphi_q(x) {\rm d}x, \\
\int_0^1 \partial_t \alpha_p(t,x) \varphi_p(x) {\rm d}x &=& \int_0^1 \partial_x e_q(t,x) \varphi_p(x) {\rm d}x, \\
y_L(t) &=& \delta_{0x} e_p(t,x), \\
y_R(t) &=& \delta_{1x} e_p(t,x).
\end{array}
\right.\end{split}
\end{equation*}
\sphinxAtStartPar
Integrating by parts the second line make the controls appear
\begin{equation*}
\begin{split}\left\lbrace
\begin{array}{rcl}
\int_0^1 \partial_t \alpha_q(t,x) \varphi_q(x) {\rm d}x &=& \int_0^1 \partial_x e_p(t,x) \varphi_q(x) {\rm d}x, \\
\int_0^1 \partial_t \alpha_p(t,x) \varphi_p(x) {\rm d}x &=& - \int_0^1 e_q(t,x) \partial_x \varphi_p(x) {\rm d}x + u_R(t) \varphi_p(1) + u_L(t) \varphi_p(0), \\
y_L(t) &=& \delta_{0x} e_p(t,x), \\
y_R(t) &=& \delta_{1x} e_p(t,x).
\end{array}
\right.\end{split}
\end{equation*}
\sphinxAtStartPar
Now, let \((\varphi_q^i)_{1 \le i \le N_q}\) and
\((\varphi_p^k)_{1 \le k \le N_p}\) be two finite families of
approximations for the \(q\)\sphinxhyphen{}type port and the \(p\)\sphinxhyphen{}type port
respectively, typically finite element families, and write the discrete
weak formulation with those families, one has for all
\(1 \le i \le N_q\) and all \(1 \le k \le N_p\)
\begin{equation*}
\begin{split}\left\lbrace
\begin{array}{rcl}
\sum_{j=1}^{N_q} \int_0^1 \varphi_q^j(x) \varphi_q^i(x) {\rm d}x \, \frac{\rm d}{{\rm d}t} \alpha_q^j(t) &=& \sum_{\ell=1}^{N_p} \int_0^1 \partial_x \varphi_p^\ell(x) \varphi_q^i(x) {\rm d}x \, e_p^\ell(t), \\
\sum_{\ell=1}^{N_p} \int_0^1 \varphi_p^\ell(x) \varphi_p^k(x) {\rm d}x \, \frac{\rm d}{{\rm d}t} \alpha_p^\ell(t) &=& - \sum_{j=1}^{N_q} \int_0^1 \varphi_q^j(x) \partial_x \varphi_p^k(x) {\rm d}x \, e_q^j(t) \\
&& \qquad \qquad + u_R(t) \varphi_p^k(1) + u_L(t) \varphi_p^k(0), \\
y_L(t) &=& \sum_{\ell=1}^{N_p} \varphi_p^\ell(0) \, e_p^\ell(t), \\
y_R(t) &=& \sum_{\ell=1}^{N_p} \varphi_p^\ell(1) \, e_p^\ell(t),
\end{array}
\right.\end{split}
\end{equation*}
\sphinxAtStartPar
which rewrites in matrix form
\begin{equation*}
\begin{split}\underbrace{\begin{bmatrix}
M_q & 0 & 0 & 0 \\
0 & M_p & 0 & 0 \\
0 & 0 & 1 & 0 \\
0 & 0 & 0 & 1
\end{bmatrix}}_{= M}
\begin{pmatrix}
\frac{\rm d}{{\rm d}t} \underline{\alpha_q}(t) \\
\frac{\rm d}{{\rm d}t} \underline{\alpha_p}(t) \\
- y_L(t) \\
- y_R(t)
\end{pmatrix}
=
\underbrace{\begin{bmatrix}
0 & D & 0 & 0 \\
-D^\top & 0 & B_L & B_R \\
0 & -B_L^\top & 0 & 0 \\
0 & -B_R^\top & 0 & 0
\end{bmatrix}}_{= J}
\begin{pmatrix}
\underline{e_q}(t) \\
\underline{e_p}(t) \\
u_L(t) \\
u_R(t)
\end{pmatrix},\end{split}
\end{equation*}
\sphinxAtStartPar
where
\(\underline{\alpha_\star}(t) := \begin{pmatrix} \alpha_\star^1(t) & \cdots & \alpha_\star^{N_\star} \end{pmatrix}^\top\),
\(\underline{e_\star}(t) := \begin{pmatrix} e_\star^1(t) & \cdots & e_\star^{N_\star} \end{pmatrix}^\top\),
and
\begin{equation*}
\begin{split}(M_q)_{ij} := \int_0^1 \varphi_q^j(x) \varphi_q^i(x) {\rm d}x,
\qquad
(M_p)_{k\ell} := \int_0^1 \varphi_p^\ell(x) \varphi_p^k(x) {\rm d}x,\end{split}
\end{equation*}\begin{equation*}
\begin{split}(D)_{i\ell} := \int_0^1 \partial_x \varphi_p^\ell(x) \varphi_q^i(x) {\rm d}x,
\qquad
(B_L)_{k} := \varphi_p^k(0),
\qquad
(B_R)_{k} := \varphi_p^k(1).\end{split}
\end{equation*}
\sphinxAtStartPar
Abusing the language, the left\sphinxhyphen{}hand side will be called the \sphinxstylestrong{flow} of
the \sphinxstylestrong{Dirac structure} in \sphinxstylestrong{SCRIMP}, while the right\sphinxhyphen{}hand side will be
called the \sphinxstylestrong{effort}.

\sphinxAtStartPar
Now one can approximate the \sphinxstylestrong{constitutive relations} in those families
by projection of their weak formulations
\begin{equation*}
\begin{split}\left\lbrace
\begin{array}{rcl}
\int_0^1 e_q(t,x) \varphi_q(x) {\rm d}x &=& \int_0^1 T(x) \alpha_q(t,x) \varphi_q(x) {\rm d}x, \\
\int_0^1 e_p(t,x) \varphi_p(x) {\rm d}x &=&  \int_0^1 \frac{\alpha_p(t,x)}{\rho(x)} \varphi_p(x) {\rm d}x,
\end{array}
\right.\end{split}
\end{equation*}
\sphinxAtStartPar
from which one can deduce the matrix form of the discrete weak
formulation of the constitutive relation
\begin{equation*}
\begin{split}\left\lbrace
\begin{array}{rcl}
M_q \underline{e_q}(t) &=& M_T \underline{\alpha_q}(t), \\
M_p \underline{e_p}(t) &=& M_\rho \underline{\alpha_p}(t),
\end{array}
\right.\end{split}
\end{equation*}
\sphinxAtStartPar
where
\begin{equation*}
\begin{split}(M_T)_{ij} := \int_0^1 T(x) \varphi_q^j(x) \varphi_q^i(x) {\rm d}x,
\qquad
(M_\rho)_{k\ell} := \int_0^1 \frac{\varphi_p^\ell(x)}{\rho(x)} \varphi_p^k(x) {\rm d}x.\end{split}
\end{equation*}
\sphinxAtStartPar
Finally, the \sphinxstylestrong{discrete Hamiltonian} \(\mathcal{H}^d\) is defined
as the evaluation of \(\mathcal{H}\) on the approximation of the
\sphinxstylestrong{state variables}
\begin{equation*}
\begin{split}\mathcal{H}^d(t) := \mathcal{H}(\alpha_q^d(t,x), \alpha_p^d(t)) = \frac{1}{2} \underline{\alpha_q}(t)^\top M_T \underline{\alpha_q}(t) + \frac{1}{2} \underline{\alpha_p}(t)^\top M_\rho \underline{\alpha_p}(t).\end{split}
\end{equation*}
\sphinxAtStartPar
The \sphinxstylestrong{discrete power balance} is then easily deduced from the above
matrix formulations, thanks to the symmetry of \(M\) and the
skew\sphinxhyphen{}symmetry of \(J\)
\begin{equation*}
\begin{split}\frac{\rm d}{{\rm d}t} \mathcal{H}^d(t) = y_R(t) u_R(t) + y_L(t) u_L(t).\end{split}
\end{equation*}
\sphinxAtStartPar
\sphinxstylestrong{Remark:} The discrete system that has to be solved numerically is a
Differential Algebraic Equation (DAE). There exists some case (as in
this example), where one can write the \sphinxstylestrong{co\sphinxhyphen{}state} formulation of the
system by substituting the \sphinxstylestrong{constitutive relations} at the continuous
level to get a more classical Ordinary Differential Equation (ODE)
\begin{equation*}
\begin{split}\begin{bmatrix}
\widetilde{M}_q & 0 & 0 & 0 \\
0 & \widetilde{M}_p & 0 & 0 \\
0 & 0 & 1 & 0 \\
0 & 0 & 0 & 1
\end{bmatrix}
\begin{pmatrix}
\frac{\rm d}{{\rm d}t} \underline{e_q}(t) \\
\frac{\rm d}{{\rm d}t} \underline{e_p}(t) \\
- y_L(t) \\
- y_R(t)
\end{pmatrix}
=
\begin{bmatrix}
0 & D & 0 & 0 \\
-D^\top & 0 & B_L & B_R \\
0 & -B_L^\top & 0 & 0 \\
0 & -B_R^\top & 0 & 0
\end{bmatrix}
\begin{pmatrix}
\underline{e_q}(t) \\
\underline{e_p}(t) \\
u_L(t) \\
u_R(t)
\end{pmatrix},\end{split}
\end{equation*}
\sphinxAtStartPar
where this time the mass matrices on the left\sphinxhyphen{}hand side are both
\sphinxstyleemphasis{weighted} with respect to the physical parameters
\begin{equation*}
\begin{split}(\widetilde{M}_q)_{ij} := \int_0^1 T^{-1}(x) \varphi_q^j(x) \varphi_q^i(x) {\rm d}x,
\qquad
(\widetilde{M}_p)_{k\ell} := \int_0^1 \rho(x) \varphi_p^\ell(x) \varphi_p^k(x) {\rm d}x.\end{split}
\end{equation*}

\subsection{Coding within SCRIMP}
\label{\detokenize{started:coding-within-scrimp}}
\sphinxAtStartPar
The following code is available in the file \sphinxcode{\sphinxupquote{wave\_1D.py}} of the
\sphinxstyleemphasis{sandbox} folder of scrimp.

\sphinxAtStartPar
To start, import \sphinxstylestrong{SCRIMP} and create a \sphinxstyleemphasis{distributed port\sphinxhyphen{}Hamiltonian
system} (DPHS) called, \sphinxstyleemphasis{e.g.}, \sphinxcode{\sphinxupquote{wave}}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{scrimp}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{S}

\PYG{n}{wave} \PYG{o}{=} \PYG{n}{S}\PYG{o}{.}\PYG{n}{DPHS}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{real}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\end{sphinxVerbatim}

\sphinxAtStartPar
Then, define the domain \(\Omega = (0,1)\), with a mesh\sphinxhyphen{}size
parameter \(h\), and add it to the \sphinxstyleemphasis{DPHS}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{n}{domain} \PYG{o}{=} \PYG{n}{S}\PYG{o}{.}\PYG{n}{Domain}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Interval}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{p}{\PYGZob{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{L}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+m+mf}{1.}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{h}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+m+mf}{0.01}\PYG{p}{\PYGZcb{}}\PYG{p}{)}
\PYG{n}{wave}\PYG{o}{.}\PYG{n}{set\PYGZus{}domain}\PYG{p}{(}\PYG{n}{domain}\PYG{p}{)}
\end{sphinxVerbatim}

\sphinxAtStartPar
This creates a mesh of the interval \(\Omega = (0,1)\).

\sphinxAtStartPar
\sphinxstylestrong{Important to keep in mind}: the domain is composed of \sphinxcode{\sphinxupquote{regions}},
denoted by integers. The \sphinxstyleemphasis{built\sphinxhyphen{}in} geometry of an interval available in
the code returns 1 for the domain \(\Omega\), 10 for the left\sphinxhyphen{}end
and 11 for the right\sphinxhyphen{}end. Informations about available geometries and
the indices of their regions can be found in the documentation or \sphinxstyleemphasis{via}
the function \sphinxcode{\sphinxupquote{built\_in\_geometries()}} available in
\sphinxcode{\sphinxupquote{scrimp.utils.mesh}}.

\sphinxAtStartPar
On this domain, we define two \sphinxstylestrong{states} and add them to the \sphinxstyleemphasis{DPHS}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{n}{alpha\PYGZus{}q} \PYG{o}{=} \PYG{n}{S}\PYG{o}{.}\PYG{n}{State}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{q}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Strain}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{scalar\PYGZhy{}field}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n}{alpha\PYGZus{}p} \PYG{o}{=} \PYG{n}{S}\PYG{o}{.}\PYG{n}{State}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{p}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Linear momentum}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{scalar\PYGZhy{}field}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n}{wave}\PYG{o}{.}\PYG{n}{add\PYGZus{}state}\PYG{p}{(}\PYG{n}{alpha\PYGZus{}q}\PYG{p}{)}
\PYG{n}{wave}\PYG{o}{.}\PYG{n}{add\PYGZus{}state}\PYG{p}{(}\PYG{n}{alpha\PYGZus{}p}\PYG{p}{)}
\end{sphinxVerbatim}

\sphinxAtStartPar
and the two associated \sphinxstylestrong{co\sphinxhyphen{}states}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{n}{e\PYGZus{}q} \PYG{o}{=} \PYG{n}{S}\PYG{o}{.}\PYG{n}{CoState}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{e\PYGZus{}q}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Stress}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{alpha\PYGZus{}q}\PYG{p}{)}
\PYG{n}{e\PYGZus{}p} \PYG{o}{=} \PYG{n}{S}\PYG{o}{.}\PYG{n}{CoState}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{e\PYGZus{}p}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Velocity}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{alpha\PYGZus{}p}\PYG{p}{)}
\PYG{n}{wave}\PYG{o}{.}\PYG{n}{add\PYGZus{}costate}\PYG{p}{(}\PYG{n}{e\PYGZus{}q}\PYG{p}{)}
\PYG{n}{wave}\PYG{o}{.}\PYG{n}{add\PYGZus{}costate}\PYG{p}{(}\PYG{n}{e\PYGZus{}p}\PYG{p}{)}
\end{sphinxVerbatim}

\sphinxAtStartPar
These latter calls create automatically two \sphinxstyleemphasis{non\sphinxhyphen{}algebraic} \sphinxstylestrong{ports},
named after their respective \sphinxstylestrong{state}. Note that we simplify the
notations and do not write \sphinxcode{\sphinxupquote{alpha\_q}} and \sphinxcode{\sphinxupquote{alpha\_p}} but \sphinxcode{\sphinxupquote{q}} and
\sphinxcode{\sphinxupquote{p}} for the sake of readability.

\sphinxAtStartPar
Finally, we create and add the two control\sphinxhyphen{}observation \sphinxstylestrong{ports} with

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{n}{left\PYGZus{}end} \PYG{o}{=} \PYG{n}{S}\PYG{o}{.}\PYG{n}{Control\PYGZus{}Port}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Boundary control (left)}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{U\PYGZus{}L}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Normal force}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Y\PYGZus{}L}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Velocity}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{scalar\PYGZhy{}field}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{region}\PYG{o}{=}\PYG{l+m+mi}{10}\PYG{p}{)}
\PYG{n}{right\PYGZus{}end} \PYG{o}{=} \PYG{n}{S}\PYG{o}{.}\PYG{n}{Control\PYGZus{}Port}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Boundary control (right)}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{U\PYGZus{}R}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Normal force}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Y\PYGZus{}R}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Velocity}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{scalar\PYGZhy{}field}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{region}\PYG{o}{=}\PYG{l+m+mi}{11}\PYG{p}{)}
\PYG{n}{wave}\PYG{o}{.}\PYG{n}{add\PYGZus{}control\PYGZus{}port}\PYG{p}{(}\PYG{n}{left\PYGZus{}end}\PYG{p}{)}
\PYG{n}{wave}\PYG{o}{.}\PYG{n}{add\PYGZus{}control\PYGZus{}port}\PYG{p}{(}\PYG{n}{right\PYGZus{}end}\PYG{p}{)}
\end{sphinxVerbatim}

\sphinxAtStartPar
Note the \sphinxstyleemphasis{crucial} keyword \sphinxcode{\sphinxupquote{region}} to restrict each port to its end.
By default, it would apply everywhere.

\sphinxAtStartPar
\sphinxstylestrong{Syntaxic note:} although \(y\) is the observation in the theory
of port\sphinxhyphen{}Hamiltonian systems, it is also the second space variable for
N\sphinxhyphen{}D problems. This name is thus reserved for this latter aim and
forbidden in all definitions of a \sphinxstyleemphasis{DPHS}. Nevertheless, the code being
case\sphinxhyphen{}sensitive, it is possible to name the observation \sphinxcode{\sphinxupquote{Y}}. To avoid
mistakes, we take the habit to always use this syntax, this is why we
denoted our controls and observations with capital letters even if the
problem does not occur in this 1D example.

\sphinxAtStartPar
To be able to write the discrete weak formulation of the system, one
need to set four finite element families, associated to each \sphinxstylestrong{port}.
Only two arguments are mandatory: the \sphinxstyleemphasis{name} of the port and the
\sphinxstyleemphasis{degree} of the approximations.

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{n}{V\PYGZus{}q} \PYG{o}{=} \PYG{n}{S}\PYG{o}{.}\PYG{n}{FEM}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{q}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{)}
\PYG{n}{V\PYGZus{}p} \PYG{o}{=} \PYG{n}{S}\PYG{o}{.}\PYG{n}{FEM}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{p}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{)}
\PYG{n}{V\PYGZus{}L} \PYG{o}{=} \PYG{n}{S}\PYG{o}{.}\PYG{n}{FEM}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Boundary control (left)}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{)}
\PYG{n}{V\PYGZus{}R} \PYG{o}{=} \PYG{n}{S}\PYG{o}{.}\PYG{n}{FEM}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Boundary control (right)}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{)}
\end{sphinxVerbatim}

\sphinxAtStartPar
This will construct a family of Lagrange finite elements (default
choice) for each port, with the prescribed order. Remember that the
boundary is only 2 disconnected points in this 1D case, so the only
possibility for the finite element is 1 degree of freedom on each of
them: Lagrange elements of order 1 is the easy way to do that.

\sphinxAtStartPar
Of course, this \sphinxstyleemphasis{FEM} must be added to the \sphinxstyleemphasis{DPHS}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{n}{wave}\PYG{o}{.}\PYG{n}{add\PYGZus{}FEM}\PYG{p}{(}\PYG{n}{V\PYGZus{}q}\PYG{p}{)}
\PYG{n}{wave}\PYG{o}{.}\PYG{n}{add\PYGZus{}FEM}\PYG{p}{(}\PYG{n}{V\PYGZus{}p}\PYG{p}{)}
\PYG{n}{wave}\PYG{o}{.}\PYG{n}{add\PYGZus{}FEM}\PYG{p}{(}\PYG{n}{V\PYGZus{}L}\PYG{p}{)}
\PYG{n}{wave}\PYG{o}{.}\PYG{n}{add\PYGZus{}FEM}\PYG{p}{(}\PYG{n}{V\PYGZus{}R}\PYG{p}{)}
\end{sphinxVerbatim}

\sphinxAtStartPar
Finally, the physical parameters of the experiment have to be defined.
In \sphinxstylestrong{SCRIMP}, a \sphinxstyleemphasis{parameter} is associated to a \sphinxstyleemphasis{port}.

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{n}{T} \PYG{o}{=} \PYG{n}{S}\PYG{o}{.}\PYG{n}{Parameter}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{T}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Young}\PYG{l+s+s2}{\PYGZsq{}}\PYG{l+s+s2}{s modulus}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{scalar\PYGZhy{}field}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{1}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{q}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n}{rho} \PYG{o}{=} \PYG{n}{S}\PYG{o}{.}\PYG{n}{Parameter}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{rho}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Mass density}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{scalar\PYGZhy{}field}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{1 + x*(1\PYGZhy{}x)}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{p}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n}{wave}\PYG{o}{.}\PYG{n}{add\PYGZus{}parameter}\PYG{p}{(}\PYG{n}{T}\PYG{p}{)}
\PYG{n}{wave}\PYG{o}{.}\PYG{n}{add\PYGZus{}parameter}\PYG{p}{(}\PYG{n}{rho}\PYG{p}{)}
\end{sphinxVerbatim}

\sphinxAtStartPar
The first argument will be \sphinxstylestrong{the string that can be used in forms}, the
second argument is a human\sphinxhyphen{}readable description, the third one set the
kind of the parameter, the fourth one is the mathematical expression
defining the parameter, and finally the fifth argument is the \sphinxstyleemphasis{name} of
the associated port.

\sphinxAtStartPar
It is now possible to write the weak forms defining the system. \sphinxstyleemphasis{Only
the non\sphinxhyphen{}zero blocks} are mandatory. Furthermore, the place of the block
is automatically determined by GetFEM. The syntax follow a simple rule:
the unknown trial function \sphinxcode{\sphinxupquote{q}} is automatically associated to the test
function \sphinxcode{\sphinxupquote{Test\_q}} (note the capital T on \sphinxcode{\sphinxupquote{Test}}), and so on.

\sphinxAtStartPar
Like we did for each call, the first step is to create the object, then
to add it to the \sphinxstyleemphasis{DPHS}. As there is a lot of \sphinxstyleemphasis{bricks}, let us make a
loop using a python \sphinxstyleemphasis{list}

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{n}{bricks} \PYG{o}{=} \PYG{p}{[}
    \PYG{c+c1}{\PYGZsh{} M matrix, on the flow side}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{Brick}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{M\PYGZus{}q}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{q * Test\PYGZus{}q}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,} \PYG{n}{dt}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{,} \PYG{n}{position}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{flow}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{Brick}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{M\PYGZus{}p}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{p * Test\PYGZus{}p}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,} \PYG{n}{dt}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{,} \PYG{n}{position}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{flow}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{Brick}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{M\PYGZus{}Y\PYGZus{}L}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Y\PYGZus{}L * Test\PYGZus{}Y\PYGZus{}L}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mi}{10}\PYG{p}{]}\PYG{p}{,} \PYG{n}{position}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{flow}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{Brick}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{M\PYGZus{}Y\PYGZus{}R}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Y\PYGZus{}R * Test\PYGZus{}Y\PYGZus{}R}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mi}{11}\PYG{p}{]}\PYG{p}{,} \PYG{n}{position}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{flow}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}

    \PYG{c+c1}{\PYGZsh{} J matrix, on the effort side}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{Brick}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{D}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Grad(e\PYGZus{}p) * Test\PYGZus{}q}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,} \PYG{n}{position}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{effort}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}

    \PYG{n}{S}\PYG{o}{.}\PYG{n}{Brick}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{\PYGZhy{}D\PYGZca{}T}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{\PYGZhy{}e\PYGZus{}q * Grad(Test\PYGZus{}p)}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,} \PYG{n}{position}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{effort}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{Brick}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{B\PYGZus{}L}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{\PYGZhy{}U\PYGZus{}L * Test\PYGZus{}p}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mi}{10}\PYG{p}{]}\PYG{p}{,} \PYG{n}{position}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{effort}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{Brick}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{B\PYGZus{}R}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{U\PYGZus{}R * Test\PYGZus{}p}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mi}{11}\PYG{p}{]}\PYG{p}{,} \PYG{n}{position}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{effort}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}

    \PYG{n}{S}\PYG{o}{.}\PYG{n}{Brick}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{\PYGZhy{}B\PYGZus{}L\PYGZca{}T}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{e\PYGZus{}p * Test\PYGZus{}Y\PYGZus{}L}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mi}{10}\PYG{p}{]}\PYG{p}{,} \PYG{n}{position}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{effort}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{Brick}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{\PYGZhy{}B\PYGZus{}R\PYGZca{}T}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{\PYGZhy{}e\PYGZus{}p * Test\PYGZus{}Y\PYGZus{}R}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mi}{11}\PYG{p}{]}\PYG{p}{,} \PYG{n}{position}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{effort}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}

    \PYG{c+c1}{\PYGZsh{} Constitutive relations}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{Brick}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{\PYGZhy{}M\PYGZus{}e\PYGZus{}q}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{\PYGZhy{}e\PYGZus{}q * Test\PYGZus{}e\PYGZus{}q}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{)}\PYG{p}{,}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{Brick}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{CR\PYGZus{}q}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{q*T * Test\PYGZus{}e\PYGZus{}q}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{)}\PYG{p}{,}

    \PYG{n}{S}\PYG{o}{.}\PYG{n}{Brick}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{\PYGZhy{}M\PYGZus{}e\PYGZus{}p}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{\PYGZhy{}e\PYGZus{}p * Test\PYGZus{}e\PYGZus{}p}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{)}\PYG{p}{,}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{Brick}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{CR\PYGZus{}p}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{p/rho * Test\PYGZus{}e\PYGZus{}p}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{)}\PYG{p}{,}
    \PYG{p}{]}

\PYG{k}{for} \PYG{n}{brick} \PYG{o+ow}{in} \PYG{n}{bricks}\PYG{p}{:}
    \PYG{n}{wave}\PYG{o}{.}\PYG{n}{add\PYGZus{}brick}\PYG{p}{(}\PYG{n}{brick}\PYG{p}{)}
\end{sphinxVerbatim}

\sphinxAtStartPar
The first argument of a \sphinxstyleemphasis{brick} is a human\sphinxhyphen{}readable name, the second one
is the form, the third is a list (hence the {[} and {]}) of integers,
listing all the regions where the form applies. The optional parameter
\sphinxcode{\sphinxupquote{dt=True}} is to inform \sphinxstylestrong{SCRIMP} that this block matrix will apply on
the time\sphinxhyphen{}derivative of the unknown trial function, and finally the
option parameter \sphinxcode{\sphinxupquote{position="flow"}} informs \sphinxstylestrong{SCRIMP} that this block
is a part of the \sphinxstyleemphasis{flow side} of the Dirac structure,
\sphinxcode{\sphinxupquote{position="effort"}} do the same for the \sphinxstyleemphasis{effort side}, and without
this keyword, \sphinxstylestrong{SCRIMP} places the \sphinxstyleemphasis{brick} as part of the \sphinxstyleemphasis{constitutive
relations}.

\sphinxAtStartPar
\sphinxstylestrong{Syntaxic note:} the constitutive relations have to be written under
an implicit formulation \(F = 0\). Keep in mind that a minus sign
will often appear because of that.

\sphinxAtStartPar
The port\sphinxhyphen{}Hamiltonian system is now fully stated. It remains to set the
controls and the initial values of the states before solving

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{n}{expression\PYGZus{}left} \PYG{o}{=} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{\PYGZhy{}sin(2*pi*t)}\PYG{l+s+s2}{\PYGZdq{}}
\PYG{n}{expression\PYGZus{}right} \PYG{o}{=} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{0.}\PYG{l+s+s2}{\PYGZdq{}}
\PYG{n}{wave}\PYG{o}{.}\PYG{n}{set\PYGZus{}control}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Boundary control (left)}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{expression\PYGZus{}left}\PYG{p}{)}
\PYG{n}{wave}\PYG{o}{.}\PYG{n}{set\PYGZus{}control}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Boundary control (right)}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{expression\PYGZus{}right}\PYG{p}{)}

\PYG{n}{q\PYGZus{}init} \PYG{o}{=} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{2.*np.exp(\PYGZhy{}50.*(x\PYGZhy{}0.5)*(x\PYGZhy{}0.5))}\PYG{l+s+s2}{\PYGZdq{}}
\PYG{n}{p\PYGZus{}init} \PYG{o}{=} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{0.}\PYG{l+s+s2}{\PYGZdq{}}
\PYG{n}{wave}\PYG{o}{.}\PYG{n}{set\PYGZus{}initial\PYGZus{}value}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{q}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{q\PYGZus{}init}\PYG{p}{)}
\PYG{n}{wave}\PYG{o}{.}\PYG{n}{set\PYGZus{}initial\PYGZus{}value}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{p}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{p\PYGZus{}init}\PYG{p}{)}
\end{sphinxVerbatim}

\sphinxAtStartPar
We can now solve the system (with default experiment parameters)

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{n}{wave}\PYG{o}{.}\PYG{n}{solve}\PYG{p}{(}\PYG{p}{)}
\end{sphinxVerbatim}

\sphinxAtStartPar
To end, one can also add the Hamiltonian terms and plot the contribution
of each port to the balance equation

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{n}{wave}\PYG{o}{.}\PYG{n}{hamiltonian}\PYG{o}{.}\PYG{n}{set\PYGZus{}name}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Mechanical energy}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n}{terms} \PYG{o}{=} \PYG{p}{[}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{Term}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Kinetic energy}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{0.5*p*p/rho}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{)}\PYG{p}{,}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{Term}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Potential energy}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{0.5*q*T*q}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{)}\PYG{p}{,}
\PYG{p}{]}

\PYG{k}{for} \PYG{n}{term} \PYG{o+ow}{in} \PYG{n}{terms}\PYG{p}{:}
    \PYG{n}{wave}\PYG{o}{.}\PYG{n}{hamiltonian}\PYG{o}{.}\PYG{n}{add\PYGZus{}term}\PYG{p}{(}\PYG{n}{term}\PYG{p}{)}

\PYG{n}{wave}\PYG{o}{.}\PYG{n}{plot\PYGZus{}Hamiltonian}\PYG{p}{(}\PYG{p}{)}
\end{sphinxVerbatim}

\noindent{\hspace*{\fill}\sphinxincludegraphics[width=600\sphinxpxdimen]{{Hamiltonian-wave-1D-started}.png}\hspace*{\fill}}

\sphinxAtStartPar
One can appreciate the \sphinxstyleemphasis{structure\sphinxhyphen{}preserving} property by looking at the
dashed line, showing the evolution of
\begin{equation*}
\begin{split}\mathcal{H}^d(t) - \int_0^t u_R(s) y_R(s) {\rm d}s - \int_0^t u_L(s) y_L(s) {\rm d}s.\end{split}
\end{equation*}
\sphinxAtStartPar
And now? It is time to see \sphinxhref{examples.html}{more examples}.

\sphinxstepscope


\section{Examples}
\label{\detokenize{examples:examples}}\label{\detokenize{examples::doc}}\phantomsection\label{\detokenize{examples:id1}}
\sphinxAtStartPar
We provide some examples coming from our \sphinxhref{biblio}{publications}.

\sphinxstepscope


\subsection{The wave equation}
\label{\detokenize{examples/wave:the-wave-equation}}\label{\detokenize{examples/wave::doc}}

\subsubsection{Setting}
\label{\detokenize{examples/wave:setting}}\label{\detokenize{examples/wave:wave-2d}}
\sphinxAtStartPar
Let us consider the 2D wave equation with \sphinxstyleemphasis{mixed} boundary controls on a
bounded rectangle \(\Omega := (0, L) \times (0, \ell)\), with boundaries
\(\Gamma_N := \left( (0, L) \times \{ 0, \ell \} \right) \cup \left( \{ L \} \times (0, \ell) \right)\) and \(\Gamma_D := \{ 0 \} \times (0, \ell)\).

\sphinxAtStartPar
The deflection of the membrane from the equilibrium \(w\) satisfies
classicaly
\begin{equation*}
\begin{split}\left\lbrace
\begin{array}{rcl}
\rho(x) \partial_{tt}^2 w(t,x) - {\rm div} \left( T(x) \cdot {\rm grad} \left( w(t,x) \right) \right) &=& 0, \qquad t \ge 0, x \in \Omega, \\
\partial_t w(0,x) &=& v_0(x), \qquad x \in \Omega, \\
\partial_x w(0,x) &=& s_0(x), \qquad x \in \Omega, \\
T(s) \cdot {\rm grad} \left( w(t,s) \right) &=& u_N(t,s), \qquad t \ge 0, s \in \Gamma_N, \\
\partial_t w(t,s) &=& u_D(t,s), \qquad t \ge 0, s \in \Gamma_D,
\end{array}
\right.\end{split}
\end{equation*}
\sphinxAtStartPar
where \(\rho\) is the mass density and \(T\) the Young’s
modulus. The subscript \(N\) stands for \sphinxstylestrong{Neumann}, while the
subscript \(D\) stands for \sphinxstylestrong{Dirichlet} (to be fair, this is not
really a Dirichlet boundary condition, as it imposes
\(\partial_t w\) and not \(w\) at the boundary
\(\Gamma_D\)).

\sphinxAtStartPar
Let us state the physics in the port\sphinxhyphen{}Hamiltonian formalism.


\subsubsection{Port\sphinxhyphen{}Hamiltonian framework}
\label{\detokenize{examples/wave:port-hamiltonian-framework}}
\sphinxAtStartPar
Let \(\alpha_q := {\rm grad} w\) denotes the \sphinxstyleemphasis{strain} and
\(\alpha_p := \rho \partial_t w\) the \sphinxstyleemphasis{linear momentum}. One can
express the total mechanical energy lying in the system
\(\mathcal{H}\), the \sphinxstylestrong{Hamiltonian}, as
\begin{equation*}
\begin{split}\mathcal{H}(t) = \mathcal{H}(\alpha_q(t,x), \alpha_p(t,x)) := \underbrace{\frac{1}{2} \int_\Omega \alpha_q(t,x) \cdot T(x) \cdot \alpha_q(t,x) {\rm d}x}_{\text{Potential energy}} + \underbrace{\frac{1}{2} \int_\Omega \frac{\alpha_p(t,x)^2}{\rho(x)} {\rm d}x}_{\text{Kinetic energy}}.\end{split}
\end{equation*}
\sphinxAtStartPar
The \sphinxstylestrong{co\sphinxhyphen{}energy variables} are, as in the 1D case
\begin{equation*}
\begin{split}e_q := \delta_{\alpha_q} \mathcal{H} = T \cdot \alpha_q, \qquad e_p := \delta_{\alpha_p} \mathcal{H} = \frac{\alpha_p}{\rho},\end{split}
\end{equation*}
\sphinxAtStartPar
that is the \sphinxstyleemphasis{stress} and the \sphinxstyleemphasis{velocity} respectively.

\sphinxAtStartPar
Newton’s second law and Schwarz’s lemma give the following dynamics
\begin{equation*}
\begin{split}\begin{pmatrix} \partial_t \alpha_q \\ \partial_t \alpha_p \end{pmatrix}
=
\begin{bmatrix} 0 & {\rm grad} \\ {\rm div} & 0 \end{bmatrix}
\begin{pmatrix} e_q \\ e_p \end{pmatrix}.\end{split}
\end{equation*}
\sphinxAtStartPar
Of course, this system allows to recover the initial wave equation in
second\sphinxhyphen{}order form.

\sphinxAtStartPar
The port\sphinxhyphen{}Hamiltonian system representing a (linear) vibrating membrane
with mixed boundary controls then writes
\begin{equation*}
\begin{split}\begin{pmatrix} \partial_t \alpha_q \\ \partial_t \alpha_p \end{pmatrix}
=
\begin{bmatrix} 0 & {\rm grad} \\ {\rm div} & 0 \end{bmatrix}
\begin{pmatrix} e_q \\ e_p \end{pmatrix},\end{split}
\end{equation*}\begin{equation*}
\begin{split}\left\lbrace
\begin{array}{rcl}
e_q(t,s) &=& u_N(t,s), \qquad t \ge 0, s \in \Gamma_N, \\
e_p(t,s) &=& u_D(t,s), \qquad t \ge 0, s \in \Gamma_D, \\
y_N(t,s) &=& e_p(t,s), \qquad t \ge 0, s \in \Gamma_N, \\
y_D(t,s) &=& e_q(t,s), \qquad t \ge 0, s \in \Gamma_D,
\end{array}
\right.\end{split}
\end{equation*}\begin{equation*}
\begin{split}\left\lbrace
\begin{array}{rcl}
e_q &=& T \cdot \alpha_q, \\
e_p &=& \frac{\alpha_p}{\rho}.
\end{array}
\right.\end{split}
\end{equation*}
\sphinxAtStartPar
The \sphinxstylestrong{power balance} satisfied by the \sphinxstylestrong{Hamiltonian} is
\begin{equation*}
\begin{split}\frac{\rm d}{{\rm d}t} \mathcal{H}(t) = \underbrace{\left\langle y_N(t,\cdot), u_N(t,\cdot)\right\rangle_{\Gamma_N}}_{\text{power flowing through }\Gamma_N} + \underbrace{\left\langle u_D(t,\cdot), y_D(t,\cdot) \right\rangle_{\Gamma_D}}_{\text{power flowing through }\Gamma_D},\end{split}
\end{equation*}
\sphinxAtStartPar
where \(\left\langle \cdot, \cdot \right\rangle_{\Gamma}\) is a
boundary duality bracket \(H^\frac12, H^{-\frac12}\) at the boundary
\(\Gamma\).


\subsubsection{Structure\sphinxhyphen{}preserving discretization}
\label{\detokenize{examples/wave:structure-preserving-discretization}}
\sphinxAtStartPar
Let \(\varphi_q\) and \(\varphi_p\) be smooth test functions on
\(\Omega\), and \(\psi_N\) and \(\psi_D\) be smooth test
functions on \(\Gamma_N\) and \(\Gamma_D\) respectively. One can
write the weak formulation of the \sphinxstylestrong{Dirac Structure} as follows
\begin{equation}\label{equation:examples/wave:weak-form}
\begin{split}   \left\lbrace
   \begin{array}{rcl}
   \int_\Omega \partial_t \alpha_q(t,x) \varphi_q(x) {\rm d}x &=& \int_\Omega {\rm grad} \left( e_p(t,x) \right) \cdot \varphi_q(x) {\rm d}x, \\
   \int_\Omega \partial_t \alpha_p(t,x) \varphi_p(x) {\rm d}x &=& \int_\Omega {\rm div} \left( e_q(t,x) \right) \varphi_p(x) {\rm d}x, \\
   \left\langle y_N, \psi_N \right\rangle_{\Gamma_N} &=& \left\langle e_p, \psi_N \right\rangle_{\Gamma_N}, \\
   \left\langle u_D, \psi_D \right\rangle_{\Gamma_D} &=& \left\langle e_p, \psi_D \right\rangle_{\Gamma_D}.
   \end{array}
   \right.\end{split}
\end{equation}
\sphinxAtStartPar
Integrating by parts the second line make the control \(u_N\) and
the observation \(y_D\) appear
\begin{equation*}
\begin{split}\int_\Omega \partial_t \alpha_p(t,x) \varphi_p(x) {\rm d}x = - \int_\Omega e_q(t,x) \cdot {\rm grad} \left( \varphi_p(x) \right) {\rm d}x + \left\langle \varphi_p, u_N \right\rangle_{\Gamma_N} + \left\langle \varphi_p, y_D \right\rangle_{\Gamma_D}.\end{split}
\end{equation*}
\sphinxAtStartPar
Now, let \((\varphi_q^i)_{1 \le i \le N_q} \subset L^2(\Omega)\) and
\((\varphi_p^k)_{1 \le k \le N_p} \subset H^1(\Omega)\) be two
finite families of approximations for the \(q\)\sphinxhyphen{}type port and the
\(p\)\sphinxhyphen{}type port respectively, typically discontinuous and continuous
Galerkin finite elements respectively. Denote also
\((\psi_N^m)_{1 \le m_N \le N_N} \subset H^{\frac12}(\Gamma_N)\) and
\((\psi_D^m)_{1 \le m_D \le N_D} \subset H^{\frac12}(\Gamma_D)\). In
particular, the latter choices imply that the duality brackets at the
boundary reduce to simple \(L^2\) scalar products.

\sphinxAtStartPar
Writing the discrete weak formulation with those families, one has for
all \(1 \le i \le N_q\), all \(1 \le k \le N_p\), all
\(1 \le m_N \le N_N\) and all \(1 \le m_D \le N_D\)
\begin{equation}\label{equation:examples/wave:weak-form-IBP}
\begin{split}   \left\lbrace
   \begin{array}{rcl}
   \sum_{j=1}^{N_q} \int_\Omega \varphi_q^j(x) \varphi_q^i(x) {\rm d}x \, \frac{\rm d}{{\rm d}t} \alpha_q^j(t) &=& \sum_{\ell=1}^{N_p} \int_\Omega {\rm grad} \left( \varphi_p^\ell(x) \right) \cdot \varphi_q^i(x) {\rm d}x \, e_p^\ell(t), \\
   \sum_{\ell=1}^{N_p} \int_\Omega \varphi_p^\ell(x) \varphi_p^k(x) {\rm d}x \, \frac{\rm d}{{\rm d}t} \alpha_p^\ell(t) &=& - \sum_{j=1}^{N_q} \int_\Omega \varphi_q^j(x) \cdot {\rm grad} \left( \varphi_p^k(x) \right) {\rm d}x \, e_q^j(t) \\
   && \quad + \sum_{n_N=1}^{N_N} \int_{\Gamma_N} \varphi_p^k(s) \psi_N^{n_N}(s) {\rm d}s \, u_N^{n_N}(t) \\
   && \qquad + \sum_{n_D=1}^{N_D} \int_{\Gamma_D} \varphi_p^k(s) \psi_D^{n_D}(s) {\rm d}s \, y_D^{n_D}(t), \\
   \sum_{n_N=1}^{N_N} \left\langle \psi_N^{n_N}, \psi_N^{m_N} \right\rangle_{\Gamma_N} \, y_N^{n_N}(t) &=& \sum_{\ell=1}^{N_p} \int_{\Gamma_N} \varphi_p^\ell(s) \psi_N^{m_N}(s) {\rm d}s \, e_p^\ell(t), \\
   \sum_{n_D=1}^{N_D} \left\langle \psi_D^{n_D}, \psi_D^{m_D} \right\rangle_{\Gamma_D} \, u_D^{n_D}(t) &=& \sum_{\ell=1}^{N_p} \int_{\Gamma_D} \varphi_p^\ell(s) \psi_D^{m_D}(s) {\rm d}s \, e_p^\ell(t),
   \end{array}
   \right.\end{split}
\end{equation}
\sphinxAtStartPar
which rewrites in matrix form
\begin{equation*}
\begin{split}\underbrace{\begin{bmatrix}
M_q & 0 & 0 & 0 \\
0 & M_p & 0 & 0 \\
0 & 0 & M_N & 0 \\
0 & 0 & 0 & M_D
\end{bmatrix}}_{= M}
\begin{pmatrix}
\frac{\rm d}{{\rm d}t} \underline{\alpha_q}(t) \\
\frac{\rm d}{{\rm d}t} \underline{\alpha_p}(t) \\
-\underline{y_N}(t) \\
\underline{u_D}(t)
\end{pmatrix}
=
\underbrace{\begin{bmatrix}
0 & D & 0 & 0 \\
-D^\top & 0 & B_N & -B_D^T \\
0 & -B_N^\top & 0 & 0 \\
0 & B_D & 0 & 0
\end{bmatrix}}_{= J}
\begin{pmatrix}
\underline{e_q}(t) \\
\underline{e_p}(t) \\
\underline{u_N}(t) \\
-\underline{y_D}(t)
\end{pmatrix},\end{split}
\end{equation*}
\sphinxAtStartPar
where
\(\underline{\star}(t) := \begin{pmatrix} \star^1(t) & \cdots & \star^{N_\star} \end{pmatrix}^\top\)
and
\begin{equation}\label{equation:examples/wave:weak-form-matrices-1}
\begin{split}   (M_q)_{ij} := \int_\Omega \varphi_q^j(x) \cdot \varphi_q^i(x) {\rm d}x,
   \qquad
   (M_p)_{k\ell} := \int_\Omega \varphi_p^\ell(x) \varphi_p^k(x) {\rm d}x,\end{split}
\end{equation}\begin{equation}\label{equation:examples/wave:weak-form-matrices-2}
\begin{split}   (M_N)_{m_Nn_N} := \int_{\Gamma_N} \psi_N^{n_N}(s) \psi_N^{m_N}(s) {\rm d}s,
   \qquad
   (M_D)_{m_Dn_D} := \int_{\Gamma_D} \psi_D^{n_D}(s) \psi_D^{m_D}(s) {\rm d}s,\end{split}
\end{equation}\begin{equation*}
\begin{split}(D)_{i\ell} := \int_\Omega {\rm grad} \left( \varphi_p^\ell(x) \right) \cdot \varphi_q^i(x) {\rm d}x,\end{split}
\end{equation*}\begin{equation*}
\begin{split}(B_N)_{n_Nk} := \int_{\Gamma_N} \varphi_p^k(s) \psi_N^{n_N}(s) {\rm d}s,
\qquad
(B_D)_{m_D\ell} := \int_{\Gamma_D} \varphi_p^\ell(s) \psi_D^{m_D}(s) {\rm d}s,\end{split}
\end{equation*}
\sphinxAtStartPar
Now one can approximate the \sphinxstylestrong{constitutive relations} in those families
by projection of their weak formulations
\begin{equation*}
\begin{split}\left\lbrace
\begin{array}{rcl}
\int_\Omega e_q(t,x) \cdot \varphi_q(x) {\rm d}x &=& \int_\Omega \alpha_q(t,x) \cdot T(x) \cdot \varphi_q(x) {\rm d}x, \\
\int_\Omega e_p(t,x) \varphi_p(x) {\rm d}x &=&  \int_\Omega \frac{\alpha_p(t,x)}{\rho(x)} \varphi_p(x) {\rm d}x,
\end{array}
\right.\end{split}
\end{equation*}
\sphinxAtStartPar
from which one can deduce the matrix form of the discrete weak
formulation of the constitutive relation
\begin{equation*}
\begin{split}\left\lbrace
\begin{array}{rcl}
M_q \underline{e_q}(t) &=& M_T \underline{\alpha_q}(t), \\
M_p \underline{e_p}(t) &=& M_\rho \underline{\alpha_p}(t),
\end{array}
\right.\end{split}
\end{equation*}
\sphinxAtStartPar
where
\begin{equation}\label{equation:examples/wave:weak-form-matrices-3}
\begin{split}   (M_T)_{ij} := \int_\Omega \varphi_q^j(x) \cdot T(x) \cdot \varphi_q^i(x) {\rm d}x,
   \qquad
   (M_\rho)_{k\ell} := \int_\Omega \frac{\varphi_p^\ell(x)}{\rho(x)} \varphi_p^k(x) {\rm d}x.\end{split}
\end{equation}
\sphinxAtStartPar
Finally, the \sphinxstylestrong{discrete Hamiltonian} \(\mathcal{H}^d\) is defined
as the evaluation of \(\mathcal{H}\) on the approximation of the
\sphinxstylestrong{state variables}
\begin{equation*}
\begin{split}\mathcal{H}^d(t) := \mathcal{H}(\alpha_q^d(t,x), \alpha_p^d(t)) = \frac{1}{2} \underline{\alpha_q}(t)^\top M_T \underline{\alpha_q}(t) + \frac{1}{2} \underline{\alpha_p}(t)^\top M_\rho \underline{\alpha_p}(t).\end{split}
\end{equation*}
\sphinxAtStartPar
The \sphinxstylestrong{discrete power balance} is then easily deduced from the above
matrix formulations, thanks to the symmetry of \(M\) and the
skew\sphinxhyphen{}symmetry of \(J\)
\begin{equation*}
\begin{split}\frac{\rm d}{{\rm d}t} \mathcal{H}^d(t) = \underline{y_N}(t)^\top M_N \underline{u_N}(t) + \underline{u_D}(t)^\top M_D \underline{y_D}(t).\end{split}
\end{equation*}

\subsubsection{Simulation}
\label{\detokenize{examples/wave:simulation}}
\sphinxAtStartPar
Let us start by importing the scrimp package

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{} Import scrimp}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{scrimp}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{S}
\end{sphinxVerbatim}

\sphinxAtStartPar
Now define a real Distributed Port\sphinxhyphen{}Hamiltonian System

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{} Init the distributed port\PYGZhy{}Hamiltonian system}
\PYG{n}{wave} \PYG{o}{=} \PYG{n}{S}\PYG{o}{.}\PYG{n}{DPHS}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{real}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\end{sphinxVerbatim}

\sphinxAtStartPar
The domain is 2\sphinxhyphen{}dimensional, and is a rectangle of length 2 and width 1.
We use the built\sphinxhyphen{}in geometry \sphinxcode{\sphinxupquote{Rectangle}} and choose a mesh size
parameter of 0.1 with the following command.

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{} Set the domain (using the built\PYGZhy{}in geometry `Rectangle`)}
\PYG{c+c1}{\PYGZsh{} Labels: Omega = 1, Gamma\PYGZus{}Bottom = 10, Gamma\PYGZus{}Right = 11, Gamma\PYGZus{}Top = 12, Gamma\PYGZus{}Left = 13}
\PYG{n}{rectangle} \PYG{o}{=} \PYG{n}{S}\PYG{o}{.}\PYG{n}{Domain}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Rectangle}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{p}{\PYGZob{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{L}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+m+mf}{2.0}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{l}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+m+mf}{1.0}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{h}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+m+mf}{0.1}\PYG{p}{\PYGZcb{}}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} And add it to the dphs}
\PYG{n}{wave}\PYG{o}{.}\PYG{n}{set\PYGZus{}domain}\PYG{p}{(}\PYG{n}{rectangle}\PYG{p}{)}
\end{sphinxVerbatim}

\sphinxAtStartPar
Defining the states and co\sphinxhyphen{}states, care must be taken: the Strain is a
\sphinxstylestrong{vector\sphinxhyphen{}field}.

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{} Define the variables and their discretizations}
\PYG{n}{states} \PYG{o}{=} \PYG{p}{[}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{State}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{q}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Strain}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{vector\PYGZhy{}field}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{State}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{p}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Linear momentum}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{scalar\PYGZhy{}field}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}
\PYG{p}{]}
\PYG{n}{costates} \PYG{o}{=} \PYG{p}{[}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{CoState}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{e\PYGZus{}q}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Stress}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{states}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{)}\PYG{p}{,}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{CoState}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{e\PYGZus{}p}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Velocity}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{states}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{)}\PYG{p}{,}
\PYG{p}{]}

\PYG{c+c1}{\PYGZsh{} Add them to the dphs}
\PYG{k}{for} \PYG{n}{state} \PYG{o+ow}{in} \PYG{n}{states}\PYG{p}{:}
    \PYG{n}{wave}\PYG{o}{.}\PYG{n}{add\PYGZus{}state}\PYG{p}{(}\PYG{n}{state}\PYG{p}{)}
\PYG{k}{for} \PYG{n}{costate} \PYG{o+ow}{in} \PYG{n}{costates}\PYG{p}{:}
    \PYG{n}{wave}\PYG{o}{.}\PYG{n}{add\PYGZus{}costate}\PYG{p}{(}\PYG{n}{costate}\PYG{p}{)}
\end{sphinxVerbatim}

\sphinxAtStartPar
As the domain is the built\sphinxhyphen{}in geometry \sphinxcode{\sphinxupquote{Rectangle}}, the boundary is
composed of four parts, with indices 10, 11, 12 and 13, respectively for
the lower, right, upper and left edge. Each of them will have its own
control port, allowing \sphinxstyleemphasis{e.g.} \sphinxstylestrong{mixed} boundary conditions.

\sphinxAtStartPar
Indeed in the above example, we choose Neumann boundary condition on
\(\Gamma_N\), \sphinxstyleemphasis{i.e.} on 10, 11 and 12, while we choose Dirichlet
boundary condition on \(\Gamma_D\), \sphinxstyleemphasis{i.e.} on 13.

\sphinxAtStartPar
The choice to integrate by part the second line of \eqref{equation:examples/wave:weak-form} has
a consequence for the port at boundary 13, as it is then in the \sphinxstyleemphasis{flow}
part of the Dirac structure, as can be seen in \eqref{equation:examples/wave:weak-form-IBP}. We
indicate this using the keyword \sphinxcode{\sphinxupquote{position="flow"}}.

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{} Define the control ports}
\PYG{n}{control\PYGZus{}ports} \PYG{o}{=} \PYG{p}{[}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{Control\PYGZus{}Port}\PYG{p}{(}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Boundary control (bottom)}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{U\PYGZus{}B}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Normal force}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Y\PYGZus{}B}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Velocity trace}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{scalar\PYGZhy{}field}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{n}{region}\PYG{o}{=}\PYG{l+m+mi}{10}\PYG{p}{,}
    \PYG{p}{)}\PYG{p}{,}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{Control\PYGZus{}Port}\PYG{p}{(}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Boundary control (right)}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{U\PYGZus{}R}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Normal force}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Y\PYGZus{}R}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Velocity trace}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{scalar\PYGZhy{}field}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{n}{region}\PYG{o}{=}\PYG{l+m+mi}{11}\PYG{p}{,}
    \PYG{p}{)}\PYG{p}{,}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{Control\PYGZus{}Port}\PYG{p}{(}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Boundary control (top)}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{U\PYGZus{}T}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Normal force}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Y\PYGZus{}T}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Velocity trace}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{scalar\PYGZhy{}field}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{n}{region}\PYG{o}{=}\PYG{l+m+mi}{12}\PYG{p}{,}
    \PYG{p}{)}\PYG{p}{,}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{Control\PYGZus{}Port}\PYG{p}{(}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Boundary control (left)}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{U\PYGZus{}L}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Velocity trace}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Y\PYGZus{}L}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Normal force}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{scalar\PYGZhy{}field}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{n}{region}\PYG{o}{=}\PYG{l+m+mi}{13}\PYG{p}{,}
        \PYG{n}{position}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{flow}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
    \PYG{p}{)}\PYG{p}{,}
\PYG{p}{]}

\PYG{c+c1}{\PYGZsh{} Add them to the dphs}
\PYG{k}{for} \PYG{n}{ctrl\PYGZus{}port} \PYG{o+ow}{in} \PYG{n}{control\PYGZus{}ports}\PYG{p}{:}
    \PYG{n}{wave}\PYG{o}{.}\PYG{n}{add\PYGZus{}control\PYGZus{}port}\PYG{p}{(}\PYG{n}{ctrl\PYGZus{}port}\PYG{p}{)}
\end{sphinxVerbatim}

\sphinxAtStartPar
The choice for the finite element families is often the first difficulty
of a simulation. Indeed, it can result in a failing time scheme, or a
very instable solution. A key\sphinxhyphen{}point to take a first decision is to
remember which field needs regularity (in the \(L^2\)\sphinxhyphen{}sense) in the
Dirac structure. In our case, the \(p\)\sphinxhyphen{}type variables should be at
least \(H^1(\Omega)\), as can be inferred from \eqref{equation:examples/wave:weak-form-IBP}.
Hence, a first choice for the \(p\)\sphinxhyphen{}type variables is to take
continuous Galerkin finite elements of order \(k\). Since the time
derivative of \(q\) will be, more or less, a gradient of a
\(p\)\sphinxhyphen{}type variable, it will be a discontinuous Galerkin of order
\(k-1\) approximation. Finally, at least one trace of these
variables, either the control, or the observation, is at most a
discontinuous Galerkin of order \(k-1\) approximation. Hence the
following choices, with \(k=2\).

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{} Define the Finite Elements Method of each port}
\PYG{n}{FEMs} \PYG{o}{=} \PYG{p}{[}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{FEM}\PYG{p}{(}\PYG{n}{states}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{get\PYGZus{}name}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{DG}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{FEM}\PYG{p}{(}\PYG{n}{states}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{get\PYGZus{}name}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{CG}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{FEM}\PYG{p}{(}\PYG{n}{control\PYGZus{}ports}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{get\PYGZus{}name}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{DG}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{FEM}\PYG{p}{(}\PYG{n}{control\PYGZus{}ports}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{get\PYGZus{}name}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{DG}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{FEM}\PYG{p}{(}\PYG{n}{control\PYGZus{}ports}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{]}\PYG{o}{.}\PYG{n}{get\PYGZus{}name}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{DG}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{FEM}\PYG{p}{(}\PYG{n}{control\PYGZus{}ports}\PYG{p}{[}\PYG{l+m+mi}{3}\PYG{p}{]}\PYG{o}{.}\PYG{n}{get\PYGZus{}name}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{DG}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}
\PYG{p}{]}

\PYG{c+c1}{\PYGZsh{} Add them to the dphs}
\PYG{k}{for} \PYG{n}{FEM} \PYG{o+ow}{in} \PYG{n}{FEMs}\PYG{p}{:}
    \PYG{n}{wave}\PYG{o}{.}\PYG{n}{add\PYGZus{}FEM}\PYG{p}{(}\PYG{n}{FEM}\PYG{p}{)}
\end{sphinxVerbatim}

\sphinxAtStartPar
We can assume anisotropy and heterogeneity in our model by defining the
parameters as follows. It has to be kept in mind that a parameter is
always linked to a port (\sphinxstyleemphasis{i.e.}, to a pair \sphinxstyleemphasis{flow\sphinxhyphen{}effort}). In
particular, a parameter linked to a port that is a vector\sphinxhyphen{}field, should
be a \sphinxstylestrong{tensor\sphinxhyphen{}field}.

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{} Define physical parameters}
\PYG{n}{parameters} \PYG{o}{=} \PYG{p}{[}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{Parameter}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{T}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Young}\PYG{l+s+s2}{\PYGZsq{}}\PYG{l+s+s2}{s modulus}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{tensor\PYGZhy{}field}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{[[5+x,x*y],[x*y,2+y]]}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{q}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{Parameter}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{rho}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Mass density}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{scalar\PYGZhy{}field}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{3\PYGZhy{}x}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{p}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}
\PYG{p}{]}

\PYG{c+c1}{\PYGZsh{} Add them to the dphs}
\PYG{k}{for} \PYG{n}{parameter} \PYG{o+ow}{in} \PYG{n}{parameters}\PYG{p}{:}
    \PYG{n}{wave}\PYG{o}{.}\PYG{n}{add\PYGZus{}parameter}\PYG{p}{(}\PYG{n}{parameter}\PYG{p}{)}
\end{sphinxVerbatim}

\sphinxAtStartPar
It is time to define the bricks of our model, \sphinxstyleemphasis{i.e.} the block matrices
of our discretization, providing the weak forms given in
\eqref{equation:examples/wave:weak-form-matrices-1}, \eqref{equation:examples/wave:weak-form-matrices-2}, and
\eqref{equation:examples/wave:weak-form-matrices-3}.

\sphinxAtStartPar
This is probably the most difficult part of the process, and care must
be taken. Remember that the syntax is the Generic Weak\sphinxhyphen{}Form Language
(GWFL), for which an on\sphinxhyphen{}line documentation exists on the \sphinxhref{https://getfem.org/userdoc/gasm\_high.html?highlight=gwfl}{GetFEM
site}.

\sphinxAtStartPar
For the block matrices appearing against time derivative of a variable,
it is crucial not to forget the keyword \sphinxcode{\sphinxupquote{dt=True}}.

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{} Define the pHs via `Brick` == non\PYGZhy{}zero block matrices == variational terms}
\PYG{n}{bricks} \PYG{o}{=} \PYG{p}{[}
    \PYG{c+c1}{\PYGZsh{}\PYGZsh{} Define the Dirac structure}
    \PYG{c+c1}{\PYGZsh{} Define the mass matrices from the left\PYGZhy{}hand side: the `flow` part of the Dirac structure}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{Brick}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{M\PYGZus{}q}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{q.Test\PYGZus{}q}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,} \PYG{n}{dt}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{,} \PYG{n}{position}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{flow}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{Brick}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{M\PYGZus{}p}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{p*Test\PYGZus{}p}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,} \PYG{n}{dt}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{,} \PYG{n}{position}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{flow}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{Brick}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{M\PYGZus{}Y\PYGZus{}B}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Y\PYGZus{}B*Test\PYGZus{}Y\PYGZus{}B}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mi}{10}\PYG{p}{]}\PYG{p}{,} \PYG{n}{position}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{flow}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{Brick}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{M\PYGZus{}Y\PYGZus{}R}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Y\PYGZus{}R*Test\PYGZus{}Y\PYGZus{}R}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mi}{11}\PYG{p}{]}\PYG{p}{,} \PYG{n}{position}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{flow}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{Brick}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{M\PYGZus{}Y\PYGZus{}T}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Y\PYGZus{}T*Test\PYGZus{}Y\PYGZus{}T}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mi}{12}\PYG{p}{]}\PYG{p}{,} \PYG{n}{position}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{flow}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}
    \PYG{c+c1}{\PYGZsh{} The Dirichlet term is applied via Lagrange multiplier == the colocated output}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{Brick}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{M\PYGZus{}Y\PYGZus{}L}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{U\PYGZus{}L*Test\PYGZus{}Y\PYGZus{}L}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mi}{13}\PYG{p}{]}\PYG{p}{,} \PYG{n}{position}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{flow}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}
    \PYG{c+c1}{\PYGZsh{} Define the matrices from the right\PYGZhy{}hand side: the `effort` part of the Dirac structure}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{Brick}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{D}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Grad(e\PYGZus{}p).Test\PYGZus{}q}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,} \PYG{n}{position}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{effort}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{Brick}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{\PYGZhy{}D\PYGZca{}T}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{\PYGZhy{}e\PYGZus{}q.Grad(Test\PYGZus{}p)}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,} \PYG{n}{position}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{effort}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{Brick}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{B\PYGZus{}B}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{U\PYGZus{}B*Test\PYGZus{}p}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mi}{10}\PYG{p}{]}\PYG{p}{,} \PYG{n}{position}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{effort}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{Brick}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{B\PYGZus{}R}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{U\PYGZus{}R*Test\PYGZus{}p}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mi}{11}\PYG{p}{]}\PYG{p}{,} \PYG{n}{position}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{effort}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{Brick}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{B\PYGZus{}T}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{U\PYGZus{}T*Test\PYGZus{}p}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mi}{12}\PYG{p}{]}\PYG{p}{,} \PYG{n}{position}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{effort}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}
    \PYG{c+c1}{\PYGZsh{} The Dirichlet term is applied via Lagrange multiplier == the colocated output}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{Brick}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{B\PYGZus{}L}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Y\PYGZus{}L*Test\PYGZus{}p}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mi}{13}\PYG{p}{]}\PYG{p}{,} \PYG{n}{position}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{effort}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{Brick}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{C\PYGZus{}B}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{\PYGZhy{}e\PYGZus{}p*Test\PYGZus{}Y\PYGZus{}B}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mi}{10}\PYG{p}{]}\PYG{p}{,} \PYG{n}{position}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{effort}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{Brick}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{C\PYGZus{}R}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{\PYGZhy{}e\PYGZus{}p*Test\PYGZus{}Y\PYGZus{}R}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mi}{11}\PYG{p}{]}\PYG{p}{,} \PYG{n}{position}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{effort}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{Brick}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{C\PYGZus{}T}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{\PYGZhy{}e\PYGZus{}p*Test\PYGZus{}Y\PYGZus{}T}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mi}{12}\PYG{p}{]}\PYG{p}{,} \PYG{n}{position}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{effort}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{Brick}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{C\PYGZus{}L}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{\PYGZhy{}e\PYGZus{}p*Test\PYGZus{}Y\PYGZus{}L}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mi}{13}\PYG{p}{]}\PYG{p}{,} \PYG{n}{position}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{effort}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}
    \PYG{c+c1}{\PYGZsh{}\PYGZsh{} Define the constitutive relations}
    \PYG{c+c1}{\PYGZsh{} Hooke\PYGZsq{}s law under implicit form `\PYGZhy{} M\PYGZus{}e\PYGZus{}q e\PYGZus{}q + CR\PYGZus{}q q = 0`}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{Brick}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{\PYGZhy{}M\PYGZus{}e\PYGZus{}q}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{\PYGZhy{}e\PYGZus{}q.Test\PYGZus{}e\PYGZus{}q}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{)}\PYG{p}{,}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{Brick}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{CR\PYGZus{}q}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{q.T.Test\PYGZus{}e\PYGZus{}q}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{)}\PYG{p}{,}
    \PYG{c+c1}{\PYGZsh{} Linear momentum definition under implicit form `\PYGZhy{} M\PYGZus{}e\PYGZus{}p e\PYGZus{}p + CR\PYGZus{}p p = 0`}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{Brick}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{\PYGZhy{}M\PYGZus{}e\PYGZus{}p}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{\PYGZhy{}e\PYGZus{}p*Test\PYGZus{}e\PYGZus{}p}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{)}\PYG{p}{,}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{Brick}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{CR\PYGZus{}p}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{p/rho*Test\PYGZus{}e\PYGZus{}p}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{)}\PYG{p}{,}
\PYG{p}{]}

\PYG{c+c1}{\PYGZsh{} Add all these `Bricks` to the dphs}
\PYG{k}{for} \PYG{n}{brick} \PYG{o+ow}{in} \PYG{n}{bricks}\PYG{p}{:}
    \PYG{n}{wave}\PYG{o}{.}\PYG{n}{add\PYGZus{}brick}\PYG{p}{(}\PYG{n}{brick}\PYG{p}{)}
\end{sphinxVerbatim}

\sphinxAtStartPar
The last step is to initialize the dphs, by providing the control
functions and the initial values for \(q\) and \(p\) (\sphinxstyleemphasis{i.e.},
the variables that are derivated in time in the model).

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{}\PYGZsh{} Initialize the problem}
\PYG{c+c1}{\PYGZsh{} The controls expression, ordered as the control\PYGZus{}ports}
\PYG{n}{t\PYGZus{}f} \PYG{o}{=} \PYG{l+m+mf}{5.0}
\PYG{n}{expressions} \PYG{o}{=} \PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{0.}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{0.}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{0.}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{0.1*sin(4.*t)*sin(4*pi*y)*exp(\PYGZhy{}10.*pow((0.5*}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{t\PYGZus{}f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZhy{}t),2))}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}

\PYG{c+c1}{\PYGZsh{} Add each expression to its control\PYGZus{}port}
\PYG{k}{for} \PYG{n}{control\PYGZus{}port}\PYG{p}{,} \PYG{n}{expression} \PYG{o+ow}{in} \PYG{n+nb}{zip}\PYG{p}{(}\PYG{n}{control\PYGZus{}ports}\PYG{p}{,} \PYG{n}{expressions}\PYG{p}{)}\PYG{p}{:}
    \PYG{c+c1}{\PYGZsh{} Set the control functions: it automatically constructs the related `Brick`s such that `\PYGZhy{} M\PYGZus{}u u + f(t) = 0`}
    \PYG{n}{wave}\PYG{o}{.}\PYG{n}{set\PYGZus{}control}\PYG{p}{(}\PYG{n}{control\PYGZus{}port}\PYG{o}{.}\PYG{n}{get\PYGZus{}name}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,} \PYG{n}{expression}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Set the initial data}
\PYG{n}{q\PYGZus{}0} \PYG{o}{=} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{[0., 0.]}\PYG{l+s+s2}{\PYGZdq{}}
\PYG{n}{wave}\PYG{o}{.}\PYG{n}{set\PYGZus{}initial\PYGZus{}value}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{q}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{q\PYGZus{}0}\PYG{p}{)}
\PYG{n}{p\PYGZus{}0} \PYG{o}{=} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{3**(\PYGZhy{}20*((x\PYGZhy{}0.5)*(x\PYGZhy{}0.5)+(y\PYGZhy{}0.5)*(y\PYGZhy{}0.5)))}\PYG{l+s+s2}{\PYGZdq{}}
\PYG{n}{wave}\PYG{o}{.}\PYG{n}{set\PYGZus{}initial\PYGZus{}value}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{p}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{p\PYGZus{}0}\PYG{p}{)}
\end{sphinxVerbatim}

\sphinxAtStartPar
It remains to solve!

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{}\PYGZsh{} Solve in time}
\PYG{c+c1}{\PYGZsh{} Define the time scheme (\PYGZdq{}cn\PYGZdq{} is Crank\PYGZhy{}Nicolson)}
\PYG{n}{wave}\PYG{o}{.}\PYG{n}{set\PYGZus{}time\PYGZus{}scheme}\PYG{p}{(}\PYG{n}{ts\PYGZus{}type}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{cn}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
                     \PYG{n}{t\PYGZus{}f}\PYG{o}{=}\PYG{n}{t\PYGZus{}f}\PYG{p}{,}
                     \PYG{n}{dt\PYGZus{}save}\PYG{o}{=}\PYG{l+m+mf}{0.01}\PYG{p}{,}
                     \PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Solve}
\PYG{n}{wave}\PYG{o}{.}\PYG{n}{solve}\PYG{p}{(}\PYG{p}{)}
\end{sphinxVerbatim}

\sphinxAtStartPar
Now we can set the Hamiltonian and plot it.

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{}\PYGZsh{} Post\PYGZhy{}processing}
\PYG{c+c1}{\PYGZsh{} Set Hamiltonian\PYGZsq{}s name}
\PYG{n}{wave}\PYG{o}{.}\PYG{n}{hamiltonian}\PYG{o}{.}\PYG{n}{set\PYGZus{}name}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Mechanical energy}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{c+c1}{\PYGZsh{} Define each Hamiltonian Term}
\PYG{n}{terms} \PYG{o}{=} \PYG{p}{[}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{Term}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Potential energy}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{0.5*q.T.q}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{)}\PYG{p}{,}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{Term}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Kinetic energy}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{0.5*p*p/rho}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{)}\PYG{p}{,}
\PYG{p}{]}
\PYG{c+c1}{\PYGZsh{} Add them to the Hamiltonian}
\PYG{k}{for} \PYG{n}{term} \PYG{o+ow}{in} \PYG{n}{terms}\PYG{p}{:}
    \PYG{n}{wave}\PYG{o}{.}\PYG{n}{hamiltonian}\PYG{o}{.}\PYG{n}{add\PYGZus{}term}\PYG{p}{(}\PYG{n}{term}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Plot the Hamiltonian and save the output}
\PYG{n}{wave}\PYG{o}{.}\PYG{n}{plot\PYGZus{}Hamiltonian}\PYG{p}{(}\PYG{n}{save\PYGZus{}figure}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{,} \PYG{n}{filename}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Hamiltonian\PYGZus{}Wave\PYGZus{}2D\PYGZus{}Conservative.png}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\end{sphinxVerbatim}

\noindent\sphinxincludegraphics{{Wave_Hamiltonian_conservative}.png}


\subsubsection{Adding Damping to the dphs}
\label{\detokenize{examples/wave:adding-damping-to-the-dphs}}
\sphinxAtStartPar
The remining part of the notebook is focused on the way to deal with
\sphinxstyleemphasis{dissipativity}, hence using an \sphinxstylestrong{algebraic port}.

\sphinxAtStartPar
Let us come back to the continuous system. Adding a (fluid) damping
consists in an additive term in Newton second law, which is proportional
to the velocity (in the linear case). More precisely, denoting
\(\nu\ge0\) the viscous parameter, one has:
\begin{equation*}
\begin{split}\rho(x) \partial_{tt}^2 w(t,x) - {\rm div} \left( T(x) \cdot {\rm grad} \left( w(t,x) \right) \right) + \nu(x) \partial_t w(t,x) = 0.\end{split}
\end{equation*}
\sphinxAtStartPar
Using the framework of port\sphinxhyphen{}Hamiltonian system, this rewrites:
\begin{equation*}
\begin{split}\begin{pmatrix} \partial_t \alpha_q \\ \partial_t \alpha_p \end{pmatrix}
=
\begin{bmatrix} 0 & {\rm grad} \\ {\rm div} & 0 \end{bmatrix}
\begin{pmatrix} e_q \\ e_p \end{pmatrix}
+
\begin{pmatrix} 0 \\ - \nu e_p \end{pmatrix}.\end{split}
\end{equation*}
\sphinxAtStartPar
One could include \(-\nu\) inside the matrix of operators, this is
the so\sphinxhyphen{}called \(J-R\) framework. However, it does not exhibit the
underlying Dirac structure, as it hides the resistive port. Let us
introduce this hidden port, by denoting \(f_r\) the flow and
\(e_r\) the effort, as follows:
\begin{equation}\label{equation:examples/wave:with-diss}
\begin{split}   \begin{pmatrix} \partial_t \alpha_q \\ \partial_t \alpha_p \\ f_r \end{pmatrix}
   =
   \begin{bmatrix} 0 & {\rm grad} & 0 \\ {\rm div} & 0 & -I \\ 0 & I^\top & 0 \end{bmatrix}
   \begin{pmatrix} e_q \\ e_p \\ e_r \end{pmatrix},\end{split}
\end{equation}
\sphinxAtStartPar
and supplemented by the resistive constitutive relation
\(e_r = \nu f_r\).

\sphinxAtStartPar
Of course, at the discrete level, this will increase the number of
degrees of freedom, as two extra variables have to be discretized.
Nevertheless, in more complicated situations (\sphinxstyleemphasis{e.g.} dealing with
non\sphinxhyphen{}linearities), this is the price to pay to recover a correct discrete
power balance.

\sphinxAtStartPar
The \sphinxstylestrong{power balance} satisfied by the \sphinxstylestrong{Hamiltonian} is then
\begin{equation*}
\begin{split}\frac{\rm d}{{\rm d}t} \mathcal{H}(t) = \underbrace{-\int_\Omega \nu(x) f_r^2(t,x)}_{\text{dissipated power}} \underbrace{+ \left\langle y_N(t,\cdot), u_N(t,\cdot)\right\rangle_{\Gamma_N}}_{\text{power flowing through }\Gamma_N} \underbrace{+ \left\langle u_D(t,\cdot), y_D(t,\cdot) \right\rangle_{\Gamma_D}}_{\text{power flowing through }\Gamma_D},\end{split}
\end{equation*}

\subsubsection{Another simulation}
\label{\detokenize{examples/wave:another-simulation}}
\sphinxAtStartPar
Let us start a new simulation with damping.

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{} Define a new dphs}
\PYG{n}{wave\PYGZus{}diss} \PYG{o}{=} \PYG{n}{S}\PYG{o}{.}\PYG{n}{DPHS}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{real}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Set the domain (using the built\PYGZhy{}in geometry `Rectangle`)}
\PYG{c+c1}{\PYGZsh{} Labels: Omega = 1, Gamma\PYGZus{}Bottom = 10, Gamma\PYGZus{}Right = 11, Gamma\PYGZus{}Top = 12, Gamma\PYGZus{}Left = 13}
\PYG{n}{rectangle} \PYG{o}{=} \PYG{n}{S}\PYG{o}{.}\PYG{n}{Domain}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Rectangle}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{p}{\PYGZob{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{L}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+m+mf}{2.0}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{l}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+m+mf}{1.0}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{h}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+m+mf}{0.1}\PYG{p}{\PYGZcb{}}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} On the rectangle domain}
\PYG{n}{wave\PYGZus{}diss}\PYG{o}{.}\PYG{n}{set\PYGZus{}domain}\PYG{p}{(}\PYG{n}{rectangle}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Define the variables}
\PYG{n}{states} \PYG{o}{=} \PYG{p}{[}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{State}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{q}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Strain}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{vector\PYGZhy{}field}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{State}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{p}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Linear momentum}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{scalar\PYGZhy{}field}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}
\PYG{p}{]}
\PYG{n}{costates} \PYG{o}{=} \PYG{p}{[}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{CoState}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{e\PYGZus{}q}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Stress}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{states}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{)}\PYG{p}{,}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{CoState}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{e\PYGZus{}p}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Velocity}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{states}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{)}\PYG{p}{,}
\PYG{p}{]}

\PYG{c+c1}{\PYGZsh{} Add them to the dphs}
\PYG{k}{for} \PYG{p}{(}\PYG{n}{state}\PYG{p}{,}\PYG{n}{costate}\PYG{p}{)} \PYG{o+ow}{in} \PYG{n+nb}{zip}\PYG{p}{(}\PYG{n}{states}\PYG{p}{,}\PYG{n}{costates}\PYG{p}{)}\PYG{p}{:}
    \PYG{n}{wave\PYGZus{}diss}\PYG{o}{.}\PYG{n}{add\PYGZus{}state}\PYG{p}{(}\PYG{n}{state}\PYG{p}{)}
    \PYG{n}{wave\PYGZus{}diss}\PYG{o}{.}\PYG{n}{add\PYGZus{}costate}\PYG{p}{(}\PYG{n}{costate}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Define the control ports}
\PYG{n}{control\PYGZus{}ports} \PYG{o}{=} \PYG{p}{[}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{Control\PYGZus{}Port}\PYG{p}{(}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Boundary control (bottom)}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{U\PYGZus{}B}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Normal force}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Y\PYGZus{}B}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Velocity trace}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{scalar\PYGZhy{}field}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{n}{region}\PYG{o}{=}\PYG{l+m+mi}{10}\PYG{p}{,}
    \PYG{p}{)}\PYG{p}{,}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{Control\PYGZus{}Port}\PYG{p}{(}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Boundary control (right)}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{U\PYGZus{}R}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Normal force}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Y\PYGZus{}R}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Velocity trace}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{scalar\PYGZhy{}field}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{n}{region}\PYG{o}{=}\PYG{l+m+mi}{11}\PYG{p}{,}
    \PYG{p}{)}\PYG{p}{,}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{Control\PYGZus{}Port}\PYG{p}{(}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Boundary control (top)}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{U\PYGZus{}T}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Normal force}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Y\PYGZus{}T}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Velocity trace}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{scalar\PYGZhy{}field}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{n}{region}\PYG{o}{=}\PYG{l+m+mi}{12}\PYG{p}{,}
    \PYG{p}{)}\PYG{p}{,}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{Control\PYGZus{}Port}\PYG{p}{(}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Boundary control (left)}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{U\PYGZus{}L}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Velocity trace}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Y\PYGZus{}L}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Normal force}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{scalar\PYGZhy{}field}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{n}{region}\PYG{o}{=}\PYG{l+m+mi}{13}\PYG{p}{,}
        \PYG{n}{position}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{flow}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
    \PYG{p}{)}\PYG{p}{,}
\PYG{p}{]}

\PYG{c+c1}{\PYGZsh{} Add them to the dphs}
\PYG{k}{for} \PYG{n}{ctrl\PYGZus{}port} \PYG{o+ow}{in} \PYG{n}{control\PYGZus{}ports}\PYG{p}{:}
    \PYG{n}{wave\PYGZus{}diss}\PYG{o}{.}\PYG{n}{add\PYGZus{}control\PYGZus{}port}\PYG{p}{(}\PYG{n}{ctrl\PYGZus{}port}\PYG{p}{)}
\end{sphinxVerbatim}

\sphinxAtStartPar
The additional port is defined, added to the system \sphinxcode{\sphinxupquote{wave\_diss}} and a
\sphinxcode{\sphinxupquote{FEM}} is attached to it. Remark that we use the previously defined
objects, \sphinxstyleemphasis{i.e.} we only append the \sphinxcode{\sphinxupquote{FEM}} of the resistive port to the
list of previously defined \sphinxcode{\sphinxupquote{FEM}} objects. We choose continuous
Galerkin of order 2, as the resistive effort is of \(p\)\sphinxhyphen{}type.

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{} Define a dissipative port}
\PYG{n}{port\PYGZus{}diss} \PYG{o}{=} \PYG{n}{S}\PYG{o}{.}\PYG{n}{Port}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Damping}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{f\PYGZus{}r}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{e\PYGZus{}r}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{scalar\PYGZhy{}field}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Add it to the dphs}
\PYG{n}{wave\PYGZus{}diss}\PYG{o}{.}\PYG{n}{add\PYGZus{}port}\PYG{p}{(}\PYG{n}{port\PYGZus{}diss}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Define the Finite Elements Method of each port}
\PYG{n}{FEMs} \PYG{o}{=} \PYG{p}{[}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{FEM}\PYG{p}{(}\PYG{n}{states}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{get\PYGZus{}name}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{DG}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{FEM}\PYG{p}{(}\PYG{n}{states}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{get\PYGZus{}name}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{CG}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{FEM}\PYG{p}{(}\PYG{n}{control\PYGZus{}ports}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{get\PYGZus{}name}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{DG}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{FEM}\PYG{p}{(}\PYG{n}{control\PYGZus{}ports}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{get\PYGZus{}name}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{DG}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{FEM}\PYG{p}{(}\PYG{n}{control\PYGZus{}ports}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{]}\PYG{o}{.}\PYG{n}{get\PYGZus{}name}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{DG}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{FEM}\PYG{p}{(}\PYG{n}{control\PYGZus{}ports}\PYG{p}{[}\PYG{l+m+mi}{3}\PYG{p}{]}\PYG{o}{.}\PYG{n}{get\PYGZus{}name}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{DG}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{FEM}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Damping}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{CG}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}
\PYG{p}{]}

\PYG{c+c1}{\PYGZsh{} Add all of them to the dphs}
\PYG{k}{for} \PYG{n}{FEM} \PYG{o+ow}{in} \PYG{n}{FEMs}\PYG{p}{:}
    \PYG{n}{wave\PYGZus{}diss}\PYG{o}{.}\PYG{n}{add\PYGZus{}FEM}\PYG{p}{(}\PYG{n}{FEM}\PYG{p}{)}
\end{sphinxVerbatim}

\sphinxAtStartPar
The parameter \(\nu\) is obviously linked to the \sphinxcode{\sphinxupquote{Damping}} port.
It can be heterogeneous, as for the other parameters.

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{} Define physical parameters}
\PYG{n}{parameters} \PYG{o}{=} \PYG{p}{[}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{Parameter}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{T}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Young}\PYG{l+s+s2}{\PYGZsq{}}\PYG{l+s+s2}{s modulus}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{tensor\PYGZhy{}field}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{[[5+x,x*y],[x*y,2+y]]}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{q}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{Parameter}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{rho}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Mass density}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{scalar\PYGZhy{}field}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{3\PYGZhy{}x}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{p}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{Parameter}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{nu}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{viscosity}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{scalar\PYGZhy{}field}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{0.5*(2.0\PYGZhy{}x)}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Damping}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}
\PYG{p}{]}

\PYG{c+c1}{\PYGZsh{} Add them to the dphs}
\PYG{k}{for} \PYG{n}{parameter} \PYG{o+ow}{in} \PYG{n}{parameters}\PYG{p}{:}
    \PYG{n}{wave\PYGZus{}diss}\PYG{o}{.}\PYG{n}{add\PYGZus{}parameter}\PYG{p}{(}\PYG{n}{parameter}\PYG{p}{)}
\end{sphinxVerbatim}

\sphinxAtStartPar
Looking at \eqref{equation:examples/wave:with-diss}, only 3 non\sphinxhyphen{}zero block matrices have to be
added to the list of the already constructed bricks, for the Dirac
structure part. And finally, 2 bricks are needed to discretize the resistive constitutive
relation.

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{} Define the pHs via `Brick` == non\PYGZhy{}zero block matrices == variational terms}
\PYG{n}{bricks} \PYG{o}{=} \PYG{p}{[}
    \PYG{c+c1}{\PYGZsh{}\PYGZsh{} Define the Dirac structure}
    \PYG{c+c1}{\PYGZsh{} Define the mass matrices from the left\PYGZhy{}hand side: the `flow` part of the Dirac structure}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{Brick}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{M\PYGZus{}q}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{q.Test\PYGZus{}q}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,} \PYG{n}{dt}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{,} \PYG{n}{position}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{flow}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{Brick}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{M\PYGZus{}p}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{p*Test\PYGZus{}p}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,} \PYG{n}{dt}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{,} \PYG{n}{position}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{flow}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{Brick}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{M\PYGZus{}Y\PYGZus{}B}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Y\PYGZus{}B*Test\PYGZus{}Y\PYGZus{}B}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mi}{10}\PYG{p}{]}\PYG{p}{,} \PYG{n}{position}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{flow}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{Brick}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{M\PYGZus{}Y\PYGZus{}R}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Y\PYGZus{}R*Test\PYGZus{}Y\PYGZus{}R}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mi}{11}\PYG{p}{]}\PYG{p}{,} \PYG{n}{position}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{flow}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{Brick}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{M\PYGZus{}Y\PYGZus{}T}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Y\PYGZus{}T*Test\PYGZus{}Y\PYGZus{}T}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mi}{12}\PYG{p}{]}\PYG{p}{,} \PYG{n}{position}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{flow}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}
    \PYG{c+c1}{\PYGZsh{} Mass matrix}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{Brick}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{M\PYGZus{}r}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{f\PYGZus{}r*Test\PYGZus{}f\PYGZus{}r}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,} \PYG{n}{position}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{flow}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}
    \PYG{c+c1}{\PYGZsh{} The Dirichlet term is applied via Lagrange multiplier == the colocated output}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{Brick}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{M\PYGZus{}Y\PYGZus{}L}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{U\PYGZus{}L*Test\PYGZus{}Y\PYGZus{}L}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mi}{13}\PYG{p}{]}\PYG{p}{,} \PYG{n}{position}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{flow}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}
    \PYG{c+c1}{\PYGZsh{} Define the matrices from the right\PYGZhy{}hand side: the `effort` part of the Dirac structure}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{Brick}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{D}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Grad(e\PYGZus{}p).Test\PYGZus{}q}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,} \PYG{n}{position}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{effort}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{Brick}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{\PYGZhy{}D\PYGZca{}T}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{\PYGZhy{}e\PYGZus{}q.Grad(Test\PYGZus{}p)}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,} \PYG{n}{position}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{effort}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{Brick}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{B\PYGZus{}B}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{U\PYGZus{}B*Test\PYGZus{}p}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mi}{10}\PYG{p}{]}\PYG{p}{,} \PYG{n}{position}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{effort}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{Brick}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{B\PYGZus{}R}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{U\PYGZus{}R*Test\PYGZus{}p}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mi}{11}\PYG{p}{]}\PYG{p}{,} \PYG{n}{position}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{effort}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{Brick}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{B\PYGZus{}T}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{U\PYGZus{}T*Test\PYGZus{}p}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mi}{12}\PYG{p}{]}\PYG{p}{,} \PYG{n}{position}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{effort}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}
    \PYG{c+c1}{\PYGZsh{} The \PYGZdq{}Identity\PYGZdq{} operator}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{Brick}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{I\PYGZus{}r}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{e\PYGZus{}r*Test\PYGZus{}p}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,} \PYG{n}{position}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{effort}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}
    \PYG{c+c1}{\PYGZsh{} Minus its transpose}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{Brick}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{\PYGZhy{}I\PYGZus{}r\PYGZca{}T}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{\PYGZhy{}e\PYGZus{}p*Test\PYGZus{}f\PYGZus{}r}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,} \PYG{n}{position}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{effort}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}
    \PYG{c+c1}{\PYGZsh{} The Dirichlet term is applied via Lagrange multiplier == the colocated output}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{Brick}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{B\PYGZus{}L}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Y\PYGZus{}L*Test\PYGZus{}p}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mi}{13}\PYG{p}{]}\PYG{p}{,} \PYG{n}{position}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{effort}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{Brick}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{C\PYGZus{}B}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{\PYGZhy{}e\PYGZus{}p*Test\PYGZus{}Y\PYGZus{}B}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mi}{10}\PYG{p}{]}\PYG{p}{,} \PYG{n}{position}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{effort}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{Brick}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{C\PYGZus{}R}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{\PYGZhy{}e\PYGZus{}p*Test\PYGZus{}Y\PYGZus{}R}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mi}{11}\PYG{p}{]}\PYG{p}{,} \PYG{n}{position}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{effort}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{Brick}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{C\PYGZus{}T}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{\PYGZhy{}e\PYGZus{}p*Test\PYGZus{}Y\PYGZus{}T}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mi}{12}\PYG{p}{]}\PYG{p}{,} \PYG{n}{position}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{effort}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{Brick}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{C\PYGZus{}L}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{\PYGZhy{}e\PYGZus{}p*Test\PYGZus{}Y\PYGZus{}L}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mi}{13}\PYG{p}{]}\PYG{p}{,} \PYG{n}{position}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{effort}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}
    \PYG{c+c1}{\PYGZsh{}\PYGZsh{} Define the constitutive relations}
    \PYG{c+c1}{\PYGZsh{} Hooke\PYGZsq{}s law under implicit form `\PYGZhy{} M\PYGZus{}e\PYGZus{}q e\PYGZus{}q + CR\PYGZus{}q q = 0`}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{Brick}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{\PYGZhy{}M\PYGZus{}e\PYGZus{}q}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{\PYGZhy{}e\PYGZus{}q.Test\PYGZus{}e\PYGZus{}q}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{)}\PYG{p}{,}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{Brick}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{CR\PYGZus{}q}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{q.T.Test\PYGZus{}e\PYGZus{}q}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{)}\PYG{p}{,}
    \PYG{c+c1}{\PYGZsh{} Linear momentum definition under implicit form `\PYGZhy{} M\PYGZus{}e\PYGZus{}p e\PYGZus{}p + CR\PYGZus{}p p = 0`}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{Brick}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{\PYGZhy{}M\PYGZus{}e\PYGZus{}p}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{\PYGZhy{}e\PYGZus{}p*Test\PYGZus{}e\PYGZus{}p}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{)}\PYG{p}{,}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{Brick}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{CR\PYGZus{}p}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{p/rho*Test\PYGZus{}e\PYGZus{}p}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{)}\PYG{p}{,}
    \PYG{c+c1}{\PYGZsh{} Constitutive relation: linear viscous fluid damping `\PYGZhy{} M\PYGZus{}e\PYGZus{}r e\PYGZus{}r + CR\PYGZus{}r f\PYGZus{}r = 0`}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{Brick}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{\PYGZhy{}M\PYGZus{}e\PYGZus{}r}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{\PYGZhy{}e\PYGZus{}r*Test\PYGZus{}e\PYGZus{}r}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{)}\PYG{p}{,}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{Brick}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{CR\PYGZus{}r}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{nu*f\PYGZus{}r*Test\PYGZus{}e\PYGZus{}r}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{)}\PYG{p}{,}
\PYG{p}{]}
\end{sphinxVerbatim}

\sphinxAtStartPar
Again, we use the previsouly defined \sphinxcode{\sphinxupquote{Brick}} objects, thus, the whole
system is constructed by adding all the bricks.

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{} Add all these `Bricks` to the dphs}
\PYG{k}{for} \PYG{n}{brick} \PYG{o+ow}{in} \PYG{n}{bricks}\PYG{p}{:}
    \PYG{n}{wave\PYGZus{}diss}\PYG{o}{.}\PYG{n}{add\PYGZus{}brick}\PYG{p}{(}\PYG{n}{brick}\PYG{p}{)}
\end{sphinxVerbatim}

\sphinxAtStartPar
The initialization and solve steps are identical to the previous
conservative case.

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{}\PYGZsh{} Initialize the problem}
\PYG{c+c1}{\PYGZsh{} The controls expression, ordered as the control\PYGZus{}ports}
\PYG{n}{t\PYGZus{}f} \PYG{o}{=} \PYG{l+m+mf}{5.}
\PYG{n}{expressions} \PYG{o}{=} \PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{0.}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{0.}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{0.}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{0.1*sin(4.*t)*sin(4*pi*y)*exp(\PYGZhy{}10.*pow((0.5*}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{t\PYGZus{}f}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZhy{}t),2))}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}

\PYG{c+c1}{\PYGZsh{} Add each expression to its control\PYGZus{}port}
\PYG{k}{for} \PYG{n}{control\PYGZus{}port}\PYG{p}{,} \PYG{n}{expression} \PYG{o+ow}{in} \PYG{n+nb}{zip}\PYG{p}{(}\PYG{n}{control\PYGZus{}ports}\PYG{p}{,} \PYG{n}{expressions}\PYG{p}{)}\PYG{p}{:}
    \PYG{c+c1}{\PYGZsh{} Set the control functions: it automatically constructs the related `Brick`s such that `\PYGZhy{} M\PYGZus{}u u + f(t) = 0`}
    \PYG{n}{wave\PYGZus{}diss}\PYG{o}{.}\PYG{n}{set\PYGZus{}control}\PYG{p}{(}\PYG{n}{control\PYGZus{}port}\PYG{o}{.}\PYG{n}{get\PYGZus{}name}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,} \PYG{n}{expression}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Set the initial data}
\PYG{n}{q\PYGZus{}0} \PYG{o}{=} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{[0., 0.]}\PYG{l+s+s2}{\PYGZdq{}}
\PYG{n}{wave\PYGZus{}diss}\PYG{o}{.}\PYG{n}{set\PYGZus{}initial\PYGZus{}value}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{q}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{q\PYGZus{}0}\PYG{p}{)}
\PYG{n}{p\PYGZus{}0} \PYG{o}{=} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{3**(\PYGZhy{}20*((x\PYGZhy{}0.5)*(x\PYGZhy{}0.5)+(y\PYGZhy{}0.5)*(y\PYGZhy{}0.5)))}\PYG{l+s+s2}{\PYGZdq{}}
\PYG{n}{wave\PYGZus{}diss}\PYG{o}{.}\PYG{n}{set\PYGZus{}initial\PYGZus{}value}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{p}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{p\PYGZus{}0}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{}\PYGZsh{} Solve in time}
\PYG{c+c1}{\PYGZsh{} Define the time scheme}
\PYG{n}{wave\PYGZus{}diss}\PYG{o}{.}\PYG{n}{set\PYGZus{}time\PYGZus{}scheme}\PYG{p}{(}\PYG{n}{ts\PYGZus{}type}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{cn}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
                          \PYG{n}{t\PYGZus{}f}\PYG{o}{=}\PYG{n}{t\PYGZus{}f}\PYG{p}{,}
                          \PYG{n}{dt\PYGZus{}save}\PYG{o}{=}\PYG{l+m+mf}{0.01}\PYG{p}{,}
                          \PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Solve}
\PYG{n}{wave\PYGZus{}diss}\PYG{o}{.}\PYG{n}{solve}\PYG{p}{(}\PYG{p}{)}
\end{sphinxVerbatim}

\sphinxAtStartPar
Now one can define and plot the Hamiltonian.

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{}\PYGZsh{} Post\PYGZhy{}processing}
\PYG{c+c1}{\PYGZsh{} Set Hamiltonian\PYGZsq{}s name}
\PYG{n}{wave\PYGZus{}diss}\PYG{o}{.}\PYG{n}{hamiltonian}\PYG{o}{.}\PYG{n}{set\PYGZus{}name}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Mechanical energy}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Define each Hamiltonian Term (needed to overwrite the previously computed solution)}
\PYG{n}{terms} \PYG{o}{=} \PYG{p}{[}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{Term}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Potential energy}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{0.5*q.T.q}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{)}\PYG{p}{,}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{Term}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Kinetic energy}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{0.5*p*p/rho}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{)}\PYG{p}{,}
\PYG{p}{]}

\PYG{c+c1}{\PYGZsh{} Add them to the Hamiltonian}
\PYG{k}{for} \PYG{n}{term} \PYG{o+ow}{in} \PYG{n}{terms}\PYG{p}{:}
    \PYG{n}{wave\PYGZus{}diss}\PYG{o}{.}\PYG{n}{hamiltonian}\PYG{o}{.}\PYG{n}{add\PYGZus{}term}\PYG{p}{(}\PYG{n}{term}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Plot the Hamiltonian and save the output}
\PYG{n}{wave\PYGZus{}diss}\PYG{o}{.}\PYG{n}{plot\PYGZus{}Hamiltonian}\PYG{p}{(}\PYG{n}{save\PYGZus{}figure}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{,} \PYG{n}{filename}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Hamiltonian\PYGZus{}Wave\PYGZus{}2D\PYGZus{}Dissipative.png}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\end{sphinxVerbatim}

\noindent\sphinxincludegraphics{{Wave_Hamiltonian_dissipative}.png}

\sphinxstepscope


\subsection{The heat equation}
\label{\detokenize{examples/heat:the-heat-equation}}\label{\detokenize{examples/heat::doc}}

\subsubsection{Setting}
\label{\detokenize{examples/heat:setting}}\label{\detokenize{examples/heat:heat-2d}}
\sphinxAtStartPar
This example is the first simple case of intrinsically port\sphinxhyphen{}Hamiltonian
Differential Algebraic Equation (known as pH\sphinxhyphen{}DAE).

\sphinxAtStartPar
The so\sphinxhyphen{}called \sphinxstyleemphasis{heat equation} is driven by the first law of
thermodynamics.

\sphinxAtStartPar
Let \(\Omega = (0,2) \times (0,1)\) be a bounded open connected set,
with mass density \(\rho(x)\), for all \(x \in \Omega\), and
\(n\) be the outward unit normal at the boundary
\(\partial\Omega\). We assume that:
\begin{itemize}
\item {} 
\sphinxAtStartPar
The domain \(\Omega\) does not change over time: \sphinxstyleemphasis{i.e.} we work
at constant volume in a solid

\item {} 
\sphinxAtStartPar
No chemical reaction is to be found in the domain

\item {} 
\sphinxAtStartPar
Dulong\sphinxhyphen{}Petit’s model: internal energy is proportional to temperature

\end{itemize}

\sphinxAtStartPar
Let us denotes:
\begin{itemize}
\item {} 
\sphinxAtStartPar
\(u\) the internal energy density

\item {} 
\sphinxAtStartPar
\(\mathbf{J}_Q\) the heat flux

\item {} 
\sphinxAtStartPar
\(T\) the local temperature

\item {} 
\sphinxAtStartPar
\(C_V := \left( \frac{d u}{d T} \right)_V\) the isochoric heat
capacity

\end{itemize}

\sphinxAtStartPar
The first law of thermodynamics, stating that in an isolated system, the
energy is preserved, reads:
\begin{equation*}
\begin{split}\rho(x) \partial_t u(t, x) = - {\rm div} \left( J_Q(t, x) \right), \qquad \forall t \ge 0, x \in \Omega.\end{split}
\end{equation*}
\sphinxAtStartPar
Under Dulong\sphinxhyphen{}Petit’s model, one has \(u = C_V T\), which leads to
\begin{equation*}
\begin{split}\rho(x) C_V(x) \partial_t T(t, x) = - {\rm div} \left( J_Q(t, x) \right), \qquad \forall t \ge 0, x \in \Omega.\end{split}
\end{equation*}
\sphinxAtStartPar
As constitutive relation, the classical Fourier’s law is considered:
\begin{equation*}
\begin{split}J_Q(t, x) = - \lambda(x) \cdot {\rm grad} \left( T(t, x) \right), \qquad \forall t \ge 0, x \in \Omega,\end{split}
\end{equation*}
\sphinxAtStartPar
where \(\lambda\) is the \sphinxstylestrong{tensor\sphinxhyphen{}valued} heat conductivity of the
medium.

\sphinxAtStartPar
We assume furthermore that one wants to control the temperature
\(T = u_D\) at the lower, right and upper part of the boundary,
denoted \(\Gamma_D\) (a \sphinxstylestrong{D}irichlet boundary condition), while
the inward heat flux \(-J_Q \cdot n = u_N\) will be prescribed at
the left edge, denoted \(\Gamma_N\) (a \sphinxstylestrong{N}eumann boundary
condition). Thus, the observations are \(y_D = - J_Q \cdot n\) and
\(y_N = T\) respectively.


\subsubsection{Port\sphinxhyphen{}Hamiltonian framework}
\label{\detokenize{examples/heat:port-hamiltonian-framework}}
\sphinxAtStartPar
Let us choose as Hamiltonian the usual quadratic form for parabolic
equation
\begin{equation*}
\begin{split}\mathcal{H}(T(t,x)) := \frac{1}{2} \int_\Omega \rho(x) Cv(x) T^2(t,x) {\rm d}x.\end{split}
\end{equation*}
\sphinxAtStartPar
Computing the variational derivative with respect to the weigthed
\(L^2\)\sphinxhyphen{}inner product
\(\left( \phi, \psi \right)_\Omega := \int_\Omega \rho(x) C_V(x) \phi(x) \psi(x) {\rm d} x\)
leads to a co\sphinxhyphen{}state variable \(e_T = T\). Hence, the first law of
thermodynamics may be written as
\begin{equation*}
\begin{split}\begin{pmatrix} \rho C_V T \\ \star \end{pmatrix} = \begin{bmatrix} 0 & -{\rm div} \\ \star & 0 \end{bmatrix} \begin{pmatrix} T \\ J_Q \end{pmatrix}.\end{split}
\end{equation*}
\sphinxAtStartPar
As we want a \sphinxstyleemphasis{formally} skew\sphinxhyphen{}symmetric \(J\) operator, it has to be
completed with \(-{\rm grad}\), then
\begin{equation*}
\begin{split}\begin{pmatrix} \rho C_V T \\ f_Q \end{pmatrix} = \begin{bmatrix} 0 & -{\rm div} \\ -{\rm grad} & 0 \end{bmatrix} \begin{pmatrix} T \\ J_Q \end{pmatrix},\end{split}
\end{equation*}
\sphinxAtStartPar
and Fourier’s law provides the constitutive relation
\(J_Q = \lambda f_Q\) to close the system.

\sphinxAtStartPar
\sphinxstylestrong{Remark:} \(\rho C_V\) appears against the state variable as the
weight of the \(L^2\)\sphinxhyphen{}inner product, it should not be ommited in the
mass matrix at the discrete level.

\sphinxAtStartPar
The \sphinxstylestrong{power balance} satisfied by the \sphinxstylestrong{Hamiltonian} is
\begin{equation*}
\begin{split}\frac{\rm d}{{\rm d}t} \mathcal{H}(t) = \underbrace{- \int_\Omega \lambda \| f_Q(t,x) \|^2 {\rm d} x}_{\text{dissipated power}} \underbrace{+ \left\langle u_D(t,\cdot), y_D(t,\cdot) \right\rangle_{\Gamma_D}}_{\text{power flowing through }\Gamma_D} \underbrace{+ \left\langle y_N(t,\cdot), u_N(t,\cdot)\right\rangle_{\Gamma_N}}_{\text{power flowing through }\Gamma_N},\end{split}
\end{equation*}
\sphinxAtStartPar
where \(\left\langle \cdot, \cdot \right\rangle_{\Gamma}\) is a
boundary duality bracket \(H^\frac12, H^{-\frac12}\) at the boundary
\(\Gamma\).


\subsubsection{Structure\sphinxhyphen{}preserving discretization}
\label{\detokenize{examples/heat:structure-preserving-discretization}}
\sphinxAtStartPar
Let \(\varphi_T\) and \(\varphi_Q\) be smooth test functions on
\(\Omega\), and \(\psi_N\) and \(\psi_D\) be smooth test
functions on \(\Gamma_N\) and \(\Gamma_D\) respectively. One can
write the weak formulation of the \sphinxstylestrong{Dirac Structure} as follows
\begin{equation*}
\begin{split}\left\lbrace
\begin{array}{rcl}
\int_\Omega \rho(x) C_V(x) \partial_t T(t,x) \varphi_T(x) {\rm d}x &=& - \int_\Omega {\rm div} \left( J_Q(t,x) \right) \varphi_T(x) {\rm d}x, \\
\int_\Omega f_Q(t,x) \cdot \varphi_Q(x) {\rm d}x &=& - \int_\Omega {\rm grad} \left( T(t,x) \right) \cdot \varphi_Q(x) {\rm d}x, \\
\left\langle y_D, \psi_D \right\rangle_{\Gamma_D} &=& \left\langle -J_Q \cdot n, \psi_D \right\rangle_{\Gamma_D}, \\
\left\langle u_N, \psi_N \right\rangle_{\Gamma_N} &=& \left\langle -J_Q \cdot n, \psi_N \right\rangle_{\Gamma_N}.
\end{array}
\right.\end{split}
\end{equation*}
\sphinxAtStartPar
Integrating by parts the second line make the control \(u_N\) and
the observation \(y_D\) appear
\begin{equation*}
\begin{split}\int_\Omega f_Q(t,x) \cdot \varphi_Q(x) {\rm d}x = \int_\Omega T(t,x) {\rm div} \left( \varphi_Q(x) \right) {\rm d}x - \left\langle u_D, \varphi_Q \cdot n \right\rangle_{\Gamma_D} - \left\langle y_N, \varphi_Q \cdot n \right\rangle_{\Gamma_N}.\end{split}
\end{equation*}
\sphinxAtStartPar
Now, let \((\varphi_T^i)_{1 \le i \le N_T} \subset L^2(\Omega)\) and
\((\varphi_Q^k)_{1 \le k \le N_Q} \subset H_{\rm div}(\Omega)\) be
two finite families of approximations for the \(T\)\sphinxhyphen{}type port and
the \(Q\)\sphinxhyphen{}type port respectively, typically discontinuous and
continuous Galerkin finite elements respectively. Denote also
\((\psi_N^m)_{1 \le m_N \le N_N} \subset H^{\frac12}(\Gamma_N)\) and
\((\psi_D^m)_{1 \le m_N \le N_D} \subset H^{\frac12}(\Gamma_D)\). In
particular, the latter choices imply that the duality brackets at the
boundary reduce to simple \(L^2\) scalar products.

\sphinxAtStartPar
Writing the discrete weak formulation with those families, one has for
all \(1 \le i \le N_T\), all \(1 \le k \le N_Q\), all
\(1 \le m_N \le N_N\) and all \(1 \le m_D \le N_D\)
\begin{equation*}
\begin{split}\left\lbrace
\begin{array}{rcl}
\sum_{j=1}^{N_T} \int_\Omega \varphi_T^j(x) \rho(x) C_V(x) \varphi_T^i(x) {\rm d}x \, \frac{\rm d}{{\rm d}t} T^j(t) &=& - \sum_{\ell=1}^{N_Q} \int_\Omega {\rm div} \left( \varphi_Q^\ell(x) \right) \varphi_T^i(x) {\rm d}x \, J_Q^\ell(t), \\
\sum_{\ell=1}^{N_Q} \int_\Omega \varphi_Q^\ell(x) \varphi_Q^k(x) {\rm d}x \, f_Q^\ell(t) &=& \sum_{j=1}^{N_Q} \int_\Omega \varphi_T^j(x) {\rm div} \left( \varphi_Q^k(x) \right) {\rm d}x \, T^j(t) \\
&& \quad - \sum_{n_D=1}^{N_D} \int_{\Gamma_D} \varphi_Q^k(s) \cdot n(s) \psi_D^{n_D}(s) {\rm d}s \, u_D^{n_D}(t) \\
&& \qquad - \sum_{n_N=1}^{N_N} \int_{\Gamma_N} \varphi_Q^k(s) \cdot n(s) \psi_N^{n_N}(s) {\rm d}s \, y_N^{n_N}(t), \\
\sum_{n_D=1}^{N_D} \left\langle \psi_D^{n_D}, \psi_D^{m_D} \right\rangle_{\Gamma_D} \, y_D^{n_D}(t) &=& - \sum_{\ell=1}^{N_p} \int_{\Gamma_D} \varphi_Q^\ell(s) \cdot n(s) \psi_D^{m_D}(s) {\rm d}s \, J_Q^\ell(t), \\
\sum_{n_N=1}^{N_N} \left\langle \psi_N^{n_N}, \psi_N^{m_N} \right\rangle_{\Gamma_N} \, u_N^{n_N}(t) &=& - \sum_{\ell=1}^{N_p} \int_{\Gamma_N} \varphi_Q^\ell(s) \cdot n(s) \psi_N^{m_N}(s) {\rm d}s \, J_Q^\ell(t),
\end{array}
\right.\end{split}
\end{equation*}
\sphinxAtStartPar
which rewrites in matrix form
\begin{equation*}
\begin{split}\underbrace{\begin{bmatrix}
M_T & 0 & 0 & 0 \\
0 & M_Q & 0 & 0 \\
0 & 0 & M_D & 0 \\
0 & 0 & 0 & M_N
\end{bmatrix}}_{= M}
\begin{pmatrix}
\frac{\rm d}{{\rm d}t} \underline{T}(t) \\
\underline{f_Q}(t) \\
-\underline{y_D}(t) \\
\underline{u_N}(t)
\end{pmatrix}
=
\underbrace{\begin{bmatrix}
0 & D & 0 & 0 \\
-D^\top & 0 & B_D & -B_N^T \\
0 & -B_D^\top & 0 & 0 \\
0 & B_N & 0 & 0
\end{bmatrix}}_{= J}
\begin{pmatrix}
\underline{T}(t) \\
\underline{J_Q}(t) \\
\underline{u_D}(t) \\
-\underline{y_N}(t)
\end{pmatrix},\end{split}
\end{equation*}
\sphinxAtStartPar
where
\(\underline{\star}(t) := \begin{pmatrix} \star^1(t) & \cdots & \star^{N_\star} \end{pmatrix}^\top\)
and
\begin{equation*}
\begin{split}(M_T)_{ij} := \int_\Omega \varphi_T^j(x) \varphi_T^i(x) {\rm d}x,
\qquad
(M_Q)_{k\ell} := \int_\Omega \varphi_Q^\ell(x) \cdot \varphi_Q^k(x) {\rm d}x,\end{split}
\end{equation*}\begin{equation*}
\begin{split}(M_D)_{m_Dn_D} := \int_{\Gamma_D} \psi_D^{n_D}(s) \psi_D^{m_D}(s) {\rm d}s,
\qquad
(M_N)_{m_Nn_N} := \int_{\Gamma_N} \psi_N^{n_N}(s) \psi_N^{m_N}(s) {\rm d}s,\end{split}
\end{equation*}\begin{equation*}
\begin{split}(D)_{i\ell} := - \int_\Omega {\rm div} \left( \varphi_Q^\ell(x) \right) \cdot \varphi_T^i(x) {\rm d}x\end{split}
\end{equation*}\begin{equation*}
\begin{split}(B_D)_{n_Dk} := - \int_{\Gamma_D} \varphi_Q^k(s) \cdot n(s) \psi_D^{n_D}(s) {\rm d}s,
\qquad
(B_N)_{m_N\ell} := - \int_{\Gamma_N} \varphi_Q^\ell(s) \cdot n(s) \psi_N^{m_N}(s) {\rm d}s,,\end{split}
\end{equation*}
\sphinxAtStartPar
Now one can approximate the \sphinxstylestrong{constitutive relation}
\begin{equation*}
\begin{split}\int_\Omega J_Q(t,x) \cdot \varphi_Q(x) {\rm d}x = \int_\Omega f_Q(t,x) \cdot \lambda(x) \cdot \varphi_Q(x) {\rm d}x,\end{split}
\end{equation*}
\sphinxAtStartPar
from which one can deduce the matrix form of the discrete weak
formulation of the constitutive relation
\begin{equation*}
\begin{split}M_Q \underline{J_Q}(t) = \Lambda \underline{f_Q}(t),\end{split}
\end{equation*}
\sphinxAtStartPar
where
\begin{equation*}
\begin{split}(\Lambda)_{k\ell} := \int_\Omega \varphi_Q^\ell(x) \cdot \lambda(x) \cdot \varphi_Q^k(x) {\rm d}x.\end{split}
\end{equation*}
\sphinxAtStartPar
Finally, the \sphinxstylestrong{discrete Hamiltonian} \(\mathcal{H}^d\) is defined
as the evaluation of \(\mathcal{H}\) on the approximation of the
\sphinxstylestrong{state variable}
\begin{equation*}
\begin{split}\mathcal{H}(t) := \mathcal{H}(T^d(t)) = \frac{1}{2} \underline{T}(t)^\top M_T \underline{T}(t).\end{split}
\end{equation*}
\sphinxAtStartPar
The \sphinxstylestrong{discrete power balance} is then easily deduced from the above
matrix formulations, thanks to the symmetry of \(M\) and the
skew\sphinxhyphen{}symmetry of \(J\)
\begin{equation*}
\begin{split}\frac{\rm d}{{\rm d}t} \mathcal{H}^d(t) = - \underline{f_Q}(t)^\top \Lambda \underline{f_Q}(t)^\top + \underline{u_D}(t)^\top M_D \underline{y_D}(t) + \underline{y_N}(t)^\top M_N \underline{u_N}(t).\end{split}
\end{equation*}

\subsubsection{Simulation}
\label{\detokenize{examples/heat:simulation}}
\sphinxAtStartPar
As usual, we start by importing the \sphinxstylestrong{SCRIMP} package. Then we define
the Distributed Port\sphinxhyphen{}Hamiltonian System and attach a (built\sphinxhyphen{}in) domain
to it.

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{} Import scrimp}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{scrimp}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{S}

\PYG{c+c1}{\PYGZsh{} Init the distributed port\PYGZhy{}Hamiltonian system}
\PYG{n}{heat} \PYG{o}{=} \PYG{n}{S}\PYG{o}{.}\PYG{n}{DPHS}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{real}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Set the domain (using the built\PYGZhy{}in geometry `Rectangle`)}
\PYG{c+c1}{\PYGZsh{} Omega = 1, Gamma\PYGZus{}Bottom = 10, Gamma\PYGZus{}Right = 11, Gamma\PYGZus{}Top = 12, Gamma\PYGZus{}Left = 13}
\PYG{n}{heat}\PYG{o}{.}\PYG{n}{set\PYGZus{}domain}\PYG{p}{(}\PYG{n}{S}\PYG{o}{.}\PYG{n}{Domain}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Rectangle}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{p}{\PYGZob{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{L}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+m+mf}{2.0}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{l}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+m+mf}{1.0}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{h}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+m+mf}{0.1}\PYG{p}{\PYGZcb{}}\PYG{p}{)}\PYG{p}{)}
\end{sphinxVerbatim}

\sphinxAtStartPar
The next step is to define the state and its co\sphinxhyphen{}state. Care must be
taken here: both are the temperature \(T\), since the parameter
\(\rho C_V\) have been taken into account as a weight in the
\(L^2\)\sphinxhyphen{}inner product. Hence, one may save some computational burden
by using \sphinxcode{\sphinxupquote{substituted=True}} which says to \sphinxstylestrong{SCRIMP} that the co\sphinxhyphen{}state
is substituted into the state! Only \sphinxstylestrong{one} variable is approximated and
will be computed in the sequel.

\sphinxAtStartPar
However, note that one could define a state \(e\) (namely the
\sphinxstyleemphasis{internal energy}), and add Dulong\sphinxhyphen{}Petit’s law as a constitutive
relation \(e = C_V T\) as usual.

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{} Define the variables and their discretizations and add them to the dphs}
\PYG{n}{states} \PYG{o}{=} \PYG{p}{[}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{State}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{T}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Temperature}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{scalar\PYGZhy{}field}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}
\PYG{p}{]}
\PYG{n}{costates} \PYG{o}{=} \PYG{p}{[}
    \PYG{c+c1}{\PYGZsh{} Substituted=True indicates that only one variable has to be discretized on this port}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{CoState}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{T}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Temperature}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{states}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{,} \PYG{n}{substituted}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{)}
\PYG{p}{]}
\end{sphinxVerbatim}

\sphinxAtStartPar
Let us define the algebraic port.

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{n}{ports} \PYG{o}{=} \PYG{p}{[}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{Port}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Heat flux}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{f\PYGZus{}Q}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{J\PYGZus{}Q}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{vector\PYGZhy{}field}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}
\PYG{p}{]}
\end{sphinxVerbatim}

\sphinxAtStartPar
And finally the control ports on each of the four boundary part.

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{n}{control\PYGZus{}ports} \PYG{o}{=} \PYG{p}{[}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{Control\PYGZus{}Port}\PYG{p}{(}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Boundary control (bottom)}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{U\PYGZus{}B}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Temperature}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Y\PYGZus{}B}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{\PYGZhy{} Normal heat flux}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{scalar\PYGZhy{}field}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{n}{region}\PYG{o}{=}\PYG{l+m+mi}{10}\PYG{p}{,}
        \PYG{n}{position}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{effort}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
    \PYG{p}{)}\PYG{p}{,}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{Control\PYGZus{}Port}\PYG{p}{(}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Boundary control (right)}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{U\PYGZus{}R}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Temperature}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Y\PYGZus{}R}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{\PYGZhy{} Normal heat flux}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{scalar\PYGZhy{}field}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{n}{region}\PYG{o}{=}\PYG{l+m+mi}{11}\PYG{p}{,}
        \PYG{n}{position}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{effort}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
    \PYG{p}{)}\PYG{p}{,}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{Control\PYGZus{}Port}\PYG{p}{(}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Boundary control (top)}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{U\PYGZus{}T}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Temperature}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Y\PYGZus{}T}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{\PYGZhy{} Normal heat flux}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{scalar\PYGZhy{}field}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{n}{region}\PYG{o}{=}\PYG{l+m+mi}{12}\PYG{p}{,}
        \PYG{n}{position}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{effort}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
    \PYG{p}{)}\PYG{p}{,}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{Control\PYGZus{}Port}\PYG{p}{(}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Boundary control (left)}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{U\PYGZus{}L}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{\PYGZhy{} Normal heat flux}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Y\PYGZus{}L}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Temperature}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{scalar\PYGZhy{}field}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{n}{region}\PYG{o}{=}\PYG{l+m+mi}{13}\PYG{p}{,}
        \PYG{n}{position}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{flow}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
    \PYG{p}{)}\PYG{p}{,}
\PYG{p}{]}
\end{sphinxVerbatim}

\sphinxAtStartPar
Add all these objects to the \sphinxcode{\sphinxupquote{DPHS}}.

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{k}{for} \PYG{n}{state} \PYG{o+ow}{in} \PYG{n}{states}\PYG{p}{:}
    \PYG{n}{heat}\PYG{o}{.}\PYG{n}{add\PYGZus{}state}\PYG{p}{(}\PYG{n}{state}\PYG{p}{)}
\PYG{k}{for} \PYG{n}{costate} \PYG{o+ow}{in} \PYG{n}{costates}\PYG{p}{:}
    \PYG{n}{heat}\PYG{o}{.}\PYG{n}{add\PYGZus{}costate}\PYG{p}{(}\PYG{n}{costate}\PYG{p}{)}
\PYG{k}{for} \PYG{n}{port} \PYG{o+ow}{in} \PYG{n}{ports}\PYG{p}{:}
    \PYG{n}{heat}\PYG{o}{.}\PYG{n}{add\PYGZus{}port}\PYG{p}{(}\PYG{n}{port}\PYG{p}{)}
\PYG{k}{for} \PYG{n}{ctrl\PYGZus{}port} \PYG{o+ow}{in} \PYG{n}{control\PYGZus{}ports}\PYG{p}{:}
    \PYG{n}{heat}\PYG{o}{.}\PYG{n}{add\PYGZus{}control\PYGZus{}port}\PYG{p}{(}\PYG{n}{ctrl\PYGZus{}port}\PYG{p}{)}
\end{sphinxVerbatim}

\sphinxAtStartPar
Now, we must define the finite element families on each port. As stated
in the beginning, \sphinxstylestrong{only the :math:\textasciigrave{}varphi\_Q\textasciigrave{} family needs a stronger
regularity}. Let us choose continuous Galerkin approximation of order
2. Then, the divergence of \(\varphi_Q\) is easily approximated by
discontinuous Galerkin of order 1. At the boundary, this latter
regularity will then occur, hence the choice of discontinuous Galerkin
of order 1 as well.

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{n}{FEMs} \PYG{o}{=} \PYG{p}{[}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{FEM}\PYG{p}{(}\PYG{n}{states}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{get\PYGZus{}name}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n}{FEM}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{DG}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{FEM}\PYG{p}{(}\PYG{n}{ports}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{get\PYGZus{}name}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{,} \PYG{n}{FEM}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{CG}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{FEM}\PYG{p}{(}\PYG{n}{control\PYGZus{}ports}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{get\PYGZus{}name}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n}{FEM}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{DG}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{FEM}\PYG{p}{(}\PYG{n}{control\PYGZus{}ports}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{get\PYGZus{}name}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n}{FEM}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{DG}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{FEM}\PYG{p}{(}\PYG{n}{control\PYGZus{}ports}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{]}\PYG{o}{.}\PYG{n}{get\PYGZus{}name}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n}{FEM}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{DG}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{FEM}\PYG{p}{(}\PYG{n}{control\PYGZus{}ports}\PYG{p}{[}\PYG{l+m+mi}{3}\PYG{p}{]}\PYG{o}{.}\PYG{n}{get\PYGZus{}name}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n}{FEM}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{DG}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}
\PYG{p}{]}
\PYG{k}{for} \PYG{n}{FEM} \PYG{o+ow}{in} \PYG{n}{FEMs}\PYG{p}{:}
    \PYG{n}{heat}\PYG{o}{.}\PYG{n}{add\PYGZus{}FEM}\PYG{p}{(}\PYG{n}{FEM}\PYG{p}{)}
\end{sphinxVerbatim}

\sphinxAtStartPar
It is now time to define the parameters, namely \(rho\), \(C_V\)
and \(\lambda\). For the sake of simplicity, we assume that
\(\rho\) will take \(C_V\) into account.

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{} Define the physical parameters}
\PYG{n}{parameters} \PYG{o}{=} \PYG{p}{[}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{Parameter}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{rho}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Mass density times heat capacity}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{scalar\PYGZhy{}field}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{3.}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{T}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{Parameter}\PYG{p}{(}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Lambda}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Heat conductivity}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{tensor\PYGZhy{}field}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{[[1e\PYGZhy{}2,0.],[0.,1e\PYGZhy{}2]]}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Heat flux}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
    \PYG{p}{)}\PYG{p}{,}
\PYG{p}{]}
\PYG{c+c1}{\PYGZsh{} Add them to the dphs}
\PYG{k}{for} \PYG{n}{parameter} \PYG{o+ow}{in} \PYG{n}{parameters}\PYG{p}{:}
    \PYG{n}{heat}\PYG{o}{.}\PYG{n}{add\PYGZus{}parameter}\PYG{p}{(}\PYG{n}{parameter}\PYG{p}{)}
\end{sphinxVerbatim}

\sphinxAtStartPar
Now the non\sphinxhyphen{}zero block matrices of the Dirac structure can be defined
using the \sphinxcode{\sphinxupquote{Brick}} object, as well as the constitutive relation, \sphinxstyleemphasis{i.e.}
Fourier’s law.

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{} Define the Dirac structure and the constitutive relations block matrices as `Brick`}
\PYG{n}{bricks} \PYG{o}{=} \PYG{p}{[}
    \PYG{c+c1}{\PYGZsh{} Add the mass matrices from the left\PYGZhy{}hand side: the `flow` part of the Dirac structure}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{Brick}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{M\PYGZus{}T}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{T*rho*Test\PYGZus{}T}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,} \PYG{n}{dt}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{,} \PYG{n}{position}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{flow}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{Brick}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{M\PYGZus{}Q}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{f\PYGZus{}Q.Test\PYGZus{}f\PYGZus{}Q}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,} \PYG{n}{position}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{flow}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{Brick}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{M\PYGZus{}Y\PYGZus{}B}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Y\PYGZus{}B*Test\PYGZus{}Y\PYGZus{}B}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mi}{10}\PYG{p}{]}\PYG{p}{,} \PYG{n}{position}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{flow}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{Brick}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{M\PYGZus{}Y\PYGZus{}R}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Y\PYGZus{}R*Test\PYGZus{}Y\PYGZus{}R}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mi}{11}\PYG{p}{]}\PYG{p}{,} \PYG{n}{position}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{flow}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{Brick}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{M\PYGZus{}Y\PYGZus{}T}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Y\PYGZus{}T*Test\PYGZus{}Y\PYGZus{}T}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mi}{12}\PYG{p}{]}\PYG{p}{,} \PYG{n}{position}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{flow}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}
    \PYG{c+c1}{\PYGZsh{} Normal trace is imposed by Lagrange multiplier on the left side == the collocated output}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{Brick}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{M\PYGZus{}Y\PYGZus{}L}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{U\PYGZus{}L*Test\PYGZus{}Y\PYGZus{}L}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mi}{13}\PYG{p}{]}\PYG{p}{,} \PYG{n}{position}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{flow}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}
    \PYG{c+c1}{\PYGZsh{} Add the matrices from the right\PYGZhy{}hand side: the `effort` part of the Dirac structure}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{Brick}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{D}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{\PYGZhy{}Div(J\PYGZus{}Q)*Test\PYGZus{}T}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,} \PYG{n}{position}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{effort}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{Brick}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{\PYGZhy{}D\PYGZca{}T}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{T*Div(Test\PYGZus{}f\PYGZus{}Q)}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,} \PYG{n}{position}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{effort}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{Brick}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{B\PYGZus{}B}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{\PYGZhy{}U\PYGZus{}B*Test\PYGZus{}f\PYGZus{}Q.Normal}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mi}{10}\PYG{p}{]}\PYG{p}{,} \PYG{n}{position}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{effort}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{Brick}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{B\PYGZus{}R}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{\PYGZhy{}U\PYGZus{}R*Test\PYGZus{}f\PYGZus{}Q.Normal}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mi}{11}\PYG{p}{]}\PYG{p}{,} \PYG{n}{position}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{effort}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{Brick}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{B\PYGZus{}T}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{\PYGZhy{}U\PYGZus{}T*Test\PYGZus{}f\PYGZus{}Q.Normal}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mi}{12}\PYG{p}{]}\PYG{p}{,} \PYG{n}{position}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{effort}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}
    \PYG{c+c1}{\PYGZsh{} Normal trace is imposed by Lagrange multiplier on the left side == the collocated output}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{Brick}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{B\PYGZus{}L}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{\PYGZhy{}Y\PYGZus{}L*Test\PYGZus{}f\PYGZus{}Q.Normal}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mi}{13}\PYG{p}{]}\PYG{p}{,} \PYG{n}{position}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{effort}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{Brick}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{C\PYGZus{}B}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{J\PYGZus{}Q.Normal*Test\PYGZus{}Y\PYGZus{}B}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mi}{10}\PYG{p}{]}\PYG{p}{,} \PYG{n}{position}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{effort}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{Brick}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{C\PYGZus{}R}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{J\PYGZus{}Q.Normal*Test\PYGZus{}Y\PYGZus{}R}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mi}{11}\PYG{p}{]}\PYG{p}{,} \PYG{n}{position}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{effort}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{Brick}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{C\PYGZus{}T}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{J\PYGZus{}Q.Normal*Test\PYGZus{}Y\PYGZus{}T}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mi}{12}\PYG{p}{]}\PYG{p}{,} \PYG{n}{position}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{effort}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{Brick}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{C\PYGZus{}L}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{J\PYGZus{}Q.Normal*Test\PYGZus{}Y\PYGZus{}L}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mi}{13}\PYG{p}{]}\PYG{p}{,} \PYG{n}{position}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{effort}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}
    \PYG{c+c1}{\PYGZsh{}\PYGZsh{} Define the constitutive relations as getfem `brick`}
    \PYG{c+c1}{\PYGZsh{} Fourier\PYGZsq{}s law under implicit form \PYGZhy{} M\PYGZus{}e\PYGZus{}Q e\PYGZus{}Q + CR\PYGZus{}Q Q = 0}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{Brick}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{\PYGZhy{}M\PYGZus{}J\PYGZus{}Q}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{\PYGZhy{}J\PYGZus{}Q.Test\PYGZus{}J\PYGZus{}Q}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{)}\PYG{p}{,}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{Brick}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{CR\PYGZus{}Q}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{f\PYGZus{}Q.Lambda.Test\PYGZus{}J\PYGZus{}Q}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{)}\PYG{p}{,}
\PYG{p}{]}
\PYG{k}{for} \PYG{n}{brick} \PYG{o+ow}{in} \PYG{n}{bricks}\PYG{p}{:}
    \PYG{n}{heat}\PYG{o}{.}\PYG{n}{add\PYGZus{}brick}\PYG{p}{(}\PYG{n}{brick}\PYG{p}{)}
\end{sphinxVerbatim}

\sphinxAtStartPar
As controls, we assume that the temperature is prescribed, while the
inward heat flux is proportional to the temperature (\sphinxstyleemphasis{i.e.} we consider
an impedance\sphinxhyphen{}like absorbing boundary condition). This is easily achieved
in \sphinxstylestrong{SCRIMP} by calling the variable in the expression of the control
to apply.

\sphinxAtStartPar
The initial temperature profile is compatible with these controls, and
has a positive bump centered in the domain.

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{} Initialize the problem}
\PYG{n}{expressions} \PYG{o}{=} \PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{1.}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{1.}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{1.}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{0.2*T}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}

\PYG{k}{for} \PYG{n}{control\PYGZus{}port}\PYG{p}{,} \PYG{n}{expression} \PYG{o+ow}{in} \PYG{n+nb}{zip}\PYG{p}{(}\PYG{n}{control\PYGZus{}ports}\PYG{p}{,} \PYG{n}{expressions}\PYG{p}{)}\PYG{p}{:}
    \PYG{c+c1}{\PYGZsh{} Set the control functions (automatic construction of bricks such that \PYGZhy{}M\PYGZus{}u u + f(t) = 0)}
    \PYG{n}{heat}\PYG{o}{.}\PYG{n}{set\PYGZus{}control}\PYG{p}{(}\PYG{n}{control\PYGZus{}port}\PYG{o}{.}\PYG{n}{get\PYGZus{}name}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,} \PYG{n}{expression}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Set the initial data}
\PYG{n}{heat}\PYG{o}{.}\PYG{n}{set\PYGZus{}initial\PYGZus{}value}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{T}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{1. + 2.*np.exp(\PYGZhy{}50*((x\PYGZhy{}1)*(x\PYGZhy{}1)+(y\PYGZhy{}0.5)*(y\PYGZhy{}0.5))**2)}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\end{sphinxVerbatim}

\sphinxAtStartPar
We can now solve our Differential Algebraic Equation (DAE) using,
\sphinxstyleemphasis{e.g.}, a Backward Differentiation Formula (BDF) of order 4.

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{}\PYGZsh{} Solve in time}
\PYG{c+c1}{\PYGZsh{} Define the time scheme (\PYGZdq{}bdf\PYGZdq{} is backward differentiation formula)}
\PYG{n}{heat}\PYG{o}{.}\PYG{n}{set\PYGZus{}time\PYGZus{}scheme}\PYG{p}{(}\PYG{n}{t\PYGZus{}f}\PYG{o}{=}\PYG{l+m+mf}{5.}\PYG{p}{,}
                     \PYG{n}{ts\PYGZus{}type}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{bdf}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
                     \PYG{n}{ts\PYGZus{}bdf\PYGZus{}order}\PYG{o}{=}\PYG{l+m+mi}{4}\PYG{p}{,}
                     \PYG{n}{dt}\PYG{o}{=}\PYG{l+m+mf}{0.01}\PYG{p}{,}
                     \PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Solve}
\PYG{n}{heat}\PYG{o}{.}\PYG{n}{solve}\PYG{p}{(}\PYG{p}{)}
\end{sphinxVerbatim}

\sphinxAtStartPar
The Hamiltonian may be defined, computed and plot.

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{}\PYGZsh{} Post\PYGZhy{}processing}
\PYG{c+c1}{\PYGZsh{} Set Hamiltonian name}
\PYG{n}{heat}\PYG{o}{.}\PYG{n}{hamiltonian}\PYG{o}{.}\PYG{n}{set\PYGZus{}name}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Lyapunov formulation}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{c+c1}{\PYGZsh{} Define the term}
\PYG{n}{terms} \PYG{o}{=} \PYG{p}{[}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{Term}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{L\PYGZca{}2\PYGZhy{}norm}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{0.5*T*rho*T}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{)}\PYG{p}{,}
\PYG{p}{]}
\PYG{c+c1}{\PYGZsh{} Add them to the Hamiltonian}
\PYG{k}{for} \PYG{n}{term} \PYG{o+ow}{in} \PYG{n}{terms}\PYG{p}{:}
    \PYG{n}{heat}\PYG{o}{.}\PYG{n}{hamiltonian}\PYG{o}{.}\PYG{n}{add\PYGZus{}term}\PYG{p}{(}\PYG{n}{term}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Plot the Hamiltonian}
\PYG{n}{heat}\PYG{o}{.}\PYG{n}{plot\PYGZus{}Hamiltonian}\PYG{p}{(}\PYG{n}{save\PYGZus{}figure}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{,} \PYG{n}{filename}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Hamiltonian\PYGZus{}Heat\PYGZus{}2D.png}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\end{sphinxVerbatim}

\noindent\sphinxincludegraphics{{Heat_Hamiltonian}.png}

\sphinxstepscope


\subsection{Another wave equation}
\label{\detokenize{examples/wave_coenergy:another-wave-equation}}\label{\detokenize{examples/wave_coenergy::doc}}

\subsubsection{Setting}
\label{\detokenize{examples/wave_coenergy:setting}}\label{\detokenize{examples/wave_coenergy:wave-2d-coenergy}}
\sphinxAtStartPar
The objective of this example is to show how sub\sphinxhyphen{}domains may be used,
and how substitutions reduce the computational burden: it assumes that
\sphinxhref{https://g-haine.github.io/scrimp/examples/wave.html}{this 2D wave example} has
already been studied.


\subsubsection{Substitutions}
\label{\detokenize{examples/wave_coenergy:substitutions}}
\sphinxAtStartPar
The damped wave equation as a port\sphinxhyphen{}Hamiltonian system writes
\begin{equation*}
\begin{split}\begin{pmatrix} \partial_t \alpha_q \\ \partial_t \alpha_p \\ f_r \end{pmatrix}
=
\begin{bmatrix} 0 & {\rm grad} & 0 \\ {\rm div} & 0 & -I \\ 0 & I^\top & 0 \end{bmatrix}
\begin{pmatrix} e_q \\ e_p \\ e_r \end{pmatrix},\end{split}
\end{equation*}
\sphinxAtStartPar
where \(\alpha_q\) denotes the strain, \(\alpha_p\) is the
linear momentum, \(e_q\) is the stress, \(e_p\) is the velocity
and \((f_r,e_r)\) is the dissipative port.

\sphinxAtStartPar
This system must be close with \sphinxstylestrong{constitutive relations}, which are
\begin{equation*}
\begin{split}e_q = T \cdot \alpha_q, \qquad e_p = \frac{\alpha_p}{\rho}, \qquad e_r = \nu f_r,\end{split}
\end{equation*}
\sphinxAtStartPar
where \(T\) is the Young’s modulus, \(\rho\) the mass density
and \(\nu\) the viscosity. Inverting these relations and
substituting the results in the port\sphinxhyphen{}Hamiltonian system leads to the
\sphinxstylestrong{co\sphinxhyphen{}energy formulation} (or more generally \sphinxstylestrong{co\sphinxhyphen{}state formulation})
\begin{equation*}
\begin{split}\begin{pmatrix} T^{-1} \cdot \partial_t e_q \\ \rho \partial_t e_p \\ \nu^{-1} e_r \end{pmatrix}
=
\begin{bmatrix} 0 & {\rm grad} & 0 \\ {\rm div} & 0 & -I \\ 0 & I^\top & 0 \end{bmatrix}
\begin{pmatrix} e_q \\ e_p \\ e_r \end{pmatrix}.\end{split}
\end{equation*}
\sphinxAtStartPar
At the discrete level, this allows to reduce the number of degrees of
freedom by two.

\sphinxAtStartPar
\sphinxstylestrong{Remark:} In the example, \(\nu\) only acts on a sub\sphinxhyphen{}domain,
\sphinxstyleemphasis{i.e.} it is theoretically null on the complementary, and thus is not invertible! To be able to invert it, it is then mandatory to restrict the
dissipative port to the sub\sphinxhyphen{}domain where \(\nu>0\).


\subsubsection{Simulation}
\label{\detokenize{examples/wave_coenergy:simulation}}
\sphinxAtStartPar
Let us start quickly until the definition of the dissipative port.

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{} Import scrimp}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{scrimp}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{S}

\PYG{c+c1}{\PYGZsh{} Init the distributed port\PYGZhy{}Hamiltonian system}
\PYG{n}{wave} \PYG{o}{=} \PYG{n}{S}\PYG{o}{.}\PYG{n}{DPHS}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{real}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Set the domain (using the built\PYGZhy{}in geometry `Concentric`)}
\PYG{c+c1}{\PYGZsh{} Labels: Disk = 1, Annulus = 2, Interface = 10, Boundary = 20}
\PYG{n}{omega} \PYG{o}{=} \PYG{n}{S}\PYG{o}{.}\PYG{n}{Domain}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Concentric}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{p}{\PYGZob{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{R}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+m+mf}{1.0}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{r}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+m+mf}{0.6}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{h}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+m+mf}{0.1}\PYG{p}{\PYGZcb{}}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} And add it to the dphs}
\PYG{n}{wave}\PYG{o}{.}\PYG{n}{set\PYGZus{}domain}\PYG{p}{(}\PYG{n}{omega}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{}\PYGZsh{} Define the variables}
\PYG{n}{states} \PYG{o}{=} \PYG{p}{[}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{State}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{q}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Stress}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{vector\PYGZhy{}field}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{State}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{p}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Velocity}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{scalar\PYGZhy{}field}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}
\PYG{p}{]}
\PYG{c+c1}{\PYGZsh{} Use of the `substituted=True` keyword to get the co\PYGZhy{}energy formulation}
\PYG{n}{costates} \PYG{o}{=} \PYG{p}{[}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{CoState}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{e\PYGZus{}q}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Stress}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{states}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{,} \PYG{n}{substituted}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{)}\PYG{p}{,}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{CoState}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{e\PYGZus{}p}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Velocity}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{states}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,} \PYG{n}{substituted}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{)}\PYG{p}{,}
\PYG{p}{]}

\PYG{c+c1}{\PYGZsh{} Add them to the dphs}
\PYG{k}{for} \PYG{n}{state} \PYG{o+ow}{in} \PYG{n}{states}\PYG{p}{:}
    \PYG{n}{wave}\PYG{o}{.}\PYG{n}{add\PYGZus{}state}\PYG{p}{(}\PYG{n}{state}\PYG{p}{)}
\PYG{k}{for} \PYG{n}{costate} \PYG{o+ow}{in} \PYG{n}{costates}\PYG{p}{:}
    \PYG{n}{wave}\PYG{o}{.}\PYG{n}{add\PYGZus{}costate}\PYG{p}{(}\PYG{n}{costate}\PYG{p}{)}
\end{sphinxVerbatim}

\sphinxAtStartPar
In order to restrict the dissipative port to the internal disk, we use
the \sphinxcode{\sphinxupquote{region}} keyword.

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{} Define the dissipative port, only on the subdomain labelled 1 = the internal disk}
\PYG{n}{ports} \PYG{o}{=} \PYG{p}{[}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{Port}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Damping}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{e\PYGZus{}r}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{e\PYGZus{}r}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{scalar\PYGZhy{}field}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{substituted}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{,} \PYG{n}{region}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{)}\PYG{p}{,}
\PYG{p}{]}

\PYG{c+c1}{\PYGZsh{} Add it to the dphs}
\PYG{k}{for} \PYG{n}{port} \PYG{o+ow}{in} \PYG{n}{ports}\PYG{p}{:}
    \PYG{n}{wave}\PYG{o}{.}\PYG{n}{add\PYGZus{}port}\PYG{p}{(}\PYG{n}{port}\PYG{p}{)}
\end{sphinxVerbatim}

\sphinxAtStartPar
The control port is only at the external boundary, labelled by 20 in
\sphinxstylestrong{SCRIMP}.

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{} Define the control port}
\PYG{n}{control\PYGZus{}ports} \PYG{o}{=} \PYG{p}{[}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{Control\PYGZus{}Port}\PYG{p}{(}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Boundary control}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{U}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Normal force}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Y}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Velocity trace}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{scalar\PYGZhy{}field}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{n}{region}\PYG{o}{=}\PYG{l+m+mi}{20}\PYG{p}{,}
    \PYG{p}{)}\PYG{p}{,}
\PYG{p}{]}

\PYG{c+c1}{\PYGZsh{} Add it to the dphs}
\PYG{k}{for} \PYG{n}{ctrl\PYGZus{}port} \PYG{o+ow}{in} \PYG{n}{control\PYGZus{}ports}\PYG{p}{:}
    \PYG{n}{wave}\PYG{o}{.}\PYG{n}{add\PYGZus{}control\PYGZus{}port}\PYG{p}{(}\PYG{n}{ctrl\PYGZus{}port}\PYG{p}{)}
\end{sphinxVerbatim}

\sphinxAtStartPar
The sequel is as for the already seen examples.

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{} Define the Finite Elements Method of each port}
\PYG{n}{FEMs} \PYG{o}{=} \PYG{p}{[}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{FEM}\PYG{p}{(}\PYG{n}{states}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{get\PYGZus{}name}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{DG}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{FEM}\PYG{p}{(}\PYG{n}{states}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{get\PYGZus{}name}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{CG}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{FEM}\PYG{p}{(}\PYG{n}{ports}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{get\PYGZus{}name}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{DG}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{FEM}\PYG{p}{(}\PYG{n}{control\PYGZus{}ports}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{get\PYGZus{}name}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{DG}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}
\PYG{p}{]}

\PYG{c+c1}{\PYGZsh{} Add them to the dphs}
\PYG{k}{for} \PYG{n}{FEM} \PYG{o+ow}{in} \PYG{n}{FEMs}\PYG{p}{:}
    \PYG{n}{wave}\PYG{o}{.}\PYG{n}{add\PYGZus{}FEM}\PYG{p}{(}\PYG{n}{FEM}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Define physical parameters: care must be taken,}
\PYG{c+c1}{\PYGZsh{} in the co\PYGZhy{}energy formulation, some parameters are}
\PYG{c+c1}{\PYGZsh{} inverted in comparison to the classical formulation}
\PYG{n}{parameters} \PYG{o}{=} \PYG{p}{[}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{Parameter}\PYG{p}{(}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Tinv}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Young}\PYG{l+s+s2}{\PYGZsq{}}\PYG{l+s+s2}{s modulus inverse}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{tensor\PYGZhy{}field}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{[[5+x,x*y],[x*y,2+y]]}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{q}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
    \PYG{p}{)}\PYG{p}{,}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{Parameter}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{rho}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Mass density}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{scalar\PYGZhy{}field}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{3\PYGZhy{}x}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{p}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{Parameter}\PYG{p}{(}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{nu}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Viscosity}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{scalar\PYGZhy{}field}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{10*(0.36\PYGZhy{}(x*x+y*y))}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{n}{ports}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{get\PYGZus{}name}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,}
    \PYG{p}{)}\PYG{p}{,}
\PYG{p}{]}

\PYG{c+c1}{\PYGZsh{} Add them to the dphs}
\PYG{k}{for} \PYG{n}{parameter} \PYG{o+ow}{in} \PYG{n}{parameters}\PYG{p}{:}
    \PYG{n}{wave}\PYG{o}{.}\PYG{n}{add\PYGZus{}parameter}\PYG{p}{(}\PYG{n}{parameter}\PYG{p}{)}
\end{sphinxVerbatim}

\sphinxAtStartPar
Regarding the \sphinxcode{\sphinxupquote{Brick}} objects, there is a major difference with the
previous examples: here, we need to list \sphinxstylestrong{all} the sub\sphinxhyphen{}domain labels
for the wave equation, hence the \sphinxcode{\sphinxupquote{{[}1,2{]}}}. On the other hand, the
dissipation only occurs on the internal disk, labelled 1, and thus the
block matrices corresponding to the identity operators which implement
the dissipation \sphinxstylestrong{must be restrict to} \sphinxcode{\sphinxupquote{{[}1{]}}}.

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{} Define the pHs via `Brick` == non\PYGZhy{}zero block matrices == variational terms}
\PYG{c+c1}{\PYGZsh{} Since we use co\PYGZhy{}energy formulation, constitutive relations are already taken into}
\PYG{c+c1}{\PYGZsh{} account in the mass matrices M\PYGZus{}q and M\PYGZus{}p}
\PYG{n}{bricks} \PYG{o}{=} \PYG{p}{[}
    \PYG{c+c1}{\PYGZsh{}\PYGZsh{} Define the Dirac structure}
    \PYG{c+c1}{\PYGZsh{} Define the mass matrices from the left\PYGZhy{}hand side: the `flow` part of the Dirac structure}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{Brick}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{M\PYGZus{}q}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{q.Tinv.Test\PYGZus{}q}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{]}\PYG{p}{,} \PYG{n}{dt}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{,} \PYG{n}{position}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{flow}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{Brick}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{M\PYGZus{}p}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{p*rho*Test\PYGZus{}p}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{]}\PYG{p}{,} \PYG{n}{dt}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{,} \PYG{n}{position}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{flow}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{Brick}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{M\PYGZus{}r}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{e\PYGZus{}r/nu*Test\PYGZus{}e\PYGZus{}r}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,} \PYG{n}{position}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{flow}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{Brick}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{M\PYGZus{}Y}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Y*Test\PYGZus{}Y}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mi}{20}\PYG{p}{]}\PYG{p}{,} \PYG{n}{position}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{flow}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}
    \PYG{c+c1}{\PYGZsh{} Define the matrices from the right\PYGZhy{}hand side: the `effort` part of the Dirac structure}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{Brick}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{D}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Grad(p).Test\PYGZus{}q}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{]}\PYG{p}{,} \PYG{n}{position}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{effort}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{Brick}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{\PYGZhy{}D\PYGZca{}T}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{\PYGZhy{}q.Grad(Test\PYGZus{}p)}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{]}\PYG{p}{,} \PYG{n}{position}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{effort}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{Brick}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{I\PYGZus{}r}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{e\PYGZus{}r*Test\PYGZus{}p}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,} \PYG{n}{position}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{effort}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{Brick}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{B}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{U*Test\PYGZus{}p}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mi}{20}\PYG{p}{]}\PYG{p}{,} \PYG{n}{position}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{effort}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{Brick}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{\PYGZhy{}I\PYGZus{}r\PYGZca{}T}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{\PYGZhy{}p*Test\PYGZus{}e\PYGZus{}r}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,} \PYG{n}{position}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{effort}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{Brick}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{\PYGZhy{}B\PYGZca{}T}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{\PYGZhy{}p*Test\PYGZus{}Y}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mi}{20}\PYG{p}{]}\PYG{p}{,} \PYG{n}{position}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{effort}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}
    \PYG{c+c1}{\PYGZsh{}\PYGZsh{} Define the constitutive relations}
    \PYG{c+c1}{\PYGZsh{} Already taken into account in the Dirac Structure!}
\PYG{p}{]}

\PYG{c+c1}{\PYGZsh{} Add all these `Bricks` to the dphs}
\PYG{k}{for} \PYG{n}{brick} \PYG{o+ow}{in} \PYG{n}{bricks}\PYG{p}{:}
    \PYG{n}{wave}\PYG{o}{.}\PYG{n}{add\PYGZus{}brick}\PYG{p}{(}\PYG{n}{brick}\PYG{p}{)}
\end{sphinxVerbatim}

\sphinxAtStartPar
The remaining part of the code have already been explain in previous
examples.

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{}\PYGZsh{} Initialize the problem}
\PYG{c+c1}{\PYGZsh{} The controls expression}
\PYG{n}{expressions} \PYG{o}{=} \PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{0.5*Y}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}

\PYG{c+c1}{\PYGZsh{} Add each expression to its control\PYGZus{}port}
\PYG{k}{for} \PYG{n}{control\PYGZus{}port}\PYG{p}{,} \PYG{n}{expression} \PYG{o+ow}{in} \PYG{n+nb}{zip}\PYG{p}{(}\PYG{n}{control\PYGZus{}ports}\PYG{p}{,} \PYG{n}{expressions}\PYG{p}{)}\PYG{p}{:}
    \PYG{c+c1}{\PYGZsh{} Set the control functions (automatic construction of bricks such that \PYGZhy{}M\PYGZus{}u u + f(t) = 0)}
    \PYG{n}{wave}\PYG{o}{.}\PYG{n}{set\PYGZus{}control}\PYG{p}{(}\PYG{n}{control\PYGZus{}port}\PYG{o}{.}\PYG{n}{get\PYGZus{}name}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,} \PYG{n}{expression}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Set the initial data}
\PYG{n}{wave}\PYG{o}{.}\PYG{n}{set\PYGZus{}initial\PYGZus{}value}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{q}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{[0., 0.]}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n}{wave}\PYG{o}{.}\PYG{n}{set\PYGZus{}initial\PYGZus{}value}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{p}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{2.72**(\PYGZhy{}20*((x\PYGZhy{}0.5)*(x\PYGZhy{}0.5)+(y\PYGZhy{}0.5)*(y\PYGZhy{}0.5)))}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{}\PYGZsh{} Solve in time}
\PYG{c+c1}{\PYGZsh{} Define the time scheme (\PYGZdq{}cn\PYGZdq{} is Crank\PYGZhy{}Nicolson)}
\PYG{n}{wave}\PYG{o}{.}\PYG{n}{set\PYGZus{}time\PYGZus{}scheme}\PYG{p}{(}\PYG{n}{ts\PYGZus{}type}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{cn}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
                     \PYG{n}{t\PYGZus{}f}\PYG{o}{=}\PYG{l+m+mf}{2.0}\PYG{p}{,}
                     \PYG{n}{dt\PYGZus{}save}\PYG{o}{=}\PYG{l+m+mf}{0.01}\PYG{p}{,}
                     \PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Solve}
\PYG{n}{wave}\PYG{o}{.}\PYG{n}{solve}\PYG{p}{(}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{}\PYGZsh{} Post\PYGZhy{}processing}
\PYG{c+c1}{\PYGZsh{}\PYGZsh{} Set Hamiltonian\PYGZsq{}s name}
\PYG{n}{wave}\PYG{o}{.}\PYG{n}{hamiltonian}\PYG{o}{.}\PYG{n}{set\PYGZus{}name}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Mechanical energy}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{c+c1}{\PYGZsh{} Define each Hamiltonian Term}
\PYG{n}{terms} \PYG{o}{=} \PYG{p}{[}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{Term}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Potential energy}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{0.5*q.Tinv.q}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{]}\PYG{p}{)}\PYG{p}{,}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{Term}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Kinetic energy}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{0.5*p*p*rho}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+m+mi}{2}\PYG{p}{]}\PYG{p}{)}\PYG{p}{,}
\PYG{p}{]}
\PYG{c+c1}{\PYGZsh{} Add them to the Hamiltonian}
\PYG{k}{for} \PYG{n}{term} \PYG{o+ow}{in} \PYG{n}{terms}\PYG{p}{:}
    \PYG{n}{wave}\PYG{o}{.}\PYG{n}{hamiltonian}\PYG{o}{.}\PYG{n}{add\PYGZus{}term}\PYG{p}{(}\PYG{n}{term}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Plot the Hamiltonian and save the output}
\PYG{n}{wave}\PYG{o}{.}\PYG{n}{plot\PYGZus{}Hamiltonian}\PYG{p}{(}\PYG{n}{save\PYGZus{}figure}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{)}
\end{sphinxVerbatim}

\noindent\sphinxincludegraphics{{Wave_CoEnergy_Hamiltonian}.png}

\sphinxstepscope


\subsection{Heat wave coupling}
\label{\detokenize{examples/heat_wave:heat-wave-coupling}}\label{\detokenize{examples/heat_wave::doc}}

\subsubsection{Setting}
\label{\detokenize{examples/heat_wave:setting}}\label{\detokenize{examples/heat_wave:heat-wave-2d}}
\sphinxAtStartPar
It is assumed that the \sphinxhref{https://g-haine.github.io/scrimp/examples/wave.html}{2D wave
equation}, the
\sphinxhref{https://g-haine.github.io/scrimp/examples/wave\_coenergy.html}{2D wave equation in co\sphinxhyphen{}energy
formulation}
and the \sphinxhref{https://g-haine.github.io/scrimp/examples/heat.html}{2D heat
equation} have
already been studied.

\sphinxAtStartPar
The objective of this example is to deal with interconnection in the
sense of port\sphinxhyphen{}Hamiltonian systems.

\sphinxAtStartPar
We are interested in the coupled heat\sphinxhyphen{}wave system which can be
formulated as follows: let \(\Omega := \Omega_W \cup \Omega_H\) be a
bounded domain in \(\mathbb{R}^2\) such that
\(\Omega_W \cap \Omega_H = \emptyset\), we denote
\(\Gamma_I := \partial\Omega_W \cap \partial\Omega_H\) the interface
between the two domains, and
\(\Gamma_W := \partial\Omega_W \setminus \Gamma_I\) and
\(\Gamma_H := \partial\Omega_H \setminus \Gamma_I\). The system of
equations reads
\begin{equation*}
\begin{split}\left\lbrace
\begin{array}{rcl}
\partial_t T(t,x) &=& {\rm div}\left( {\rm grad}\left( T(t,x) \right)\right), \quad \forall t\ge0, x \in \Omega_H, \\
\partial_{tt}^2 w(t,x) &=& {\rm div}\left( {\rm grad}\left( T(t,x) \right)\right), \quad \forall t\ge0, x \in \Omega_H, \\
T(t,s) &=& 0, \quad \forall t\ge0, s \in \Gamma_H, \\
w(t,s) &=& 0, \quad \forall t\ge0, s \in \Gamma_W, \\
\end{array}
\right.\end{split}
\end{equation*}
\sphinxAtStartPar
together with the transmission conditions across the interface
\begin{equation*}
\begin{split}\left\lbrace
\begin{array}{rcl}
T(t,s) &=& \partial_t w(t,s), \quad \forall t\ge0, s \in \Gamma_I, \\
\partial_{n_H} T(t,s) &=& - \partial_{n_W} w(t,s), \quad \forall t\ge0, s \in \Gamma_I, \\
\end{array}
\right.\end{split}
\end{equation*}
\sphinxAtStartPar
where \(n_H\) is the outward normal to \(\Omega_H\) and
\(n_W\) is the outward normal to \(\Omega_W\). Hence,
\(n_H = -n_W\) on \(\Gamma_I\).


\subsubsection{Port\sphinxhyphen{}Hamiltonian framework}
\label{\detokenize{examples/heat_wave:port-hamiltonian-framework}}\begin{itemize}
\item {} 
\sphinxAtStartPar
The heat equation

\end{itemize}

\sphinxAtStartPar
The heat equation reads
\begin{equation*}
\begin{split}\begin{pmatrix} \partial_t T \\ e_q \end{pmatrix} =
\begin{bmatrix} 0 & - {\rm div} \\ - {\rm grad} & 0 \end{bmatrix}
\begin{pmatrix} T \\ e_Q \end{pmatrix},\end{split}
\end{equation*}
\sphinxAtStartPar
together with the boundary ports
\begin{equation*}
\begin{split}\left\lbrace
\begin{array}{rcl}
u^I_H &=& T, \quad \Gamma_I, \\
y^I_H &=& e_Q \cdot n_H, \quad \Gamma_I,
\end{array}
\right.\end{split}
\end{equation*}
\sphinxAtStartPar
and
\begin{equation*}
\begin{split}\left\lbrace
\begin{array}{rcl}
u_H &=& T, \quad \Gamma_H, \\
y_H &=& e_Q \cdot n_H, \quad \Gamma_H.
\end{array}
\right.\end{split}
\end{equation*}\begin{itemize}
\item {} 
\sphinxAtStartPar
The wave equation

\end{itemize}

\sphinxAtStartPar
The Dirichlet boundary condition has to be relaxed by
\(\partial_t w = 0\) to fit the port\sphinxhyphen{}Hamiltonian framework.
Providing this adaptation and the notation \(p := \partial_t w\) and
\(q := {\rm grad}\left(w\right)\), the wave equation reads
\begin{equation*}
\begin{split}\begin{pmatrix} \partial_t q \\ \partial_t p \end{pmatrix} =
\begin{bmatrix} 0 & {\rm grad} \\ {\rm div} & 0 \end{bmatrix}
\begin{pmatrix} q \\ p \end{pmatrix},\end{split}
\end{equation*}
\sphinxAtStartPar
together with the boundary ports
\begin{equation*}
\begin{split}\left\lbrace
\begin{array}{rcl}
u^I_W &=& q \cdot n_W, \quad \Gamma_I, \\
y^I_W &=& p, \quad \Gamma_I,
\end{array}
\right.\end{split}
\end{equation*}
\sphinxAtStartPar
and
\begin{equation*}
\begin{split}\left\lbrace
\begin{array}{rcl}
u_W &=& q \cdot n_W, \quad \Gamma_H, \\
y_W &=& p, \quad \Gamma_H.
\end{array}
\right.\end{split}
\end{equation*}\begin{itemize}
\item {} 
\sphinxAtStartPar
The interconnection

\end{itemize}

\sphinxAtStartPar
The transmission condition at the interface may be recast as a
power\sphinxhyphen{}preserving interconnection. It can be either a \sphinxstylestrong{gyrator} or a
\sphinxstylestrong{tranformer} interconnection, depending on the chosen causality for
each system. We the above choices, we have a \sphinxstylestrong{gyrator
interconnection}, indeed, one has
\begin{equation*}
\begin{split}u^I_H = y^I_w, \qquad u^I_W = y^I_H.\end{split}
\end{equation*}

\subsubsection{Structure\sphinxhyphen{}preserving discretization}
\label{\detokenize{examples/heat_wave:structure-preserving-discretization}}\begin{itemize}
\item {} 
\sphinxAtStartPar
The heat equation

\end{itemize}

\sphinxAtStartPar
We use the div\sphinxhyphen{}div formulation already presented in the \sphinxhref{https://g-haine.github.io/scrimp/examples/heat.html}{2D heat
equation}
example, \sphinxstyleemphasis{i.e.} we obtain the following system
\begin{equation*}
\begin{split}\underbrace{\begin{bmatrix}
M_T & 0 & 0 & 0 \\
0 & M_Q & 0 & 0 \\
0 & 0 & M^I_H & 0 \\
0 & 0 & 0 & M_H
\end{bmatrix}}_{= M}
\begin{pmatrix}
\frac{\rm d}{{\rm d}t} \underline{T}(t) \\
\underline{e_Q}(t) \\
-\underline{y^I_H}(t) \\
-\underline{y_H}(t)
\end{pmatrix}
=
\underbrace{\begin{bmatrix}
0 & D & 0 & 0 \\
-D^\top & 0 & B^I_H & B_H \\
0 & -(B^I_H)^\top & 0 & 0 \\
0 & -(B_H)^\top & 0 & 0
\end{bmatrix}}_{= J}
\begin{pmatrix}
\underline{T}(t) \\
\underline{e_Q}(t) \\
\underline{u^I_H}(t) \\
\underline{u_H}(t)
\end{pmatrix},\end{split}
\end{equation*}\begin{itemize}
\item {} 
\sphinxAtStartPar
The wave equation

\end{itemize}

\sphinxAtStartPar
We use the grad\sphinxhyphen{}grad formulation already presented in the \sphinxhref{https://g-haine.github.io/scrimp/examples/wave.html}{2D wave
equation}
example, \sphinxstyleemphasis{i.e.} we obtain the following system
\begin{equation*}
\begin{split}\underbrace{\begin{bmatrix}
M_q & 0 & 0 & 0 \\
0 & M_p & 0 & 0 \\
0 & 0 & M^I_W & 0 \\
0 & 0 & 0 & M_W
\end{bmatrix}}_{= M}
\begin{pmatrix}
\frac{\rm d}{{\rm d}t} \underline{q}(t) \\
\frac{\rm d}{{\rm d}t} \underline{p}(t) \\
-\underline{y^I_W}(t) \\
\underline{u_W}(t)
\end{pmatrix}
=
\underbrace{\begin{bmatrix}
0 & D & 0 & 0 \\
-D^\top & 0 & B^I_W & -B_W^\top \\
0 & -(B^I_W)^\top & 0 & 0 \\
0 & B_W & 0 & 0
\end{bmatrix}}_{= J}
\begin{pmatrix}
\underline{q}(t) \\
\underline{p}(t) \\
\underline{u^I_W}(t) \\
-\underline{y_W}(t)
\end{pmatrix},\end{split}
\end{equation*}\begin{itemize}
\item {} 
\sphinxAtStartPar
The transformer interconnection

\end{itemize}

\sphinxAtStartPar
This condition is easy to implement, and leads to
\begin{equation*}
\begin{split}M^I_H \underline{u^I_H}(t) = M^I_W \underline{y^I_W}(t), \qquad M^I_W \underline{u^I_W}(t) = M^I_H \underline{y^I_H}(t).\end{split}
\end{equation*}

\subsubsection{Simulation}
\label{\detokenize{examples/heat_wave:simulation}}
\sphinxAtStartPar
Let us start as usual, but using now the \sphinxcode{\sphinxupquote{Concentric}} built\sphinxhyphen{}in
geometry.

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{} Import scrimp}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{scrimp}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{S}

\PYG{c+c1}{\PYGZsh{} Init the distributed port\PYGZhy{}Hamiltonian system}
\PYG{n}{hw} \PYG{o}{=} \PYG{n}{S}\PYG{o}{.}\PYG{n}{DPHS}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{real}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Set the domain (using the built\PYGZhy{}in geometry `Concentric`)}
\PYG{c+c1}{\PYGZsh{} Labels: Disk = 1, Annulus = 2, Interface = 10, Boundary = 20}
\PYG{n}{omega} \PYG{o}{=} \PYG{n}{S}\PYG{o}{.}\PYG{n}{Domain}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Concentric}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{p}{\PYGZob{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{R}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+m+mf}{1.0}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{r}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+m+mf}{0.6}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{h}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+m+mf}{0.1}\PYG{p}{\PYGZcb{}}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} And add it to the dphs}
\PYG{n}{hw}\PYG{o}{.}\PYG{n}{set\PYGZus{}domain}\PYG{p}{(}\PYG{n}{omega}\PYG{p}{)}
\end{sphinxVerbatim}

\sphinxAtStartPar
It is important to remember here one of the objective of this example:
to understand the \sphinxcode{\sphinxupquote{region}} keyword.

\sphinxAtStartPar
For our study case, the heat equation will lie on a region
\sphinxcode{\sphinxupquote{heat\_region}}, while the wave equation will lie on another region
\sphinxcode{\sphinxupquote{wave\_region}}. And this has to be stated when defining the states and
co\sphinxhyphen{}states, and everytime an integral (either the \sphinxstyleemphasis{weak forms} or the
\sphinxstyleemphasis{Hamiltonian terms}) occurs.

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{} Define the states and costates, needs the heat and wave region\PYGZsq{}s labels}
\PYG{n}{heat\PYGZus{}region} \PYG{o}{=} \PYG{l+m+mi}{1}
\PYG{n}{wave\PYGZus{}region} \PYG{o}{=} \PYG{l+m+mi}{2}
\PYG{n}{states} \PYG{o}{=} \PYG{p}{[}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{State}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{T}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Temperature}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{scalar\PYGZhy{}field}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{region}\PYG{o}{=}\PYG{n}{heat\PYGZus{}region}\PYG{p}{)}\PYG{p}{,}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{State}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{p}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Velocity}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{scalar\PYGZhy{}field}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{region}\PYG{o}{=}\PYG{n}{wave\PYGZus{}region}\PYG{p}{)}\PYG{p}{,}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{State}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{q}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Stress}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{vector\PYGZhy{}field}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{region}\PYG{o}{=}\PYG{n}{wave\PYGZus{}region}\PYG{p}{)}\PYG{p}{,}
\PYG{p}{]}
\PYG{c+c1}{\PYGZsh{} Use of the `substituted=True` keyword to get the co\PYGZhy{}energy formulation}
\PYG{n}{costates} \PYG{o}{=} \PYG{p}{[}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{CoState}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{T}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Temperature}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{states}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{,} \PYG{n}{substituted}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{)}\PYG{p}{,}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{CoState}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{p}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Velocity}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{states}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,} \PYG{n}{substituted}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{)}\PYG{p}{,}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{CoState}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{q}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Stress}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{states}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{]}\PYG{p}{,} \PYG{n}{substituted}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{)}\PYG{p}{,}
\PYG{p}{]}

\PYG{c+c1}{\PYGZsh{} Add them to the dphs}
\PYG{k}{for} \PYG{n}{state} \PYG{o+ow}{in} \PYG{n}{states}\PYG{p}{:}
    \PYG{n}{hw}\PYG{o}{.}\PYG{n}{add\PYGZus{}state}\PYG{p}{(}\PYG{n}{state}\PYG{p}{)}
\PYG{k}{for} \PYG{n}{costate} \PYG{o+ow}{in} \PYG{n}{costates}\PYG{p}{:}
    \PYG{n}{hw}\PYG{o}{.}\PYG{n}{add\PYGZus{}costate}\PYG{p}{(}\PYG{n}{costate}\PYG{p}{)}
\end{sphinxVerbatim}

\sphinxAtStartPar
The same is true for the resistive port for the heat equation.

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{} Define the algebraic port}
\PYG{n}{ports} \PYG{o}{=} \PYG{p}{[}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{Port}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Heat flux}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{e\PYGZus{}Q}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{e\PYGZus{}Q}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{vector\PYGZhy{}field}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{substituted}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{,} \PYG{n}{region}\PYG{o}{=}\PYG{n}{heat\PYGZus{}region}\PYG{p}{)}\PYG{p}{,}
\PYG{p}{]}

\PYG{c+c1}{\PYGZsh{} Add it to the dphs}
\PYG{k}{for} \PYG{n}{port} \PYG{o+ow}{in} \PYG{n}{ports}\PYG{p}{:}
    \PYG{n}{hw}\PYG{o}{.}\PYG{n}{add\PYGZus{}port}\PYG{p}{(}\PYG{n}{port}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Define the control ports}
\PYG{n}{control\PYGZus{}ports} \PYG{o}{=} \PYG{p}{[}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{Control\PYGZus{}Port}\PYG{p}{(}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Interface Heat}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{U\PYGZus{}T}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Heat flux}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Y\PYGZus{}T}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Temperature}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{scalar\PYGZhy{}field}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{n}{region}\PYG{o}{=}\PYG{l+m+mi}{10}\PYG{p}{,}
        \PYG{n}{position}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{effort}\PYG{l+s+s2}{\PYGZdq{}}
    \PYG{p}{)}\PYG{p}{,}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{Control\PYGZus{}Port}\PYG{p}{(}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Interface Wave}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{U\PYGZus{}w}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Velocity}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Y\PYGZus{}w}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Velocity}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{scalar\PYGZhy{}field}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{n}{region}\PYG{o}{=}\PYG{l+m+mi}{10}\PYG{p}{,}
        \PYG{n}{position}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{effort}\PYG{l+s+s2}{\PYGZdq{}}
    \PYG{p}{)}\PYG{p}{,}
    \PYG{c+c1}{\PYGZsh{} This port will be either for the wave or the heat equation}
    \PYG{c+c1}{\PYGZsh{} It corresponds to the exterior circle of radius R}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{Control\PYGZus{}Port}\PYG{p}{(}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Boundary}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{U\PYGZus{}bnd}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{0}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Y\PYGZus{}bnd}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{.}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{scalar\PYGZhy{}field}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{n}{region}\PYG{o}{=}\PYG{l+m+mi}{20}\PYG{p}{,}
        \PYG{n}{position}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{flow}\PYG{l+s+s2}{\PYGZdq{}}
    \PYG{p}{)}\PYG{p}{,}
\PYG{p}{]}

\PYG{c+c1}{\PYGZsh{} Add it to the dphs}
\PYG{k}{for} \PYG{n}{ctrl\PYGZus{}port} \PYG{o+ow}{in} \PYG{n}{control\PYGZus{}ports}\PYG{p}{:}
    \PYG{n}{hw}\PYG{o}{.}\PYG{n}{add\PYGZus{}control\PYGZus{}port}\PYG{p}{(}\PYG{n}{ctrl\PYGZus{}port}\PYG{p}{)}
\end{sphinxVerbatim}

\sphinxAtStartPar
For the FEM choices, see the previous examples.

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{} Define the Finite Elements Method of each port}
\PYG{n}{k} \PYG{o}{=} \PYG{l+m+mi}{1}
\PYG{n}{FEMs} \PYG{o}{=} \PYG{p}{[}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{FEM}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{T}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{k}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{DG}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{FEM}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Heat flux}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{k}\PYG{o}{+}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{CG}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{FEM}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Interface Heat}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{k}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{DG}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{FEM}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{p}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{k}\PYG{o}{+}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{CG}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{FEM}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{q}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{k}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{DG}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{FEM}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Interface Wave}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{k}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{DG}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{FEM}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Boundary}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{k}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{DG}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}
\PYG{p}{]}

\PYG{c+c1}{\PYGZsh{} Add them to the dphs}
\PYG{k}{for} \PYG{n}{FEM} \PYG{o+ow}{in} \PYG{n}{FEMs}\PYG{p}{:}
    \PYG{n}{hw}\PYG{o}{.}\PYG{n}{add\PYGZus{}FEM}\PYG{p}{(}\PYG{n}{FEM}\PYG{p}{)}
\end{sphinxVerbatim}

\sphinxAtStartPar
The \sphinxcode{\sphinxupquote{Brick}} object does not have an \sphinxstyleemphasis{optional} \sphinxcode{\sphinxupquote{region}} keyword, it
is mandatory: more precisely, it requires a list of regions as third
argument.

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{} Define the pHs via `Brick` == non\PYGZhy{}zero block matrices == variational terms}
\PYG{c+c1}{\PYGZsh{} Since we use co\PYGZhy{}energy formulation, constitutive relations are already taken into}
\PYG{c+c1}{\PYGZsh{} account in the mass matrices M\PYGZus{}q and M\PYGZus{}p}
\PYG{n}{bricks} \PYG{o}{=} \PYG{p}{[}
    \PYG{c+c1}{\PYGZsh{} === Heat: div\PYGZhy{}div}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{Brick}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{M\PYGZus{}T}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{T*Test\PYGZus{}T}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{p}{[}\PYG{n}{heat\PYGZus{}region}\PYG{p}{]}\PYG{p}{,} \PYG{n}{dt}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{,} \PYG{n}{position}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{flow}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{Brick}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{M\PYGZus{}Q}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{e\PYGZus{}Q.Test\PYGZus{}e\PYGZus{}Q}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{p}{[}\PYG{n}{heat\PYGZus{}region}\PYG{p}{]}\PYG{p}{,} \PYG{n}{position}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{flow}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{Brick}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{M\PYGZus{}Y\PYGZus{}T}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Y\PYGZus{}T*Test\PYGZus{}Y\PYGZus{}T}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mi}{10}\PYG{p}{]}\PYG{p}{,} \PYG{n}{position}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{flow}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}

    \PYG{n}{S}\PYG{o}{.}\PYG{n}{Brick}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{D\PYGZus{}T}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{\PYGZhy{}Div(e\PYGZus{}Q)*Test\PYGZus{}T}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{p}{[}\PYG{n}{heat\PYGZus{}region}\PYG{p}{]}\PYG{p}{,} \PYG{n}{position}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{effort}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{Brick}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{D\PYGZus{}T\PYGZca{}T}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{T*Div(Test\PYGZus{}e\PYGZus{}Q)}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{p}{[}\PYG{n}{heat\PYGZus{}region}\PYG{p}{]}\PYG{p}{,} \PYG{n}{position}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{effort}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{Brick}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{B\PYGZus{}T}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{U\PYGZus{}T*Test\PYGZus{}e\PYGZus{}Q.Normal}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mi}{10}\PYG{p}{]}\PYG{p}{,} \PYG{n}{position}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{effort}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{Brick}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{B\PYGZus{}T\PYGZca{}T}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{e\PYGZus{}Q.Normal*Test\PYGZus{}Y\PYGZus{}T}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mi}{10}\PYG{p}{]}\PYG{p}{,} \PYG{n}{position}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{effort}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}

    \PYG{c+c1}{\PYGZsh{} === Wave: grad\PYGZhy{}grad}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{Brick}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{M\PYGZus{}p}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{p*Test\PYGZus{}p}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{p}{[}\PYG{n}{wave\PYGZus{}region}\PYG{p}{]}\PYG{p}{,} \PYG{n}{dt}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{,} \PYG{n}{position}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{flow}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{Brick}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{M\PYGZus{}q}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{q.Test\PYGZus{}q}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{p}{[}\PYG{n}{wave\PYGZus{}region}\PYG{p}{]}\PYG{p}{,} \PYG{n}{dt}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{,} \PYG{n}{position}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{flow}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{Brick}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{M\PYGZus{}Y\PYGZus{}w}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Y\PYGZus{}w*Test\PYGZus{}Y\PYGZus{}w}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mi}{10}\PYG{p}{]}\PYG{p}{,} \PYG{n}{position}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{flow}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}

    \PYG{n}{S}\PYG{o}{.}\PYG{n}{Brick}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{D\PYGZus{}w}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{\PYGZhy{}q.Grad(Test\PYGZus{}p)}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{p}{[}\PYG{n}{wave\PYGZus{}region}\PYG{p}{]}\PYG{p}{,} \PYG{n}{position}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{effort}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{Brick}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{\PYGZhy{}D\PYGZus{}w\PYGZca{}T}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Grad(p).Test\PYGZus{}q}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{p}{[}\PYG{n}{wave\PYGZus{}region}\PYG{p}{]}\PYG{p}{,} \PYG{n}{position}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{effort}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{Brick}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{B\PYGZus{}w}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{U\PYGZus{}w*Test\PYGZus{}p}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mi}{10}\PYG{p}{]}\PYG{p}{,} \PYG{n}{position}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{effort}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{Brick}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{B\PYGZus{}w\PYGZca{}T}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{p*Test\PYGZus{}Y\PYGZus{}w}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mi}{10}\PYG{p}{]}\PYG{p}{,} \PYG{n}{position}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{effort}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}
\PYG{p}{]}
\PYG{c+c1}{\PYGZsh{} === Boundary depends on where is the heat equation / wave equation}
\PYG{k}{if} \PYG{n}{wave\PYGZus{}region}\PYG{o}{==}\PYG{l+m+mi}{1}\PYG{p}{:}
    \PYG{n}{bricks}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{S}\PYG{o}{.}\PYG{n}{Brick}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{M\PYGZus{}Y\PYGZus{}bnd}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Y\PYGZus{}bnd*Test\PYGZus{}Y\PYGZus{}bnd}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mi}{20}\PYG{p}{]}\PYG{p}{,} \PYG{n}{position}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{flow}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{)}
    \PYG{n}{bricks}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{S}\PYG{o}{.}\PYG{n}{Brick}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{B\PYGZus{}bnd}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{U\PYGZus{}bnd*Test\PYGZus{}e\PYGZus{}Q.Normal}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mi}{20}\PYG{p}{]}\PYG{p}{,} \PYG{n}{position}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{effort}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{)}
    \PYG{n}{bricks}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{S}\PYG{o}{.}\PYG{n}{Brick}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{B\PYGZus{}bnd\PYGZca{}T}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{e\PYGZus{}Q.Normal*Test\PYGZus{}Y\PYGZus{}bnd}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mi}{20}\PYG{p}{]}\PYG{p}{,} \PYG{n}{position}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{effort}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{)}
\PYG{k}{else}\PYG{p}{:}
    \PYG{n}{bricks}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{S}\PYG{o}{.}\PYG{n}{Brick}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{M\PYGZus{}Y\PYGZus{}bnd}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{U\PYGZus{}bnd*Test\PYGZus{}Y\PYGZus{}bnd}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mi}{20}\PYG{p}{]}\PYG{p}{,} \PYG{n}{position}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{flow}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{)}
    \PYG{n}{bricks}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{S}\PYG{o}{.}\PYG{n}{Brick}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{B\PYGZus{}bnd}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Y\PYGZus{}bnd*Test\PYGZus{}p}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mi}{20}\PYG{p}{]}\PYG{p}{,} \PYG{n}{position}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{effort}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{)}
    \PYG{n}{bricks}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{S}\PYG{o}{.}\PYG{n}{Brick}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{B\PYGZus{}bnd\PYGZca{}T}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{p*Test\PYGZus{}Y\PYGZus{}bnd}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mi}{20}\PYG{p}{]}\PYG{p}{,} \PYG{n}{position}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{effort}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{)}
\PYG{k}{for} \PYG{n}{brick} \PYG{o+ow}{in} \PYG{n}{bricks}\PYG{p}{:}
    \PYG{n}{hw}\PYG{o}{.}\PYG{n}{add\PYGZus{}brick}\PYG{p}{(}\PYG{n}{brick}\PYG{p}{)}
\end{sphinxVerbatim}

\sphinxAtStartPar
Finally, the \sphinxstylestrong{gyrator} interconnection for a system is just an output
feedback from the other. The subtility is that, while the normal along
\(\Gamma_I\) depends from which side it is computed \sphinxstyleemphasis{on paper}, this
is not the case \sphinxstyleemphasis{numerically}: a minus sign is necessary.

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{} Set the controls}
\PYG{c+c1}{\PYGZsh{} === Gyrator interconnection}
\PYG{n}{hw}\PYG{o}{.}\PYG{n}{set\PYGZus{}control}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Interface Heat}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Y\PYGZus{}w}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{c+c1}{\PYGZsh{} CAREFUL: the numerical normal is the same for both sub\PYGZhy{}domains! Hence the minus sign.}
\PYG{n}{hw}\PYG{o}{.}\PYG{n}{set\PYGZus{}control}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Interface Wave}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{\PYGZhy{}Y\PYGZus{}T}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{c+c1}{\PYGZsh{} === Dirichlet boundary condition}
\PYG{n}{hw}\PYG{o}{.}\PYG{n}{set\PYGZus{}control}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Boundary}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{0.}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Set the initial data}
\PYG{n}{hw}\PYG{o}{.}\PYG{n}{set\PYGZus{}initial\PYGZus{}value}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{T}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{5.*np.exp(\PYGZhy{}25*((x\PYGZhy{}0.6)*(x\PYGZhy{}0.6)+y*y))}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n}{hw}\PYG{o}{.}\PYG{n}{set\PYGZus{}initial\PYGZus{}value}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{p}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{5.*np.exp(\PYGZhy{}25*((x\PYGZhy{}0.6)*(x\PYGZhy{}0.6)+y*y))}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n}{hw}\PYG{o}{.}\PYG{n}{set\PYGZus{}initial\PYGZus{}value}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{q}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{[0.,0.]}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{}\PYGZsh{} Solve in time}
\PYG{c+c1}{\PYGZsh{} Define the time scheme (\PYGZdq{}bdf\PYGZdq{} is backward differentiation formula)}
\PYG{n}{hw}\PYG{o}{.}\PYG{n}{set\PYGZus{}time\PYGZus{}scheme}\PYG{p}{(}\PYG{n}{ts\PYGZus{}type}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{bdf}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
                   \PYG{n}{t\PYGZus{}f}\PYG{o}{=}\PYG{l+m+mf}{15.}\PYG{p}{,}
                   \PYG{n}{dt}\PYG{o}{=}\PYG{l+m+mf}{0.001}\PYG{p}{,}
                   \PYG{n}{dt\PYGZus{}save}\PYG{o}{=}\PYG{l+m+mf}{0.05}\PYG{p}{,}
                   \PYG{n}{ksp\PYGZus{}type}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{preonly}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
                   \PYG{n}{pc\PYGZus{}type}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{lu}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
                   \PYG{n}{pc\PYGZus{}factor\PYGZus{}mat\PYGZus{}solver\PYGZus{}type}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{mumps}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
                   \PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Solve}
\PYG{n}{hw}\PYG{o}{.}\PYG{n}{solve}\PYG{p}{(}\PYG{p}{)}
\end{sphinxVerbatim}

\sphinxAtStartPar
We end as usual with the Hamiltonian plot. Since our study case is known
to be strongly stable, but never exponential nor uniformly in the
initial state, we may also invocate the \sphinxcode{\sphinxupquote{get\_Hamiltonian}} method to
make a log\sphinxhyphen{}log view of its evolution.

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{}\PYGZsh{} Post\PYGZhy{}processing}
\PYG{c+c1}{\PYGZsh{}\PYGZsh{} Set Hamiltonian\PYGZsq{}s name}
\PYG{n}{hw}\PYG{o}{.}\PYG{n}{hamiltonian}\PYG{o}{.}\PYG{n}{set\PYGZus{}name}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Hamiltonian}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{c+c1}{\PYGZsh{} Define each Hamiltonian Term}
\PYG{n}{terms} \PYG{o}{=} \PYG{p}{[}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{Term}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Lyapunov heat}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{0.5*T*T}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{p}{[}\PYG{n}{heat\PYGZus{}region}\PYG{p}{]}\PYG{p}{)}\PYG{p}{,}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{Term}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Kinetic energy}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{0.5*p*p}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{p}{[}\PYG{n}{wave\PYGZus{}region}\PYG{p}{]}\PYG{p}{)}\PYG{p}{,}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{Term}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Potential energy}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{0.5*q.q}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{p}{[}\PYG{n}{wave\PYGZus{}region}\PYG{p}{]}\PYG{p}{)}\PYG{p}{,}
\PYG{p}{]}
\PYG{c+c1}{\PYGZsh{} Add them to the Hamiltonian}
\PYG{k}{for} \PYG{n}{term} \PYG{o+ow}{in} \PYG{n}{terms}\PYG{p}{:}
    \PYG{n}{hw}\PYG{o}{.}\PYG{n}{hamiltonian}\PYG{o}{.}\PYG{n}{add\PYGZus{}term}\PYG{p}{(}\PYG{n}{term}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Plot the Hamiltonian and save the output}
\PYG{n}{hw}\PYG{o}{.}\PYG{n}{plot\PYGZus{}Hamiltonian}\PYG{p}{(}\PYG{n}{save\PYGZus{}figure}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{,} \PYG{n}{filename}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Hamiltonian\PYGZus{}Heat}\PYG{l+s+s2}{\PYGZdq{}}\PYG{o}{+}\PYG{n+nb}{str}\PYG{p}{(}\PYG{n}{heat\PYGZus{}region}\PYG{p}{)}\PYG{o}{+}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{\PYGZus{}Wave}\PYG{l+s+s2}{\PYGZdq{}}\PYG{o}{+}\PYG{n+nb}{str}\PYG{p}{(}\PYG{n}{wave\PYGZus{}region}\PYG{p}{)}\PYG{o}{+}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{\PYGZus{}2D.png}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Plot the Hamiltonian in log\PYGZhy{}log scale}
\PYG{n}{t} \PYG{o}{=} \PYG{n}{hw}\PYG{o}{.}\PYG{n}{solution}\PYG{p}{[}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{t}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{]}
\PYG{n}{Hamiltonian} \PYG{o}{=} \PYG{n}{hw}\PYG{o}{.}\PYG{n}{get\PYGZus{}Hamiltonian}\PYG{p}{(}\PYG{p}{)}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{matplotlib}\PYG{n+nn}{.}\PYG{n+nn}{pyplot}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{plt}
\PYG{n}{fig} \PYG{o}{=} \PYG{n}{plt}\PYG{o}{.}\PYG{n}{figure}\PYG{p}{(}\PYG{n}{figsize}\PYG{o}{=}\PYG{p}{[}\PYG{l+m+mi}{8}\PYG{p}{,} \PYG{l+m+mi}{5}\PYG{p}{]}\PYG{p}{)}
\PYG{n}{ax} \PYG{o}{=} \PYG{n}{fig}\PYG{o}{.}\PYG{n}{add\PYGZus{}subplot}\PYG{p}{(}\PYG{l+m+mi}{111}\PYG{p}{)}
\PYG{n}{ax}\PYG{o}{.}\PYG{n}{loglog}\PYG{p}{(}\PYG{n}{t}\PYG{p}{,} \PYG{n}{Hamiltonian}\PYG{p}{)}
\PYG{n}{ax}\PYG{o}{.}\PYG{n}{grid}\PYG{p}{(}\PYG{n}{axis}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{both}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n}{ax}\PYG{o}{.}\PYG{n}{set\PYGZus{}xlabel}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{time t}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n}{ax}\PYG{o}{.}\PYG{n}{set\PYGZus{}ylabel}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Hamiltonian}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n}{ax}\PYG{o}{.}\PYG{n}{set\PYGZus{}title}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Evolution of the Hamiltonian (log\PYGZhy{}log)}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n}{plt}\PYG{o}{.}\PYG{n}{show}\PYG{p}{(}\PYG{p}{)}
\end{sphinxVerbatim}

\noindent\sphinxincludegraphics{{Heat_Wave_Hamiltonian}.png}

\noindent\sphinxincludegraphics{{Heat_Wave_Hamiltonian_log}.png}

\sphinxstepscope


\subsection{The shallow water equation}
\label{\detokenize{examples/shallow_water:the-shallow-water-equation}}\label{\detokenize{examples/shallow_water::doc}}

\subsubsection{Setting}
\label{\detokenize{examples/shallow_water:setting}}\label{\detokenize{examples/shallow_water:shallow-water-2d}}
\sphinxAtStartPar
The objective of this example is to show how to deal with
\sphinxstylestrong{non\sphinxhyphen{}linearity}.

\sphinxAtStartPar
Let us consider a bounded domain \(\Omega \subset \mathbb{R}^2\).
The shallow water equations are constituted of two conservation laws
\begin{equation*}
\begin{split}\begin{pmatrix}
\partial_t h \\ \partial_t p
\end{pmatrix}
= \begin{bmatrix}
0 & - {\rm div} \\
-{\rm grad} & \frac{1}{h} G(\omega)
\end{bmatrix}
\begin{pmatrix}
{e}_h \\ {e_p}
\end{pmatrix} ,\end{split}
\end{equation*}
\sphinxAtStartPar
where \(h\) is the height of the fluid, \(v\) is the velocity,
\(\rho\) is the fluid density (supposed constant),
\(p := \rho v\) is the linear momentum,
\(\omega := {\rm curl}_{2D} \left( v \right) := \partial_x v_y - \partial_y v_x\)
is the vorticity,
\(G(\omega):=\rho \begin{bmatrix} 0 & 1 \\ -1 & 0 \end{bmatrix}\,{\omega}\),
\(e_h = \frac{1}{2} \rho\,\|v\|^2 + \rho g h\) is the total pressure
and \(e_p = h v\) is the volumetric flow of the fluid. Thus, the
first line of the matrix equation represents the conservation of the
mass (or volume, since the fluid is assumed to be incompressible) and
the second represents the conservation of linear momentum.


\subsubsection{Port\sphinxhyphen{}Hamiltonian framework}
\label{\detokenize{examples/shallow_water:port-hamiltonian-framework}}
\sphinxAtStartPar
One can define the system Hamiltonian (or total energy) as a functional
of \(h\) and \(p\), which are thus called energy variables
\begin{equation*}
\begin{split}\mathcal{H} (h,p) := \frac{1}{2} \int_\Omega \frac{h(t,x) \| p(t,x) \|^2}{\rho} + \rho g h^2(t,x) {\rm d}x.\end{split}
\end{equation*}
\sphinxAtStartPar
The co\sphinxhyphen{}energy variables can be computed from the variational derivative
of the Hamiltonian such that
\begin{equation*}
\begin{split}\begin{split}
    e_h & = \delta_h \mathcal{H} = \frac{1}{2} \rho \| v \|^2 +  \rho g h , \\
    e_p & = \delta_{p} \mathcal{H} = h v .
\end{split}\end{split}
\end{equation*}
\sphinxAtStartPar
The time\sphinxhyphen{}derivative of the Hamiltonian can then be obtained computed and
depends only on the boundary variables
\begin{equation*}
\begin{split}\frac{\rm d}{{\rm d}t} \mathcal{H} =  - \int_{\partial\Omega} e_h(t,s) e_p(t,s) \cdot n(s) {\rm d}s ,\end{split}
\end{equation*}
\sphinxAtStartPar
which enables to define collocated control and observation distributed
ports along the boundary \(\partial\Omega\). For example, one may
define
\begin{equation*}
\begin{split}\begin{split}
     u_{\partial} & = - e_p \cdot n,\\
     y_{\partial} & = e_h,
 \end{split}\end{split}
\end{equation*}
\sphinxAtStartPar
and the power\sphinxhyphen{}balance is given by a product between input and output
boundary ports. The system is lossless, and conservative in the absence
of control.


\subsubsection{Structure\sphinxhyphen{}preserving discretization}
\label{\detokenize{examples/shallow_water:structure-preserving-discretization}}
\sphinxAtStartPar
First, let us multiply the linear momentum conservation equation by
\(h\).

\sphinxAtStartPar
Let us consider sufficiently regular test functions \(\varphi\) and
\(\Phi\) on \(\Omega\), and \(\psi\) test functions at the
boundary \(\partial\Omega\). The weak form of the previous equations
reads
\begin{equation*}
\begin{split}\left\lbrace
\begin{array}{rcl}
\left( \partial_t h, \varphi \right)_{L^2} &=& - \left( {\rm div}\left( h e_p \right), \varphi \right)_{L^2}, \\
\left( h \partial_t p, \Phi \right)_{(L^2)^2} &=& - \left( h {\rm grad}\left( e_h \right), \Phi \right)_{(L^2)^2}
                        + \left( {\rm curl}_{2D}\left( p \right) \begin{bmatrix} 0 & 1 \\ -1 & 0 \end{bmatrix} e_p, \Phi \right)_{(L^2)^2}, \\
\left( y_\partial, \psi \right)_{\partial\Omega} &=& \left( e_h, \psi \right)_{\partial\Omega}.
\end{array}
\right.\end{split}
\end{equation*}
\sphinxAtStartPar
Applying integration by parts on the first line leads to
\begin{equation*}
\begin{split}\left\lbrace
\begin{array}{rcl}
\left( \partial_t h, \varphi \right)_{L^2} &=& \left( h e_p, {\rm grad} \left( \varphi \right) \right)_{L^2} + \left( h u_\partial, \varphi \right)_{\partial\Omega}, \\
\left( h \partial_t p, \Phi \right)_{(L^2)^2} &=& - \left( h {\rm grad} \left( e_h \right), \Phi \right)_{(L^2)^2}
                        + \left( {\rm curl}_{2D}\left( p \right) \begin{bmatrix} 0 & 1 \\ -1 & 0 \end{bmatrix} e_p, \Phi \right)_{(L^2)^2}, \\
\left( y_\partial, \psi \right)_{\partial\Omega} &=& \left( e_h, \psi \right)_{\partial\Omega}.
\end{array}
\right.\end{split}
\end{equation*}
\sphinxAtStartPar
Furthermore, the weak form of the constitutive relations write
\begin{equation*}
\begin{split}\left\lbrace
\begin{array}{rcl}
\left( e_h, \varphi \right)_{L^2} &=& \left( \rho g h, \varphi \right)_{L^2} + \left( \frac{\| p \|^2}{2 \rho}, \varphi \right)_{L^2}, \\
\left( e_p, \Phi \right)_{(L^2)^2} &=& \left( \frac{p}{\rho}, \Phi \right)_{(L^2)^2}.
\end{array}
\right.\end{split}
\end{equation*}
\sphinxAtStartPar
Now, let us choose three finite families
\((\varphi^i)_{1 \le i \le N_h} \subset H^1(\Omega)\),
\((\Phi^k)_{1 \le k \le N_p} \subset (L^2(\Omega))^2\) and
\((\psi^m)_{1 \le m \le N_\partial}\) and project the weak
formulations on them: for all \(1 \le i \le N_h\), all
\(1 \le k \le N_p\) and all \(1 \le m \le N_\partial\)
\begin{equation*}
\begin{split}\left\lbrace
\begin{array}{rcl}
\sum_{j=1}^{N_h} \frac{\rm d}{{\rm d}t} h^j \left( \varphi^j, \varphi^i \right)_{L^2} &=& \sum_{\ell=1}^{N_p} e_p^\ell \left( h^d \Phi^\ell, {\rm grad} \left( \varphi^i \right) \right)_{L^2} + \sum_{n=1}^{N_\partial} u_\partial^n \left( h^d \psi^n, \varphi^i \right)_{\partial\Omega}, \\
\sum_{\ell=1}^{N_p} \frac{\rm d}{{\rm d}t} p^\ell \left( h^d \Phi^\ell, \Phi^k \right)_{(L^2)^2} &=& - \sum_{j=1}^{N_h} e_h^j \left( h^d {\rm grad} \left( \varphi^j \right), \Phi^k \right)_{(L^2)^2} \\
                       && \quad + \sum_{\ell=1}^{N_p} e_p^\ell \left( {\rm curl}_{2D}\left( p^d \right) \begin{bmatrix} 0 & 1 \\ -1 & 0 \end{bmatrix} \Phi^\ell, \Phi^k \right)_{(L^2)^2}, \\
\sum_{n=1}^{N_\partial} y_\partial^n \left( \psi^n, \psi^m \right)_{\partial\Omega} &=& \sum_{j=1}^{N_h} e_h^j \left( \varphi^j, \psi^m \right)_{\partial\Omega},
\end{array}
\right.\end{split}
\end{equation*}
\sphinxAtStartPar
where \(h^d := \sum_{i=1}^{N_h} h^i \varphi^i\) is the approximation
of \(h\) and \(p^d := \sum_{k=1}^{N_p} p^k \Phi^k\) is the
approximation of \(p\). The constitutive relations read for all
\(1 \le i \le N_h\) and all \(1 \le k \le N_p\)
\begin{equation*}
\begin{split}\left\lbrace
\begin{array}{rcl}
\sum_{j=1}^{N_h} e_h^j \left( \varphi^j, \varphi^i \right)_{L^2} &=& \sum_{j=1}^{N_h} h^j \left( \rho g \varphi^j, \varphi^i \right)_{L^2} + \sum_{\ell=1}^{N_p} p^\ell \left( \frac{\Phi^\ell \cdot p^d}{2 \rho}, \varphi^i \right)_{L^2}, \\
\sum_{\ell=1}^{N_p} e_p^\ell \left( \Phi^\ell, \Phi^k \right)_{(L^2)^2} &=& \sum_{\ell=1}^{N_p} p^\ell \left( \frac{\Phi^\ell}{\rho}, \Phi^k \right)_{(L^2)^2}.
\end{array}
\right.\end{split}
\end{equation*}
\sphinxAtStartPar
Defining \(\underline{\star}\) the vector gathering the coefficient
of the approximation of the variable \(\star\) in its appropriate
finite family, one may write the discrete weak formulations in matrix
notation
\begin{equation*}
\begin{split}\begin{bmatrix} M_h & 0 & 0 \\ 0 & M_p[h^d] & 0 \\ 0 & 0 & M_\partial \end{bmatrix} \begin{pmatrix} \underline{h} \\ \underline{p} \\ -\underline{y_\partial} \end{pmatrix}
=
\begin{bmatrix}
0 & D[h^d] & B[h^d] \\
-D[h^d]^\top & G[p^d] & 0 \\
- B^\top & 0 & 0
\end{bmatrix}
\begin{pmatrix} \underline{e_h} \\ \underline{e_p} \\ \underline{u_\partial} \end{pmatrix}.\end{split}
\end{equation*}
\sphinxAtStartPar
where the matrices are given by
\begin{equation*}
\begin{split}(M_h)_{ij} := \left( \varphi^j, \varphi^i \right)_{L^2} \qquad (M_p[h^d])_{k\ell} := \left( h^d \Phi^\ell, \Phi^k \right)_{(L^2)^2},\end{split}
\end{equation*}\begin{equation*}
\begin{split}(D[h^d])_{i\ell} := \left( h^d \Phi^\ell, {\rm grad} \left( \varphi^i \right) \right)_{L^2}, \qquad (B[h^d])_{in} := \left( h^d \psi^n, \varphi^i \right)_{\partial\Omega},\end{split}
\end{equation*}
\sphinxAtStartPar
and
\begin{equation*}
\begin{split}(M_\partial)_{mn} := \left( \psi^n, \psi^m \right)_{\partial\Omega}, \qquad (B)_{in} := \left( \psi^n, \varphi^i \right)_{\partial\Omega}.\end{split}
\end{equation*}
\sphinxAtStartPar
The constitutive relations read
\begin{equation*}
\begin{split}\begin{bmatrix} M_h & 0 \\ 0 & M_p \end{bmatrix} \begin{pmatrix} \underline{e_h} \\ \underline{e_p} \end{pmatrix}
=
\begin{bmatrix}
Q_h & P_h[h^d] \\
0 & Q_p
\end{bmatrix}
\begin{pmatrix} \underline{h} \\ \underline{p} \end{pmatrix},\end{split}
\end{equation*}
\sphinxAtStartPar
where the matrices are given by
\begin{equation*}
\begin{split}(M_p)_{k\ell} := \left( \Phi^\ell, \Phi^k \right)_{(L^2)^2}, \qquad (Q_h)_{ij} := \left( \rho g \varphi^j, \varphi^i \right)_{L^2},\end{split}
\end{equation*}\begin{equation*}
\begin{split}(P_h[h^d])_{i\ell} := \left( \frac{\Phi^\ell \cdot p^d}{2 \rho}, \varphi^i \right)_{L^2}, \qquad (Q_d)_{k\ell} := \left( \frac{\Phi^\ell}{\rho}, \Phi^k \right)_{(L^2)^2}.\end{split}
\end{equation*}
\sphinxAtStartPar
With these definition, one may prove the \sphinxstylestrong{discrete power balance}
\begin{equation*}
\begin{split}\frac{\rm d}{{\rm d}t} \mathcal{H}^d(t) = \underline{u_\partial}^\top(t) M_\partial \underline{y_\partial}(t).\end{split}
\end{equation*}

\subsubsection{Simulation}
\label{\detokenize{examples/shallow_water:simulation}}
\sphinxAtStartPar
The beggining is classical: first import, then create the dphs and set
the domain.

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{} Import scrimp}
\PYG{k+kn}{import}\PYG{+w}{ }\PYG{n+nn}{scrimp}\PYG{+w}{ }\PYG{k}{as}\PYG{+w}{ }\PYG{n+nn}{S}

\PYG{c+c1}{\PYGZsh{} Init the distributed port\PYGZhy{}Hamiltonian system}
\PYG{n}{swe} \PYG{o}{=} \PYG{n}{S}\PYG{o}{.}\PYG{n}{DPHS}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{real}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Set the domain (using the built\PYGZhy{}in geometry `Rectangle`)}
\PYG{c+c1}{\PYGZsh{} Labels: Omega = 1, Gamma\PYGZus{}Bottom = 10, Gamma\PYGZus{}Right = 11, Gamma\PYGZus{}Top = 12, Gamma\PYGZus{}Left = 13}
\PYG{n}{swe}\PYG{o}{.}\PYG{n}{set\PYGZus{}domain}\PYG{p}{(}\PYG{n}{S}\PYG{o}{.}\PYG{n}{Domain}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Rectangle}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{p}{\PYGZob{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{L}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+m+mf}{2.0}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{l}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+m+mf}{0.5}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{h}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{:} \PYG{l+m+mf}{0.1}\PYG{p}{\PYGZcb{}}\PYG{p}{)}\PYG{p}{)}
\end{sphinxVerbatim}

\sphinxAtStartPar
Then the states and co\sphinxhyphen{}states.

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{} Define the states and costates}
\PYG{n}{states} \PYG{o}{=} \PYG{p}{[}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{State}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{h}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Fluid height}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{scalar\PYGZhy{}field}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{State}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{p}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Linear momentum}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{vector\PYGZhy{}field}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}
\PYG{p}{]}
\PYG{n}{costates} \PYG{o}{=} \PYG{p}{[}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{CoState}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{e\PYGZus{}h}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Pressure}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{states}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{)}\PYG{p}{,}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{CoState}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{e\PYGZus{}p}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Velocity}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{n}{states}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{)}\PYG{p}{,}
\PYG{p}{]}

\PYG{c+c1}{\PYGZsh{} Add them to the dphs}
\PYG{k}{for} \PYG{n}{state} \PYG{o+ow}{in} \PYG{n}{states}\PYG{p}{:}
    \PYG{n}{swe}\PYG{o}{.}\PYG{n}{add\PYGZus{}state}\PYG{p}{(}\PYG{n}{state}\PYG{p}{)}
\PYG{k}{for} \PYG{n}{costate} \PYG{o+ow}{in} \PYG{n}{costates}\PYG{p}{:}
    \PYG{n}{swe}\PYG{o}{.}\PYG{n}{add\PYGZus{}costate}\PYG{p}{(}\PYG{n}{costate}\PYG{p}{)}
\end{sphinxVerbatim}

\sphinxAtStartPar
And the control ports.

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{} Define the control ports}
\PYG{n}{control\PYGZus{}ports} \PYG{o}{=} \PYG{p}{[}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{Control\PYGZus{}Port}\PYG{p}{(}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Boundary control 0}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{U\PYGZus{}0}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Normal velocity}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Y\PYGZus{}0}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Fluid height}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{scalar\PYGZhy{}field}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{n}{region}\PYG{o}{=}\PYG{l+m+mi}{10}\PYG{p}{,}
        \PYG{n}{position}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{effort}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
    \PYG{p}{)}\PYG{p}{,}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{Control\PYGZus{}Port}\PYG{p}{(}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Boundary control 1}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{U\PYGZus{}1}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Normal velocity}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Y\PYGZus{}1}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Fluid height}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{scalar\PYGZhy{}field}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{n}{region}\PYG{o}{=}\PYG{l+m+mi}{11}\PYG{p}{,}
        \PYG{n}{position}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{effort}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
    \PYG{p}{)}\PYG{p}{,}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{Control\PYGZus{}Port}\PYG{p}{(}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Boundary control 2}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{U\PYGZus{}2}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Normal velocity}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Y\PYGZus{}2}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Fluid height}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{scalar\PYGZhy{}field}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{n}{region}\PYG{o}{=}\PYG{l+m+mi}{12}\PYG{p}{,}
        \PYG{n}{position}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{effort}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
    \PYG{p}{)}\PYG{p}{,}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{Control\PYGZus{}Port}\PYG{p}{(}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Boundary control 3}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{U\PYGZus{}3}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Normal velocity}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Y\PYGZus{}3}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Fluid height}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{scalar\PYGZhy{}field}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
        \PYG{n}{region}\PYG{o}{=}\PYG{l+m+mi}{13}\PYG{p}{,}
        \PYG{n}{position}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{effort}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
    \PYG{p}{)}\PYG{p}{,}
\PYG{p}{]}

\PYG{c+c1}{\PYGZsh{} Add them to the dphs}
\PYG{k}{for} \PYG{n}{ctrl\PYGZus{}port} \PYG{o+ow}{in} \PYG{n}{control\PYGZus{}ports}\PYG{p}{:}
    \PYG{n}{swe}\PYG{o}{.}\PYG{n}{add\PYGZus{}control\PYGZus{}port}\PYG{p}{(}\PYG{n}{ctrl\PYGZus{}port}\PYG{p}{)}
\end{sphinxVerbatim}

\sphinxAtStartPar
Regarding the FEM, this is more challenging, as non\sphinxhyphen{}linearity are
present. Nevertheless, let us stick to the way we choose until now:
since the \(h\)\sphinxhyphen{}type variables will be derivated, thus we choose
continuous Galerkin approximations of order \(k+1\). The other energy variable is taken as continuous Galerkin approximation of order \(k\), while boundary terms are given by discontinuous Galerkin approximations of order
\(k\).

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{} Define the Finite Elements Method of each port}
\PYG{n}{k} \PYG{o}{=} \PYG{l+m+mi}{1}
\PYG{n}{FEMs} \PYG{o}{=} \PYG{p}{[}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{FEM}\PYG{p}{(}\PYG{n}{states}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{get\PYGZus{}name}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,} \PYG{n}{k}\PYG{o}{+}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n}{FEM}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{CG}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{FEM}\PYG{p}{(}\PYG{n}{states}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{get\PYGZus{}name}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,} \PYG{n}{k}\PYG{p}{,} \PYG{n}{FEM}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{CG}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{FEM}\PYG{p}{(}\PYG{n}{control\PYGZus{}ports}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{o}{.}\PYG{n}{get\PYGZus{}name}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,} \PYG{n}{k}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{DG}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{FEM}\PYG{p}{(}\PYG{n}{control\PYGZus{}ports}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{o}{.}\PYG{n}{get\PYGZus{}name}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,} \PYG{n}{k}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{DG}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{FEM}\PYG{p}{(}\PYG{n}{control\PYGZus{}ports}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{]}\PYG{o}{.}\PYG{n}{get\PYGZus{}name}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,} \PYG{n}{k}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{DG}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{FEM}\PYG{p}{(}\PYG{n}{control\PYGZus{}ports}\PYG{p}{[}\PYG{l+m+mi}{3}\PYG{p}{]}\PYG{o}{.}\PYG{n}{get\PYGZus{}name}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,} \PYG{n}{k}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{DG}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}
\PYG{p}{]}

\PYG{c+c1}{\PYGZsh{} Add them to the dphs}
\PYG{k}{for} \PYG{n}{FEM} \PYG{o+ow}{in} \PYG{n}{FEMs}\PYG{p}{:}
    \PYG{n}{swe}\PYG{o}{.}\PYG{n}{add\PYGZus{}FEM}\PYG{p}{(}\PYG{n}{FEM}\PYG{p}{)}
\end{sphinxVerbatim}

\sphinxAtStartPar
The parameters are \sphinxstyleemphasis{physically meaningful}!

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{} Define physical parameters}
\PYG{n}{rho} \PYG{o}{=} \PYG{l+m+mf}{1000.}
\PYG{n}{g} \PYG{o}{=} \PYG{l+m+mf}{10.}
\PYG{n}{parameters} \PYG{o}{=} \PYG{p}{[}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{Parameter}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{rho}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Mass density}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{scalar\PYGZhy{}field}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{rho}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{h}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{Parameter}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{g}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Gravity}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{scalar\PYGZhy{}field}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+si}{\PYGZob{}}\PYG{n}{g}\PYG{l+s+si}{\PYGZcb{}}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{h}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}
\PYG{p}{]}

\PYG{c+c1}{\PYGZsh{} Add them to the dphs}
\PYG{k}{for} \PYG{n}{parameter} \PYG{o+ow}{in} \PYG{n}{parameters}\PYG{p}{:}
    \PYG{n}{swe}\PYG{o}{.}\PYG{n}{add\PYGZus{}parameter}\PYG{p}{(}\PYG{n}{parameter}\PYG{p}{)}
\end{sphinxVerbatim}

\sphinxAtStartPar
Here are the difficult part. We need to define the weak form of each
block matrices, and take non\sphinxhyphen{}linearities into account. To do so, the
GFWL of GetFEM is transparent, but it is mandatory to say to \sphinxstylestrong{SCRIMP}
that the \sphinxcode{\sphinxupquote{Brick}} is non\sphinxhyphen{}linear, using the keyword \sphinxcode{\sphinxupquote{linear=False}}. It
is also possible to ask for this block to be considered \sphinxstyleemphasis{explicitly} in
the time scheme (\sphinxstyleemphasis{i.e.} it will be computed with the previous time step
values and be considered as a right\sphinxhyphen{}hand side), as done for the
gyroscopic term below, using the keyword \sphinxcode{\sphinxupquote{explicit=True}}.

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{} Define the pHs via `Brick` == non\PYGZhy{}zero block matrices == variational terms}
\PYG{c+c1}{\PYGZsh{} Some macros for the sake of readability}
\PYG{n}{swe}\PYG{o}{.}\PYG{n}{gf\PYGZus{}model}\PYG{o}{.}\PYG{n}{add\PYGZus{}macro}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{div(v)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Trace(Grad(v))}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{swe}\PYG{o}{.}\PYG{n}{gf\PYGZus{}model}\PYG{o}{.}\PYG{n}{add\PYGZus{}macro}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Rot}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{[[0,1],[\PYGZhy{}1,0]]}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{swe}\PYG{o}{.}\PYG{n}{gf\PYGZus{}model}\PYG{o}{.}\PYG{n}{add\PYGZus{}macro}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Curl2D(v)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{div(Rot*v)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{swe}\PYG{o}{.}\PYG{n}{gf\PYGZus{}model}\PYG{o}{.}\PYG{n}{add\PYGZus{}macro}\PYG{p}{(}\PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Gyro(v)}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{,} \PYG{l+s+s1}{\PYGZsq{}}\PYG{l+s+s1}{Curl2D(v)*Rot}\PYG{l+s+s1}{\PYGZsq{}}\PYG{p}{)}
\PYG{n}{bricks} \PYG{o}{=} \PYG{p}{[}
    \PYG{c+c1}{\PYGZsh{} Define the mass matrices of the left\PYGZhy{}hand side of the \PYGZdq{}Dirac structure\PYGZdq{} (position=\PYGZdq{}flow\PYGZdq{})}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{Brick}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{M\PYGZus{}h}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{h * Test\PYGZus{}h}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,} \PYG{n}{dt}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{,} \PYG{n}{position}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{flow}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{Brick}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{M\PYGZus{}p}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{h * p . Test\PYGZus{}p}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,} \PYG{n}{dt}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{,} \PYG{n}{linear}\PYG{o}{=}\PYG{k+kc}{False}\PYG{p}{,} \PYG{n}{position}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{flow}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{Brick}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{M\PYGZus{}Y\PYGZus{}0}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Y\PYGZus{}0 * Test\PYGZus{}Y\PYGZus{}0}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mi}{10}\PYG{p}{]}\PYG{p}{,} \PYG{n}{position}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{flow}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{Brick}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{M\PYGZus{}Y\PYGZus{}1}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Y\PYGZus{}1 * Test\PYGZus{}Y\PYGZus{}1}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mi}{11}\PYG{p}{]}\PYG{p}{,} \PYG{n}{position}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{flow}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{Brick}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{M\PYGZus{}Y\PYGZus{}2}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Y\PYGZus{}2 * Test\PYGZus{}Y\PYGZus{}2}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mi}{12}\PYG{p}{]}\PYG{p}{,} \PYG{n}{position}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{flow}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{Brick}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{M\PYGZus{}Y\PYGZus{}3}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Y\PYGZus{}3 * Test\PYGZus{}Y\PYGZus{}3}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mi}{13}\PYG{p}{]}\PYG{p}{,} \PYG{n}{position}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{flow}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}

    \PYG{c+c1}{\PYGZsh{} Define the first line of the right\PYGZhy{}hand side of the \PYGZdq{}Dirac structure\PYGZdq{} (position=\PYGZdq{}effort\PYGZdq{})}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{Brick}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{\PYGZhy{}D\PYGZca{}T}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{h * e\PYGZus{}p . Grad(Test\PYGZus{}h)}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,} \PYG{n}{linear}\PYG{o}{=}\PYG{k+kc}{False}\PYG{p}{,} \PYG{n}{position}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{effort}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}
    \PYG{c+c1}{\PYGZsh{} with the boundary control}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{Brick}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{B\PYGZus{}0}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{\PYGZhy{} U\PYGZus{}0 * Test\PYGZus{}h}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mi}{10}\PYG{p}{]}\PYG{p}{,} \PYG{n}{position}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{effort}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{Brick}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{B\PYGZus{}1}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{\PYGZhy{} U\PYGZus{}1 * Test\PYGZus{}h}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mi}{11}\PYG{p}{]}\PYG{p}{,} \PYG{n}{position}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{effort}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{Brick}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{B\PYGZus{}2}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{\PYGZhy{} U\PYGZus{}2 * Test\PYGZus{}h}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mi}{12}\PYG{p}{]}\PYG{p}{,} \PYG{n}{position}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{effort}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{Brick}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{B\PYGZus{}3}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{\PYGZhy{} U\PYGZus{}3 * Test\PYGZus{}h}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mi}{13}\PYG{p}{]}\PYG{p}{,} \PYG{n}{position}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{effort}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}
    \PYG{c+c1}{\PYGZsh{} Define the second line of the right\PYGZhy{}hand side of the \PYGZdq{}Dirac structure\PYGZdq{} (position=\PYGZdq{}effort\PYGZdq{})}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{Brick}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{D}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{\PYGZhy{} Grad(e\PYGZus{}h) . Test\PYGZus{}p * h}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,} \PYG{n}{linear}\PYG{o}{=}\PYG{k+kc}{False}\PYG{p}{,} \PYG{n}{position}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{effort}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}
    \PYG{c+c1}{\PYGZsh{} with the gyroscopic term (beware that \PYGZdq{}Curl\PYGZdq{} is not available in the GWFL of getfem)}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{Brick}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{G}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{(Gyro(p) * e\PYGZus{}p) . Test\PYGZus{}p}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,} \PYG{n}{linear}\PYG{o}{=}\PYG{k+kc}{False}\PYG{p}{,} \PYG{n}{explicit}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{,} \PYG{n}{position}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{effort}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}
    \PYG{c+c1}{\PYGZsh{} Define the third line of the right\PYGZhy{}hand side of the \PYGZdq{}Dirac structure\PYGZdq{} (position=\PYGZdq{}effort\PYGZdq{})}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{Brick}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{C\PYGZus{}0}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{\PYGZhy{} e\PYGZus{}h * Test\PYGZus{}Y\PYGZus{}0}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mi}{10}\PYG{p}{]}\PYG{p}{,} \PYG{n}{position}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{effort}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{Brick}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{C\PYGZus{}1}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{\PYGZhy{} e\PYGZus{}h * Test\PYGZus{}Y\PYGZus{}1}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mi}{11}\PYG{p}{]}\PYG{p}{,} \PYG{n}{position}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{effort}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{Brick}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{C\PYGZus{}2}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{\PYGZhy{} e\PYGZus{}h * Test\PYGZus{}Y\PYGZus{}2}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mi}{12}\PYG{p}{]}\PYG{p}{,} \PYG{n}{position}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{effort}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{Brick}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{C\PYGZus{}3}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{\PYGZhy{} e\PYGZus{}h * Test\PYGZus{}Y\PYGZus{}3}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mi}{13}\PYG{p}{]}\PYG{p}{,} \PYG{n}{position}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{effort}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}\PYG{p}{,}

    \PYG{c+c1}{\PYGZsh{}\PYGZsh{} Define the constitutive relations (position=\PYGZdq{}constitutive\PYGZdq{}, the default value)}
    \PYG{c+c1}{\PYGZsh{} For e\PYGZus{}h: first the mass matrix WITH A MINUS because we want an implicit formulation 0 = \PYGZhy{} M e\PYGZus{}h + F(h)}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{Brick}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{\PYGZhy{}M\PYGZus{}e\PYGZus{}h}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{\PYGZhy{} e\PYGZus{}h * Test\PYGZus{}e\PYGZus{}h}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{)}\PYG{p}{,}
    \PYG{c+c1}{\PYGZsh{} second the linear part as a linear brick}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{Brick}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Q\PYGZus{}h}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{rho * g * h * Test\PYGZus{}e\PYGZus{}h}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{)}\PYG{p}{,}
    \PYG{c+c1}{\PYGZsh{} third the non\PYGZhy{}linear part as a non\PYGZhy{}linear brick (linear=False)}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{Brick}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{P\PYGZus{}h}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{0.5 * (p . p) / rho * Test\PYGZus{}e\PYGZus{}h}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{,} \PYG{n}{linear}\PYG{o}{=}\PYG{k+kc}{False}\PYG{p}{)}\PYG{p}{,}
    \PYG{c+c1}{\PYGZsh{} For e\PYGZus{}p: first the mass matrix WITH A MINUS because we want an implicit formulation 0 = \PYGZhy{} M e\PYGZus{}p + F(p)}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{Brick}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{\PYGZhy{}M\PYGZus{}e\PYGZus{}p}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{\PYGZhy{} e\PYGZus{}p . Test\PYGZus{}e\PYGZus{}p}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{)}\PYG{p}{,}
    \PYG{c+c1}{\PYGZsh{} second the LINEAR brick}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{Brick}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Q\PYGZus{}p}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{p / rho . Test\PYGZus{}e\PYGZus{}p}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{)}\PYG{p}{,}
\PYG{p}{]}
\PYG{k}{for} \PYG{n}{brick} \PYG{o+ow}{in} \PYG{n}{bricks}\PYG{p}{:}
    \PYG{n}{swe}\PYG{o}{.}\PYG{n}{add\PYGZus{}brick}\PYG{p}{(}\PYG{n}{brick}\PYG{p}{)}
\end{sphinxVerbatim}

\sphinxAtStartPar
As we just look at how it works, let us consider a step in the height,
no initial velocity, and homogeneous Neumann boundary condition. This
should look like a dam break experiment in a rectangular tank.

\sphinxAtStartPar
\sphinxstylestrong{Remark:} note the use of \sphinxcode{\sphinxupquote{np}}, \sphinxstyleemphasis{i.e.} numpy, in the definition of
the initial height \(h_0\).

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{}\PYGZsh{} Initialize the problem}
\PYG{n}{swe}\PYG{o}{.}\PYG{n}{set\PYGZus{}control}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Boundary control 0}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{0.}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n}{swe}\PYG{o}{.}\PYG{n}{set\PYGZus{}control}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Boundary control 1}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{0.}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n}{swe}\PYG{o}{.}\PYG{n}{set\PYGZus{}control}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Boundary control 2}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{0.}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n}{swe}\PYG{o}{.}\PYG{n}{set\PYGZus{}control}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Boundary control 3}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{0.}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Set the initial data}
\PYG{n}{swe}\PYG{o}{.}\PYG{n}{set\PYGZus{}initial\PYGZus{}value}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{h}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{3. \PYGZhy{} (np.sign(x\PYGZhy{}0.5)+1)/3.}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{n}{swe}\PYG{o}{.}\PYG{n}{set\PYGZus{}initial\PYGZus{}value}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{p}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+sa}{f}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{[ 0., 0.]}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{}\PYGZsh{} Solve in time}
\PYG{c+c1}{\PYGZsh{} Define the time scheme}
\PYG{n}{swe}\PYG{o}{.}\PYG{n}{set\PYGZus{}time\PYGZus{}scheme}\PYG{p}{(}
    \PYG{n}{ts\PYGZus{}type}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{bdf}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,}
    \PYG{n}{ts\PYGZus{}bdf\PYGZus{}order}\PYG{o}{=}\PYG{l+m+mi}{4}\PYG{p}{,}
    \PYG{n}{t\PYGZus{}f}\PYG{o}{=}\PYG{l+m+mf}{0.5}\PYG{p}{,}
    \PYG{n}{dt}\PYG{o}{=}\PYG{l+m+mf}{0.0001}\PYG{p}{,}
    \PYG{n}{dt\PYGZus{}save}\PYG{o}{=}\PYG{l+m+mf}{0.01}\PYG{p}{,}
\PYG{p}{)}

\PYG{c+c1}{\PYGZsh{} Solve the system in time}
\PYG{n}{swe}\PYG{o}{.}\PYG{n}{solve}\PYG{p}{(}\PYG{p}{)}
\end{sphinxVerbatim}

\sphinxAtStartPar
The Hamiltonian are then defined, computed, and shown.

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{}\PYGZsh{} Post\PYGZhy{}processing}
\PYG{c+c1}{\PYGZsh{} Set Hamiltonian\PYGZsq{}s name}
\PYG{n}{swe}\PYG{o}{.}\PYG{n}{hamiltonian}\PYG{o}{.}\PYG{n}{set\PYGZus{}name}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Mechanical energy}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\PYG{c+c1}{\PYGZsh{} Define Hamiltonian terms}
\PYG{n}{terms} \PYG{o}{=} \PYG{p}{[}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{Term}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Kinetic energy}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{0.5*h*p.p/rho}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{)}\PYG{p}{,}
    \PYG{n}{S}\PYG{o}{.}\PYG{n}{Term}\PYG{p}{(}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Potential energy}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{0.5*rho*g*h*h}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{,} \PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{)}\PYG{p}{,}
\PYG{p}{]}
\PYG{c+c1}{\PYGZsh{} Add them to the Hamiltonian}
\PYG{k}{for} \PYG{n}{term} \PYG{o+ow}{in} \PYG{n}{terms}\PYG{p}{:}
    \PYG{n}{swe}\PYG{o}{.}\PYG{n}{hamiltonian}\PYG{o}{.}\PYG{n}{add\PYGZus{}term}\PYG{p}{(}\PYG{n}{term}\PYG{p}{)}
\PYG{c+c1}{\PYGZsh{} Plot the Hamiltonian}
\PYG{n}{swe}\PYG{o}{.}\PYG{n}{plot\PYGZus{}Hamiltonian}\PYG{p}{(}\PYG{n}{save\PYGZus{}figure}\PYG{o}{=}\PYG{k+kc}{True}\PYG{p}{,} \PYG{n}{filename}\PYG{o}{=}\PYG{l+s+s2}{\PYGZdq{}}\PYG{l+s+s2}{Hamiltonian\PYGZus{}Inviscid\PYGZus{}Shallow\PYGZus{}Water\PYGZus{}2D.png}\PYG{l+s+s2}{\PYGZdq{}}\PYG{p}{)}
\end{sphinxVerbatim}

\noindent\sphinxincludegraphics{{Shallow_water_Hamiltonian}.png}

\sphinxstepscope


\section{Notebooks}
\label{\detokenize{notebooks:notebooks}}\label{\detokenize{notebooks::doc}}\phantomsection\label{\detokenize{notebooks:id1}}
\sphinxAtStartPar
Some examples coming from our \sphinxhref{biblio}{publications} are available in \sphinxhref{https://jupyter.org/}{jupyter notebook} format inside the \sphinxcode{\sphinxupquote{notebooks}} folder in \sphinxcode{\sphinxupquote{examples}}.


\subsection{Install jupyter}
\label{\detokenize{notebooks:install-jupyter}}
\sphinxAtStartPar
To begin with, you’ll need to install jupyter.

\sphinxAtStartPar
It can be done in the scrimp environment with:
\begin{enumerate}
\sphinxsetlistlabels{\arabic}{enumi}{enumii}{}{.}%
\item {} 
\sphinxAtStartPar
\sphinxtitleref{conda activate scrimp}

\item {} 
\sphinxAtStartPar
\sphinxtitleref{conda install jupyter ipykernel}

\item {} 
\sphinxAtStartPar
\sphinxtitleref{python \sphinxhyphen{}m ipykernel install \textendash{}user \textendash{}name scrimp \textendash{}display\sphinxhyphen{}name “Python (scrimp)”}

\end{enumerate}


\subsection{Run jupyter}
\label{\detokenize{notebooks:run-jupyter}}
\sphinxAtStartPar
Then, run in the \sphinxcode{\sphinxupquote{notebooks}} folder:

\sphinxAtStartPar
\sphinxtitleref{jupyter notebook \&}

\sphinxAtStartPar
And choose a notebook to launch.

\sphinxAtStartPar
If you aim at learning \sphinxstylestrong{SCRIMP}, the preferred order to study the notebooks is:
\begin{itemize}
\item {} 
\sphinxAtStartPar
Wave\_1D

\item {} 
\sphinxAtStartPar
Wave\_2D

\item {} 
\sphinxAtStartPar
Heat\_2D

\item {} 
\sphinxAtStartPar
Wave\_2D\_CoEnergy

\item {} 
\sphinxAtStartPar
Heat\_Wave\_2D

\item {} 
\sphinxAtStartPar
Shallow\_water\_2D

\end{itemize}

\sphinxstepscope


\section{Graphical User Interface}
\label{\detokenize{GUI:graphical-user-interface}}\label{\detokenize{GUI::doc}}\phantomsection\label{\detokenize{GUI:gui}}
\sphinxAtStartPar
As to increase the facility to perform simulations from scratch, a Graphical User Interface (GUI) is available to help beginners and confirmed users to scrimp and save time by sketching a first launchable script.

\sphinxAtStartPar
\#TO COMPLETE\#

\sphinxstepscope


\section{Bibliography}
\label{\detokenize{biblio:bibliography}}\label{\detokenize{biblio::doc}}\phantomsection\label{\detokenize{biblio:biblio}}
\sphinxAtStartPar
Port\sphinxhyphen{}Hamiltonian systems is an ever\sphinxhyphen{}growing research area as it proposes a powerful framework for the control of multi\sphinxhyphen{}physics systems.

\sphinxAtStartPar
The following list of publications presents the main results of ours behind \sphinxstylestrong{SCRIMP}.


\subsection{Articles}
\label{\detokenize{biblio:articles}}\begin{itemize}
\item {} 
\sphinxAtStartPar
Haine, Ghislain and Matignon, Denis and Serhani, Anass. \sphinxstylestrong{Numerical Analysis of a Structure\sphinxhyphen{}Preserving Space\sphinxhyphen{}Discretization for an Anisotropic and Heterogeneous Boundary Controlled N\sphinxhyphen{}Dimensional Wave Equation As a Port\sphinxhyphen{}Hamiltonian System.} (2023) \sphinxstyleemphasis{International Journal of Numerical Analysis and Modeling}, 20 (1). 92\sphinxhyphen{}133. \sphinxhref{https://doi.org/10.4208/ijnam2023-1005}{DOI:10.4208/ijnam2023\sphinxhyphen{}1005}

\item {} 
\sphinxAtStartPar
Haine, Ghislain and Matignon, Denis and Monteghetti, Florian. \sphinxstylestrong{Long\sphinxhyphen{}time behavior of a coupled heat\sphinxhyphen{}wave system using a structure\sphinxhyphen{}preserving finite element method.} (2022) \sphinxstyleemphasis{Mathematical Reports}, 22 (1\sphinxhyphen{}2). 187\sphinxhyphen{}215. \sphinxhref{http://imar.ro/journals/Mathematical\_Reports/Pdfs/2022/1-2/11.pdf}{PDF}

\item {} 
\sphinxAtStartPar
Mora, Luis A. and Le Gorrec, Yann and Matignon, Denis and Ramirez, Hector and Yuz, Juan I.. \sphinxstylestrong{On port\sphinxhyphen{}Hamiltonian formulations of 3\sphinxhyphen{}dimensional compressible Newtonian fluids.} (2021) \sphinxstyleemphasis{Physics of Fluids}, 33 (11). 117117. \sphinxhref{https://doi.org/10.1063/5.0067784}{DOI:10.1063/5.0067784}

\item {} 
\sphinxAtStartPar
Cardoso\sphinxhyphen{}Ribeiro, Flávio Luiz and Matignon, Denis and Lefèvre, Laurent. \sphinxstylestrong{A Partitioned Finite Element Method for power\sphinxhyphen{}preserving discretization of open systems of conservation laws.} (2021) \sphinxstyleemphasis{IMA Journal of Mathematical Control and Information}, 38 (2). 493\sphinxhyphen{}533. \sphinxhref{https://doi.org/10.1093/imamci/dnaa038}{DOI:10.1093/imamci/dnaa038}

\item {} 
\sphinxAtStartPar
Brugnoli, Andrea and Haine, Ghislain and Serhani, Anass and Vasseur, Xavier. \sphinxstylestrong{Numerical Approximation of Port\sphinxhyphen{}Hamiltonian Systems for Hyperbolic or Parabolic PDEs with Boundary Control.} (2021) \sphinxstyleemphasis{Journal of Applied Mathematics and Physics}, 09 (06). 1278\sphinxhyphen{}1321. \sphinxhref{https://doi.org/10.4236/jamp.2021.96088}{DOI:10.4236/jamp.2021.96088}

\item {} 
\sphinxAtStartPar
Brugnoli, Andrea and Alazard, Daniel and Pommier\sphinxhyphen{}Budinger, Valérie and Matignon, Denis. \sphinxstylestrong{Port\sphinxhyphen{}Hamiltonian flexible multibody dynamics.} (2021) \sphinxstyleemphasis{Multibody System Dynamics}, 51 (3). 343\sphinxhyphen{}375. \sphinxhref{https://doi.org/10.1007/s11044-020-09758-6}{DOI:10.1007/s11044\sphinxhyphen{}020\sphinxhyphen{}09758\sphinxhyphen{}6}

\item {} 
\sphinxAtStartPar
Brugnoli, Andrea and Alazard, Daniel and Pommier\sphinxhyphen{}Budinger, Valérie and Matignon, Denis. \sphinxstylestrong{A port\sphinxhyphen{}Hamiltonian formulation of linear thermoelasticity and its mixed finite element discretization.} (2021) \sphinxstyleemphasis{Journal of Thermal Stresses}, 44 (6). 643\sphinxhyphen{}661. \sphinxhref{https://doi.org/10.1080/01495739.2021.1917322}{DOI:10.1080/01495739.2021.1917322}

\item {} 
\sphinxAtStartPar
Cardoso\sphinxhyphen{}Ribeiro, Flávio Luiz and Matignon, Denis and Pommier\sphinxhyphen{}Budinger, Valérie. \sphinxstylestrong{Port\sphinxhyphen{}Hamiltonian model of two\sphinxhyphen{}dimensional shallow water equations in moving containers.} (2020) \sphinxstyleemphasis{IMA Journal of Mathematical Control and Information}, 37 (4). 1348\sphinxhyphen{}1366. \sphinxhref{https://doi.org/10.1093/imamci/dnaa016}{DOI:10.1093/imamci/dnaa016}

\item {} 
\sphinxAtStartPar
Brugnoli, Andrea and Alazard, Daniel and Pommier\sphinxhyphen{}Budinger, Valérie and Matignon, Denis. \sphinxstylestrong{Port\sphinxhyphen{}Hamiltonian formulation and symplectic discretization of plate models Part I: Mindlin model for thick plates.} (2019) \sphinxstyleemphasis{Applied Mathematical Modelling}, 75. 940\sphinxhyphen{}960. \sphinxhref{https://doi.org/10.1016/j.apm.2019.04.035}{DOI:10.1016/j.apm.2019.04.035}

\item {} 
\sphinxAtStartPar
Brugnoli, Andrea and Alazard, Daniel and Pommier\sphinxhyphen{}Budinger, Valérie and Matignon, Denis. \sphinxstylestrong{Port\sphinxhyphen{}Hamiltonian formulation and symplectic discretization of plate models. Part II : Kirchhoff model for thin plates.} (2019) \sphinxstyleemphasis{Applied Mathematical Modelling}, 75. 961\sphinxhyphen{}981. \sphinxhref{https://doi.org/10.1016/j.apm.2019.04.036}{DOI:10.1016/j.apm.2019.04.036}

\item {} 
\sphinxAtStartPar
Aoues, Saïd and Cardoso\sphinxhyphen{}Ribeiro, Flávio Luiz and Matignon, Denis and Alazard, Daniel. \sphinxstylestrong{Modeling and Control of a Rotating Flexible Spacecraft: A Port\sphinxhyphen{}Hamiltonian Approach.} (2019) \sphinxstyleemphasis{IEEE Transactions on Control Systems Technology}, 27 (1). 355\sphinxhyphen{}362. \sphinxhref{http://dx.doi.org/10.1109/TCST.2017.2771244}{DOI:10.1109/TCST.2017.2771244}

\item {} 
\sphinxAtStartPar
Cardoso\sphinxhyphen{}Ribeiro, Flávio Luiz and Matignon, Denis and Pommier\sphinxhyphen{}Budinger, Valérie. \sphinxstylestrong{A port\sphinxhyphen{}Hamiltonian model of liquid sloshing in moving containers and application to a fluid\sphinxhyphen{}structure system.} (2017) \sphinxstyleemphasis{Journal of Fluids and Structures}, 69. 402\sphinxhyphen{}427. \sphinxhref{http://dx.doi.org/10.1016/j.jfluidstructs.2016.12.007}{DOI:10.1016/j.jfluidstructs.2016.12.007}

\end{itemize}


\subsection{Book Chapters}
\label{\detokenize{biblio:book-chapters}}\begin{itemize}
\item {} 
\sphinxAtStartPar
Haine, Ghislain and Matignon, Denis. \sphinxstylestrong{Structure\sphinxhyphen{}Preserving Discretization of a Coupled Heat\sphinxhyphen{}Wave System, as Interconnected Port\sphinxhyphen{}Hamiltonian Systems.} (2021) In: \sphinxstyleemphasis{Geometric Science of Information.} Springer International Publishing AG, 191\sphinxhyphen{}199. \sphinxhref{https://doi.org/10.1007/978-3-030-80209-7\_22}{DOI:10.1007/978\sphinxhyphen{}3\sphinxhyphen{}030\sphinxhyphen{}80209\sphinxhyphen{}7\_22}

\item {} 
\sphinxAtStartPar
Serhani, Anass and Matignon, Denis and Haine, Ghislain. \sphinxstylestrong{A Partitioned Finite Element Method for the Structure\sphinxhyphen{}Preserving Discretization of Damped Infinite\sphinxhyphen{}Dimensional Port\sphinxhyphen{}Hamiltonian Systems with Boundary Control.} (2019) In: \sphinxstyleemphasis{Geometric Science of Information.} Springer International Publishing AG, Cham, Suisse, 549\sphinxhyphen{}558. \sphinxhref{https://doi.org/10.1007/978-3-030-26980-7\_57}{DOI:10.1007/978\sphinxhyphen{}3\sphinxhyphen{}030\sphinxhyphen{}26980\sphinxhyphen{}7\_57}

\end{itemize}


\subsection{Proceedings}
\label{\detokenize{biblio:proceedings}}\begin{itemize}
\item {} 
\sphinxAtStartPar
Brugnoli, Andrea and Haine, Ghislain and Matignon, Denis. \sphinxstylestrong{Explicit structure\sphinxhyphen{}preserving discretization of port\sphinxhyphen{}Hamiltonian systems with mixed boundary control.} (2022) In: 25th International Symposium on Mathematical Theory of Networks and Systems (MTNS 2022), 12 September 2022 \sphinxhyphen{} 16 September 2022 (Bayreuth, Germany).

\item {} 
\sphinxAtStartPar
Haine, Ghislain and Matignon, Denis and Monteghetti, Florian. \sphinxstylestrong{Structure\sphinxhyphen{}preserving discretization of Maxwell’s equations as a port\sphinxhyphen{}Hamiltonian system.} (2022) In: 25th International Symposium on Mathematical Theory of Networks and Systems (MTNS 2022), 12 September 2022 \sphinxhyphen{} 16 September 2022 (Bayreuth, Germany).

\item {} 
\sphinxAtStartPar
Haine, Ghislain and Lefèvre, Laurent and Matignon, Denis. \sphinxstylestrong{PFEM: a mixed structure\sphinxhyphen{}preserving discretization method for port\sphinxhyphen{}Hamiltonian systems.} (2022) In: International Workshop on Operator Theory and its Applications, 6 September 2022 \sphinxhyphen{} 10 September 2022 (Cracovie, Poland).

\item {} 
\sphinxAtStartPar
Brugnoli, Andrea and Matignon, Denis. \sphinxstylestrong{A port\sphinxhyphen{}Hamiltonian formulation for the full von\sphinxhyphen{}Kármán plate model.} (2022) In: 10th European Nonlinear Dynamics Conference (ENOC), 17 July 2022 \sphinxhyphen{} 22 July 2022 (Lyon, France).

\item {} 
\sphinxAtStartPar
Cardoso\sphinxhyphen{}Ribeiro, Flávio Luiz and Matignon, Denis and Lefèvre, Laurent. \sphinxstylestrong{A Partitioned Finite Element Method (PFEM) for power\sphinxhyphen{}preserving discretization of port\sphinxhyphen{}Hamiltonian systems (pHs) with polynomial nonlinearity.} (2022) In: European Nonlinear Dynamics Conference (ENOC 2022), 17 July 2022 \sphinxhyphen{} 22 July 2022 (Lyon, France).

\item {} 
\sphinxAtStartPar
Hélie, Thomas and Matignon, Denis. \sphinxstylestrong{Nonlinear damping laws preserving the eigenstructure of the momentum space for conservative linear PDE problems: a port\sphinxhyphen{}Hamiltonian modelling.} (2022) In: 10th European Nonlinear Dynamics Conference (ENOC), 17 July 2022 \sphinxhyphen{} 22 July 2022 (Lyon, France).

\item {} 
\sphinxAtStartPar
Bendimerad\sphinxhyphen{}Hohl, Antoine and Haine, Ghislain and Matignon, Denis and Maschke, Bernhard. \sphinxstylestrong{Structure\sphinxhyphen{}preserving discretization of a coupled Allen\sphinxhyphen{}Cahn and heat equation system.} (2022) In: 4th IFAC Workshop on Thermodynamic Foundations of Mathematical Systems Theory \sphinxhyphen{} TFMST 2022, 25 July 2022 \sphinxhyphen{} 27 July 2022 (Montreal, Canada).

\item {} 
\sphinxAtStartPar
Cardoso\sphinxhyphen{}Ribeiro, Flávio Luiz and Matignon, Denis and Lefèvre, Laurent. \sphinxstylestrong{Dissipative Shallow Water Equations: a port\sphinxhyphen{}Hamiltonian formulation.} (2021) In: Lagrangian and Hamiltonian Methodes for Nonlinear Control (7th LHMNC 2021), 11 October 2021 \sphinxhyphen{} 13 October 2021 (Berlin, Germany).

\item {} 
\sphinxAtStartPar
Haine, Ghislain and Matignon, Denis. \sphinxstylestrong{Incompressible Navier\sphinxhyphen{}Stokes Equation as port\sphinxhyphen{}Hamiltonian systems: velocity formulation versus vorticity formulation.} (2021) In: Lagrangian and Hamiltonian Methodes for Nonlinear Control (7th LHMNC 2021), 11 October 2021 \sphinxhyphen{} 13 October 2021 (Berlin, Germany).

\item {} 
\sphinxAtStartPar
Brugnoli, Andrea and Rashad, Ramy and Califano, Federico and Stramigioli, Stefano and Matignon, Denis. \sphinxstylestrong{Mixed finite elements for port\sphinxhyphen{}Hamiltonian models of von Kármán beams.} (2021) In: Lagrangian and Hamiltonian Methodes for Nonlinear Control (LHMNLC 2021), 11 October 2021 \sphinxhyphen{} 13 October 2021 (Berlin, Germany).

\item {} 
\sphinxAtStartPar
Brugnoli, Andrea and Alazard, Daniel and Pommier\sphinxhyphen{}Budinger, Valérie and Matignon, Denis. \sphinxstylestrong{Structure\sphinxhyphen{}preserving discretization of port\sphinxhyphen{}Hamiltonian plate models.} (2021) In: Mathematical Theory of Networks and Systems, August 2021 \sphinxhyphen{} August 2021 (Cambridge, United Kingdom).

\item {} 
\sphinxAtStartPar
Brugnoli, Andrea and Matignon, Denis and Haine, Ghislain and Serhani, Anass. \sphinxstylestrong{Numerics for Physics\sphinxhyphen{}Based PDEs with Boundary Control: the Partitioned Finite Element Method for Port\sphinxhyphen{}Hamiltonian Systems.} (2021) In: SIAM Conference on Computational Science and Engineering (CSE21), 1 March 2021 \sphinxhyphen{} 5 March 2021 (Virtual conference).

\item {} 
\sphinxAtStartPar
Brugnoli, Andrea and Cardoso\sphinxhyphen{}Ribeiro, Flávio Luiz and Haine, Ghislain and Kotyczka, Paul. \sphinxstylestrong{Partitioned finite element method for structured discretization with mixed boundary conditions.} (2020) In: 21th IFAC World Congress, 11 July 2020 \sphinxhyphen{} 17 July 2020 (Berlin, Germany).

\item {} 
\sphinxAtStartPar
Mora, Luis A. and Gorrec, Yann Le and Matignon, Denis and Ramirez, Hector and Yuz, Juan I.. \sphinxstylestrong{About Dissipative and Pseudo Port\sphinxhyphen{}Hamiltonian Formulations of Irreversible Newtonian Compressible Flows.} (2020) In: The 21st World Congress of The International Federation of Automatic Control (IFAC 2020), 11 July 2020 \sphinxhyphen{} 17 July 2020 (Vitual event, Germany).

\item {} 
\sphinxAtStartPar
Payen, Gabriel and Matignon, Denis and Haine, Ghislain. \sphinxstylestrong{Modelling and structure\sphinxhyphen{}preserving discretization of Maxwell’s equations as port\sphinxhyphen{}Hamiltonian system.} (2020) In: The 21st World Congress of The International Federation of Automatic Control (IFAC 2020), 11 July 2020 \sphinxhyphen{} 17 July 2020 (Virtual event, Germany).

\item {} 
\sphinxAtStartPar
Treton, Anne\sphinxhyphen{}Sophie and Haine, Ghislain and Matignon, Denis. \sphinxstylestrong{Modelling the 1D piston problem as interconnected port\sphinxhyphen{}Hamiltonian systems.} (2020) In: The 21st World Congress of The International Federation of Automatic Control (IFAC 2020), 11 July 2020 \sphinxhyphen{} 17 July 2020 (Virtual event, Germany).

\item {} 
\sphinxAtStartPar
Brugnoli, Andrea and Alazard, Daniel and Pommier\sphinxhyphen{}Budinger, Valérie and Matignon, Denis. \sphinxstylestrong{Interconnection of the Kirchhoff plate within the port\sphinxhyphen{}Hamiltonian framework.} (2020) In: 2019 IEEE 58th Conference on Decision and Control (CDC), 11 December 2019 \sphinxhyphen{} 13 December 2019 (Nice, France).

\item {} 
\sphinxAtStartPar
Cardoso\sphinxhyphen{}Ribeiro, Flávio Luiz and Brugnoli, Andrea and Matignon, Denis and Lefèvre, Laurent. \sphinxstylestrong{Port\sphinxhyphen{}Hamiltonian modeling, discretization and feedback control of a circular water tank.} (2020) In: 2019 IEEE 58th Conference on Decision and Control (CDC), 11 December 2019 \sphinxhyphen{} 13 December 2019 (Nice, France).

\item {} 
\sphinxAtStartPar
Serhani, Anass and Haine, Ghislain and Matignon, Denis. \sphinxstylestrong{Anisotropic heterogeneous n\sphinxhyphen{}D heat equation with boundary control and observation : I. Modeling as port\sphinxhyphen{}Hamiltonian system.} (2019) In: 3rd IFAC Workshop on Thermodynamic Foundations for a Mathematical Systems Theory (TFMST 2019), 3 July 2019 \sphinxhyphen{} 5 July 2019 (Louvain\sphinxhyphen{}la\sphinxhyphen{}Neuve, Belgium).

\item {} 
\sphinxAtStartPar
Serhani, Anass and Haine, Ghislain and Matignon, Denis. \sphinxstylestrong{Anisotropic heterogeneous n\sphinxhyphen{}D heat equation with boundary control and observation : II. Structure\sphinxhyphen{}preserving discretization.} (2019) In: 3rd IFAC Workshop on Thermodynamic Foundations for a Mathematical Systems Theory (TFMST 2019), 3 July 2019 \sphinxhyphen{} 5 July 2019 (Louvain\sphinxhyphen{}la\sphinxhyphen{}Neuve, Belgium).

\item {} 
\sphinxAtStartPar
Brugnoli, Andrea and Alazard, Daniel and Pommier\sphinxhyphen{}Budinger, Valérie and Matignon, Denis. \sphinxstylestrong{Partitioned finite element method for the Mindlin plate as a port\sphinxhyphen{}Hamiltonian system.} (2019) In: 3nd IFAC Workshop on Control of Systems Governed by Partial Differential Equations CPDE 2019, 20 May 2019 \sphinxhyphen{} 24 May 2019 (Oaxaca, Mexico). (Unpublished)

\item {} 
\sphinxAtStartPar
Serhani, Anass and Matignon, Denis and Haine, Ghislain. \sphinxstylestrong{Partitioned Finite Element Method for port\sphinxhyphen{}Hamiltonian systems with Boundary Damping: Anisotropic Heterogeneous 2D wave equations.} (2019) In: 3rd IFAC/IEEE CSS Workshop on Control of Systems Governed by Partial Differential Equations CPDE and XI Workshop Control of Distributed Parameter Systems (CDPS 2019), 20 May 2019 \sphinxhyphen{} 24 May 2019 (Oaxaca, Mexico).

\item {} 
\sphinxAtStartPar
Cardoso\sphinxhyphen{}Ribeiro, Flávio Luiz and Matignon, Denis and Lefèvre, Laurent. \sphinxstylestrong{A structure\sphinxhyphen{}preserving Partitioned Finite Element Method for the 2D wave equation.} (2018) In: 6th IFAC Workshop on Lagrangian and Hamiltonian Methods for Nonlinear Control, 1 May 2018 \sphinxhyphen{} 4 May 2018 (Valparaíso, Chile).

\item {} 
\sphinxAtStartPar
Alazard, Daniel and Aoues, Saïd and Cardoso\sphinxhyphen{}Ribeiro, Flávio Luiz and Matignon, Denis. \sphinxstylestrong{Disturbance rejection for a rotating flexible spacecraft: a port\sphinxhyphen{}Hamiltonian approach.} (2018) In: 6th IFAC Workshop on Lagrangian and Hamiltonian Methods for Nonlinear Control, 1 May 2018 \sphinxhyphen{} 4 May 2018 (Valparaíso, Chile).

\item {} 
\sphinxAtStartPar
Serhani, Anass and Matignon, Denis and Haine, Ghislain. \sphinxstylestrong{Structure\sphinxhyphen{}Preserving Finite Volume Method for 2D Linear and Non\sphinxhyphen{}Linear Port\sphinxhyphen{}Hamiltonian Systems.} (2018) In: 6th IFAC Workshop on Lagrangian and Hamiltonian Methods for Nonlinear Control, 1 May 2018 \sphinxhyphen{} 4 May 2018 (Valparaíso, Chile).

\end{itemize}

\sphinxstepscope


\section{Code documentation}
\label{\detokenize{scrimp:code-documentation}}\label{\detokenize{scrimp::doc}}
\sphinxAtStartPar
This part of the documentation is generated automatically from the python source using \sphinxhref{https://www.sphinx-doc.org/en/master/}{SPHINX}.


\subsection{Folders}
\label{\detokenize{scrimp:folders}}
\sphinxstepscope


\subsubsection{scrimp.examples}
\label{\detokenize{scrimp.examples:scrimp-examples}}\label{\detokenize{scrimp.examples::doc}}
\sphinxAtStartPar
We provide some examples coming from our \sphinxhref{biblio}{publications}.

\sphinxAtStartPar
The equations are explained \sphinxhref{examples}{here}.


\paragraph{Wave}
\label{\detokenize{scrimp.examples:wave}}

\paragraph{Heat}
\label{\detokenize{scrimp.examples:heat}}

\paragraph{Heat\sphinxhyphen{}Wave coupling}
\label{\detokenize{scrimp.examples:heat-wave-coupling}}

\paragraph{Shallow water}
\label{\detokenize{scrimp.examples:shallow-water}}
\sphinxstepscope


\subsubsection{scrimp.utils}
\label{\detokenize{scrimp.utils:scrimp-utils}}\label{\detokenize{scrimp.utils::doc}}
\sphinxAtStartPar
This folder contains useful functions that are beyond the port\sphinxhyphen{}Hamiltonian framework used in \sphinxstylestrong{SCRIMP}.


\paragraph{Config}
\label{\detokenize{scrimp.utils:module-scrimp.utils.config}}\label{\detokenize{scrimp.utils:config}}\index{module@\spxentry{module}!scrimp.utils.config@\spxentry{scrimp.utils.config}}\index{scrimp.utils.config@\spxentry{scrimp.utils.config}!module@\spxentry{module}}\begin{itemize}
\item {} 
\sphinxAtStartPar
file:             utils/config.py

\item {} 
\sphinxAtStartPar
authors:          Ghislain Haine

\item {} 
\sphinxAtStartPar
date:             23 jun. 2023

\item {} 
\sphinxAtStartPar
brief:            functions to configure SCRIMP

\end{itemize}
\index{set\_paths() (in module scrimp.utils.config)@\spxentry{set\_paths()}\spxextra{in module scrimp.utils.config}}

\begin{fulllineitems}
\phantomsection\label{\detokenize{scrimp.utils:scrimp.utils.config.set_paths}}
\pysigstartsignatures
\pysiglinewithargsret
{\sphinxcode{\sphinxupquote{scrimp.utils.config.}}\sphinxbfcode{\sphinxupquote{set\_paths}}}
{\sphinxparam{\DUrole{n}{path}\DUrole{o}{=}\DUrole{default_value}{None}}}
{}
\pysigstopsignatures
\sphinxAtStartPar
Set the default path of scrimp
\begin{description}
\sphinxlineitem{Args:}
\sphinxAtStartPar
path (str): the path

\end{description}

\end{fulllineitems}

\index{set\_verbose() (in module scrimp.utils.config)@\spxentry{set\_verbose()}\spxextra{in module scrimp.utils.config}}

\begin{fulllineitems}
\phantomsection\label{\detokenize{scrimp.utils:scrimp.utils.config.set_verbose}}
\pysigstartsignatures
\pysiglinewithargsret
{\sphinxcode{\sphinxupquote{scrimp.utils.config.}}\sphinxbfcode{\sphinxupquote{set\_verbose}}}
{\sphinxparam{\DUrole{n}{verbose}\DUrole{o}{=}\DUrole{default_value}{1}}}
{}
\pysigstopsignatures
\sphinxAtStartPar
Set the verbosity level of scrimp (0: quiet, 1: info, 2: debug)

\sphinxAtStartPar
In \sphinxtitleref{quiet} mode, debug are saved in a log file.
\begin{description}
\sphinxlineitem{Args:}
\sphinxAtStartPar
verbose (int): the level of verbosity, defaults to 1

\end{description}

\end{fulllineitems}

\index{set\_verbose\_gf() (in module scrimp.utils.config)@\spxentry{set\_verbose\_gf()}\spxextra{in module scrimp.utils.config}}

\begin{fulllineitems}
\phantomsection\label{\detokenize{scrimp.utils:scrimp.utils.config.set_verbose_gf}}
\pysigstartsignatures
\pysiglinewithargsret
{\sphinxcode{\sphinxupquote{scrimp.utils.config.}}\sphinxbfcode{\sphinxupquote{set\_verbose\_gf}}}
{\sphinxparam{\DUrole{n}{verbose}}}
{}
\pysigstopsignatures
\sphinxAtStartPar
Set the verbosity level of getfem
\begin{description}
\sphinxlineitem{Args:}
\sphinxAtStartPar
verbose (int): the level of verbosity

\end{description}

\end{fulllineitems}



\paragraph{Linear algebra}
\label{\detokenize{scrimp.utils:linear-algebra}}

\paragraph{Mesh}
\label{\detokenize{scrimp.utils:mesh}}
\sphinxstepscope


\subsubsection{scrimp.sandbox}
\label{\detokenize{scrimp.sandbox:scrimp-sandbox}}\label{\detokenize{scrimp.sandbox::doc}}
\sphinxAtStartPar
The \sphinxcode{\sphinxupquote{sandbox}} folder is the \sphinxstylestrong{recommanded} folder to work in.

\sphinxAtStartPar
It already contains the example of the 1D wave equation presented \sphinxhref{started}{here}.


\subsection{Distributed port\sphinxhyphen{}Hamiltonian system}
\label{\detokenize{scrimp:distributed-port-hamiltonian-system}}

\subsection{Domain}
\label{\detokenize{scrimp:domain}}

\subsection{Hamiltonian / Term}
\label{\detokenize{scrimp:hamiltonian-term}}

\subsection{Port / Parameter}
\label{\detokenize{scrimp:port-parameter}}

\subsection{State}
\label{\detokenize{scrimp:state}}

\subsection{Co\sphinxhyphen{}state}
\label{\detokenize{scrimp:co-state}}

\subsection{Control}
\label{\detokenize{scrimp:control}}

\subsection{FEM}
\label{\detokenize{scrimp:fem}}

\subsection{Brick}
\label{\detokenize{scrimp:brick}}

\chapter{Credits}
\label{\detokenize{index:credits}}

\section{Development}
\label{\detokenize{index:development}}
\sphinxAtStartPar
Please report bug at: \sphinxhref{mailto:ghislain.haine@isae.fr}{ghislain.haine@isae.fr}, \sphinxhref{mailto:Giuseppe.Ferrarro@isae-supaero.fr}{Giuseppe.Ferrarro@isae\sphinxhyphen{}supaero.fr}

\sphinxAtStartPar
Current developers: Antoine Bendhimerad\sphinxhyphen{}Hohl, Giuseppe Ferraro, Michel Fournié, Ghislain Haine

\sphinxAtStartPar
Past: Andrea Brugnoli, Melvin Chopin, Florian Monteghetti, Anass Serhani, Xavier Vasseur

\sphinxAtStartPar
\sphinxstylestrong{Please read the} \sphinxhref{https://github.com/g-haine/scrimp/blob/master/LICENSE}{LICENSE}


\section{Funding}
\label{\detokenize{index:funding}}\begin{itemize}
\item {} 
\sphinxAtStartPar
ANR Project \sphinxhref{https://impacts.ens2m.fr/}{IMPACTS} \textendash{} IMplicit Port\sphinxhyphen{}hAmiltonian ConTrol Systems

\item {} 
\sphinxAtStartPar
AID School Project \sphinxhref{https://www.defense.gouv.fr/aid}{FAMAS} \textendash{} Fast \& Accurate MAxwell Solver

\item {} 
\sphinxAtStartPar
ANR\sphinxhyphen{}DFG Project \sphinxhref{http://websites.isae.fr/infidhem}{INFIDHEM} \textendash{} INterconnected inFinite\sphinxhyphen{}Dimensional systems for HEterogeneous Media

\end{itemize}


\section{Third\sphinxhyphen{}party}
\label{\detokenize{index:third-party}}
\sphinxAtStartPar
The two \sphinxstylestrong{main} libraries used as core for SCRIMP are:
\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxhref{https://getfem.org/}{GetFEM} \textendash{} An open\sphinxhyphen{}source finite element library

\item {} 
\sphinxAtStartPar
\sphinxhref{https://petsc.org/release/}{PETSc} \textendash{} The Portable, Extensible Toolkit for Scientific Computation

\end{itemize}

\sphinxAtStartPar
Meshing is facilitated using (although not mandatory) \sphinxhref{https://gmsh.info/}{GMSH} \textendash{} A three\sphinxhyphen{}dimensional finite element mesh generator

\sphinxAtStartPar
Post\sphinxhyphen{}processing visualization is encouraged via \sphinxhref{https://www.paraview.org/}{ParaView} \textendash{} Post\sphinxhyphen{}processing visualization engine

\sphinxAtStartPar
and finally, SCRIMP also needs for some routines
\begin{itemize}
\item {} 
\sphinxAtStartPar
\sphinxhref{https://matplotlib.org/}{matplotlib} \textendash{} Visualization with Python

\item {} 
\sphinxAtStartPar
\sphinxhref{https://numpy.org/}{numpy} \textendash{} A well\sphinxhyphen{}known package for scientific computing

\end{itemize}

\sphinxAtStartPar
One of our choice for IDE is \sphinxhref{https://www.spyder-ide.org/}{Spyder} \textendash{} A scientific Python development environment


\section{How to cite SCRIMP?}
\label{\detokenize{index:how-to-cite-scrimp}}
\sphinxAtStartPar
Ferraro G, Fournié M, Haine G.
\sphinxstyleemphasis{Simulation and control of interactions in multi\sphinxhyphen{}physics, a Python package for port\sphinxhyphen{}Hamiltonian systems.}
\sphinxstylestrong{IFAC\sphinxhyphen{}PapersOnLine}, 2024;58(6):119\textendash{}24.

\begin{sphinxVerbatim}[commandchars=\\\{\}]
@article\PYG{n+nb}{\PYGZob{}}Ferraro\PYG{n+nb}{\PYGZus{}}2024,
  title=\PYG{n+nb}{\PYGZob{}}\PYG{n+nb}{\PYGZob{}}Simulation and control of interactions in multi\PYGZhy{}physics, a Python package for port\PYGZhy{}Hamiltonian systems\PYG{n+nb}{\PYGZcb{}}\PYG{n+nb}{\PYGZcb{}},
  volume=\PYG{n+nb}{\PYGZob{}}58\PYG{n+nb}{\PYGZcb{}},
  ISSN=\PYG{n+nb}{\PYGZob{}}2405\PYGZhy{}8963\PYG{n+nb}{\PYGZcb{}},
  DOI=\PYG{n+nb}{\PYGZob{}}10.1016/j.ifacol.2024.08.267\PYG{n+nb}{\PYGZcb{}},
  number=\PYG{n+nb}{\PYGZob{}}6\PYG{n+nb}{\PYGZcb{}},
  journal=\PYG{n+nb}{\PYGZob{}}IFAC\PYGZhy{}PapersOnLine\PYG{n+nb}{\PYGZcb{}},
  publisher=\PYG{n+nb}{\PYGZob{}}Elsevier BV\PYG{n+nb}{\PYGZcb{}},
  author=\PYG{n+nb}{\PYGZob{}}Ferraro, Giuseppe and Fournié, Michel and Haine, Ghislain\PYG{n+nb}{\PYGZcb{}},
  year=\PYG{n+nb}{\PYGZob{}}2024\PYG{n+nb}{\PYGZcb{}},
  pages=\PYG{n+nb}{\PYGZob{}}119\PYGZhy{}\PYGZhy{}124\PYG{n+nb}{\PYGZcb{}}
\PYG{n+nb}{\PYGZcb{}}
\end{sphinxVerbatim}


\renewcommand{\indexname}{Python Module Index}
\begin{sphinxtheindex}
\let\bigletter\sphinxstyleindexlettergroup
\bigletter{s}
\item\relax\sphinxstyleindexentry{scrimp.utils.config}\sphinxstyleindexpageref{scrimp.utils:\detokenize{module-scrimp.utils.config}}
\end{sphinxtheindex}

\renewcommand{\indexname}{Index}
\printindex
\end{document}